import{_ as n,o as a,c as s,e}from"./app-8007fa1b.js";const t="/assets/img022-82ee6b3e.png",i="/assets/img023-853249d5.png",p="/assets/img024-5e32c0b6.png",c="/assets/img025-81c9acec.png",l="/assets/img026-73853341.png",o="/assets/img027-e74fecbd.png",d="/assets/img028-cfb54380.png",u="/assets/img029-b7745f74.png",r="/assets/img030-babaf762.png",v="/assets/img031-9dd4bcfb.png",k="/assets/img032-f6e368ee.png",m="/assets/img033-a5460904.png",b="/assets/img034-6b5fd23a.png",h="/assets/img035-86340d7b.png",g="/assets/img036-f791cf1d.png",f="data:image/png;base64,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",y="/assets/img037-3961890f.png",w="/assets/img038-095e5d93.png",T="/assets/img040-fdf8dbed.png",x="/assets/img041-922f8e59.png",_={},A=e('<h1 id="一、引入" tabindex="-1"><a class="header-anchor" href="#一、引入" aria-hidden="true">#</a> 一、引入</h1><p>Lock 系列 API 底层原理和 synchronized 完全不同，是两个独立的体系<br></p><p><img src="'+t+`" alt="img.png"></p><br><p>Lock 系列 API 底层实现加锁、解锁操作，都需要直接或间接的用到同步器对象，同步器对象的类都继承自AQS，AQS的全类名是：<br> java.util.concurrent.locks.AbstractQueuedSynchronizer<br></p><br><h1 id="二、abstractqueuedsynchronizer组成部分" tabindex="-1"><a class="header-anchor" href="#二、abstractqueuedsynchronizer组成部分" aria-hidden="true">#</a> 二、AbstractQueuedSynchronizer组成部分</h1><h2 id="_1、内部类-node" tabindex="-1"><a class="header-anchor" href="#_1、内部类-node" aria-hidden="true">#</a> 1、内部类：Node</h2><p>Node这个单词是节点的意思，在AQS中通过Node节点要组成一个双向链表，存放没有获取到锁的线程</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Node</span> prev<span class="token punctuation">;</span>       <span class="token comment">// 在双向链表中指向上一个节点</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next<span class="token punctuation">;</span>       <span class="token comment">// 在双向链表中指向下一个节点</span>
        <span class="token class-name">Thread</span> waiter<span class="token punctuation">;</span>            <span class="token comment">// 指向当前节点所保存的线程对象，这个线程对象没有申请到锁</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="_2、成员变量-state" tabindex="-1"><a class="header-anchor" href="#_2、成员变量-state" aria-hidden="true">#</a> 2、成员变量：state</h2><ul><li>初始值：0</li><li>作用表示当前锁对象是否被某个线程占用 <ul><li>占用：给 state 增加值</li><li>释放：给 state 减少值</li></ul></li><li>修饰：用到了 volatile 关键词</li></ul><br><h2 id="_3、对-state-使用-cas-方式修改" tabindex="-1"><a class="header-anchor" href="#_3、对-state-使用-cas-方式修改" aria-hidden="true">#</a> 3、对 state 使用 CAS 方式修改</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * Atomically sets synchronization state to the given updated
     * value if the current state value equals the expected value.
     * This operation has memory semantics of a <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">volatile</span></span></span><span class="token punctuation">}</span> read
     * and write.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">expect</span> the expected value
     * <span class="token keyword">@param</span> <span class="token parameter">update</span> the new value
     * <span class="token keyword">@return</span> <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">true</span></span></span><span class="token punctuation">}</span> if successful. False return indicates that the actual
     *         value was not equal to the expected value.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="_4、总的体系说明" tabindex="-1"><a class="header-anchor" href="#_4、总的体系说明" aria-hidden="true">#</a> 4、总的体系说明</h2><p><img src="`+i+'" alt="img.png"></p><br><h1 id="三、jmm" tabindex="-1"><a class="header-anchor" href="#三、jmm" aria-hidden="true">#</a> 三、JMM</h1><h2 id="_1、概念" tabindex="-1"><a class="header-anchor" href="#_1、概念" aria-hidden="true">#</a> 1、概念</h2><p>Java Memory Model：Java 内存模型<br> JMM和JVM在内存结构上存在对应关系，把JMM本身搞清楚，自然就知道它和JVM的关系了<br></p><h2 id="_2、产生的背景" tabindex="-1"><a class="header-anchor" href="#_2、产生的背景" aria-hidden="true">#</a> 2、产生的背景</h2><p><img src="'+p+'" alt="img.png"></p><br><p>CPU遵循摩尔定律运算增长非常快，但是内存速度的增长就没有那么快，所以逐渐发现内存和CPU的速度不匹配了<br></p><p>为了最大限度发挥CPU的性能优势，协调CPU和内存之间速度上的差异，硬件体系在CPU和内存之间引入了高速缓存<br></p><ul><li>距离CPU越近：速度越快，材料越贵，容量越小</li><li>距离CPU越远：速度越慢，材料越贱，容量越大</li></ul><br><p>但是从上图我们很容易能发现问题：多个不同 CPU 核心都从主内存读取了同一个数据，又做了不同修改。那么同步会主内存的时候以哪个修改为准呢？这个问题有一个专门的名字：缓存一致性（Cache Coherence）。为了解决一致性的问题，需要各个处理器访问缓存时都要遵循一些协议，在读写时要根据协议来进行操作，这类协议有MSI、MESI（Illinois Protocol）、MOSI、Synapse、Firefly及Dragon Protocol等。</p><br><p><img src="'+c+'" alt="img.png"></p><br><h2 id="_3、java-内存模型" tabindex="-1"><a class="header-anchor" href="#_3、java-内存模型" aria-hidden="true">#</a> 3、Java 内存模型</h2><h3 id="_1基本概念" tabindex="-1"><a class="header-anchor" href="#_1基本概念" aria-hidden="true">#</a> ①基本概念</h3><p>对 Java 程序来说同样存在上面的问题。曾经同样的 Java 代码在不同的硬件平台上运行会出现计算结果不一致的情况。这就和不同硬件系统使用不同方式应对缓存不一致问题有关。<br></p><p>为了屏蔽系统和硬件的差异，让一套代码在不同平台下能到达相同的访问结果。JMM 从 Java 5 开始的 JSR-133 发布后，已经成熟和完善起来。<br></p><p><img src="'+l+`" alt="img.png"></p><br><p>要点如下：</p><ul><li>线程执行计算操作，其实是针对本地内存（也叫工作内存）里的数据来操作的。</li><li>本地内存中的数据是从主内存中读取进来的。</li><li>线程在本地内存修改了数据之后，需要写回主内存。</li><li>各个线程自己的本地内存都是自己私有的，任何线程都不能读写其它线程的本地内存。</li><li>多线程共同修改同一个数据时，本质上都是需要借助主内存来完成。</li></ul><br><h3 id="_2主内存" tabindex="-1"><a class="header-anchor" href="#_2主内存" aria-hidden="true">#</a> ②主内存</h3><p>主内存是各线程共享的内存区域。而JVM的内存结构中堆内存也是线程共享的。</p><br><h3 id="_3本地内存" tabindex="-1"><a class="header-anchor" href="#_3本地内存" aria-hidden="true">#</a> ③本地内存</h3><p>本地内存（也叫工作内存）是各线程私有的内存区域。而JVM的内存结构中栈内存是线程私有的。所以 JVM 内存结构和 JMM 内存模型既有关联有不完全等同。</p><br><h3 id="_4作用" tabindex="-1"><a class="header-anchor" href="#_4作用" aria-hidden="true">#</a> ④作用</h3><p>Java 内存模型（JMM）设计出来就是为了解决缓存一致性问题的，拆解开来说，缓存一致性涉及到三个具体问题：</p><ul><li>原子性</li><li>可见性</li><li>有序性</li></ul><h2 id="_4、原子性" tabindex="-1"><a class="header-anchor" href="#_4、原子性" aria-hidden="true">#</a> 4、原子性</h2><h3 id="_1概念" tabindex="-1"><a class="header-anchor" href="#_1概念" aria-hidden="true">#</a> ①概念</h3><p>“原子”，除了指特定的微观粒子，引申的意思是：不可再分<br></p><p>在我们的程序中，如果一个操作不能再拆分成更多的操作，那么这个操作就可以称之为：原子性操作<br></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 原子性操作</span>
a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">// 非原子性操作</span>
<span class="token comment">// a++ 是由两个操作组成的：a+1 和赋值</span>
a<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h3 id="_2代码举例" tabindex="-1"><a class="header-anchor" href="#_2代码举例" aria-hidden="true">#</a> ②代码举例</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>day03</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo01AtomicTest</span> <span class="token punctuation">{</span>

    <span class="token comment">// 声明成员变量作为操作对象</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 声明专门的方法执行累加操作</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; data = &quot;</span> <span class="token operator">+</span> <span class="token operator">++</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建线程共享对象</span>
        <span class="token class-name">Demo01AtomicTest</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo01AtomicTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建第一个线程执行累加操作</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                demo<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;thread-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建第二个线程执行累加操作</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                demo<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;thread-02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h3 id="_3内存分析" tabindex="-1"><a class="header-anchor" href="#_3内存分析" aria-hidden="true">#</a> ③内存分析</h3><blockquote><p>thread-01 data = 168<br> thread-02 data = 169<br> thread-01 data = 169<br> thread-01 data = 170<br> ……<br> thread-02 data = 177<br> thread-02 data = 178<br> thread-01 data = 179</p></blockquote><p>中间重复的数据非常能说明问题：</p><ul><li>读取数据： <img src="`+o+'" alt="img.png"></li></ul><br><ul><li>执行计算： <img src="'+d+'" alt="img.png"></li></ul><br><ul><li>thread-01 结果写回： <img src="'+u+'" alt="img.png"></li></ul><br><ul><li>thread-02 结果写回： <img src="'+r+`" alt="img.png"></li></ul><br><p>但是其实现在 2 号线程应该做的是从 169 + 1 变成 170。</p><h3 id="_4使用-synchronized-同步" tabindex="-1"><a class="header-anchor" href="#_4使用-synchronized-同步" aria-hidden="true">#</a> ④使用 synchronized 同步</h3><h4 id="_1-修改-java-代码" tabindex="-1"><a class="header-anchor" href="#_1-修改-java-代码" aria-hidden="true">#</a> [1]修改 Java 代码</h4><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>// 将累加方法修改为同步方法
public synchronized void add() {
    System.out.println(Thread.currentThread().getName() + &quot; data = &quot; + ++data);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-效果说明" tabindex="-1"><a class="header-anchor" href="#_2-效果说明" aria-hidden="true">#</a> [2]效果说明</h4><p>使用同步锁之后可以保证最终结果计算准确：</p><blockquote><p>thread-01 data = 198<br> thread-02 data = 199<br> thread-01 data = 200</p></blockquote><br><h3 id="_5逻辑上的原子性操作" tabindex="-1"><a class="header-anchor" href="#_5逻辑上的原子性操作" aria-hidden="true">#</a> ⑤逻辑上的原子性操作</h3><p>很多个操作在逻辑上是一个整体，我们就可以通过加同步锁的方式人为的把多个操作封装为一个整体，保证这个逻辑上是一个整体的代码每次只有一线程来执行<br> 从而避免计算的错误<br></p><p>此时这个逻辑上的整体就具备了原子性<br></p><h3 id="_6原子类" tabindex="-1"><a class="header-anchor" href="#_6原子类" aria-hidden="true">#</a> ⑥原子类</h3><p><img src="`+v+`" alt="img.png"></p><br><p>下面我们修改上一个例子的代码，看看同样的需求用原子类如何实现：<br></p><h4 id="_1-修改-java-代码-1" tabindex="-1"><a class="header-anchor" href="#_1-修改-java-代码-1" aria-hidden="true">#</a> [1]修改 Java 代码</h4><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>// 声明成员变量作为操作对象
private AtomicInteger data = new AtomicInteger(0);

// 累加方法还是非同步方法
public void add() {
    System.out.println(Thread.currentThread().getName() + &quot; data = &quot; + data.incrementAndGet());
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h4 id="_2-效果说明-1" tabindex="-1"><a class="header-anchor" href="#_2-效果说明-1" aria-hidden="true">#</a> [2]效果说明</h4><p>可以保证计算结果正确：</p><blockquote><p>thread-01 data = 194<br> thread-02 data = 193<br> thread-01 data = 195<br> thread-02 data = 196<br> thread-01 data = 197<br> thread-02 data = 198<br> thread-02 data = 200<br> thread-01 data = 199</p></blockquote><br><h4 id="_3-同步锁和原子类的性能比较" tabindex="-1"><a class="header-anchor" href="#_3-同步锁和原子类的性能比较" aria-hidden="true">#</a> [3]同步锁和原子类的性能比较</h4><h3 id="_1情景设定" tabindex="-1"><a class="header-anchor" href="#_1情景设定" aria-hidden="true">#</a> ①情景设定</h3><p>两个线程对同一个数据从 0 累加到 1000 万。数量大一些便于看到较为明显的效果，我们中间不执行线程睡眠就不会花很多时间。</p><h3 id="_2同步锁" tabindex="-1"><a class="header-anchor" href="#_2同步锁" aria-hidden="true">#</a> ②同步锁</h3><h4 id="_1-java-代码" tabindex="-1"><a class="header-anchor" href="#_1-java-代码" aria-hidden="true">#</a> [1] Java 代码</h4><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>public class Demo12PKSync {

    private int data = 0;

    public synchronized void add() {
        data ++;
    }

    public static void main(String[] args) {
        Demo12PKSync demo = new Demo12PKSync();

        new Thread(()-&gt;{

            long beginTime = System.currentTimeMillis();

            for (int i = 0; i &lt; 10000000; i++) {
                demo.add();
            }

            long endTime = System.currentTimeMillis();

            long usedTime = endTime - beginTime;

            System.out.println(Thread.currentThread().getName() + &quot; usedTime = &quot; + usedTime);

        }, &quot;thread-01&quot;).start();

        new Thread(()-&gt;{

            long beginTime = System.currentTimeMillis();

            for (int i = 0; i &lt; 10000000; i++) {
                demo.add();
            }

            long endTime = System.currentTimeMillis();

            long usedTime = endTime - beginTime;

            System.out.println(Thread.currentThread().getName() + &quot; usedTime = &quot; + usedTime);

        }, &quot;thread-02&quot;).start();
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-效果" tabindex="-1"><a class="header-anchor" href="#_2-效果" aria-hidden="true">#</a> [2]效果</h4><blockquote><p>thread-01 usedTime = 628<br> thread-02 usedTime = 700</p></blockquote><h3 id="_3原子类" tabindex="-1"><a class="header-anchor" href="#_3原子类" aria-hidden="true">#</a> ③原子类</h3><h4 id="_1-java-代码-1" tabindex="-1"><a class="header-anchor" href="#_1-java-代码-1" aria-hidden="true">#</a> [1] Java 代码</h4><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>public class Demo12PKAtomic {

    private AtomicInteger data = new AtomicInteger(0);

    public void add() {
        data.incrementAndGet();
    }

    public static void main(String[] args) {
        Demo12PKAtomic demo = new Demo12PKAtomic();

        new Thread(()-&gt;{

            long beginTime = System.currentTimeMillis();

            for (int i = 0; i &lt; 10000000; i++) {
                demo.add();
            }

            long endTime = System.currentTimeMillis();

            long usedTime = endTime - beginTime;

            System.out.println(Thread.currentThread().getName() + &quot; usedTime = &quot; + usedTime);

        }, &quot;thread-01&quot;).start();

        new Thread(()-&gt;{

            long beginTime = System.currentTimeMillis();

            for (int i = 0; i &lt; 10000000; i++) {
                demo.add();
            }

            long endTime = System.currentTimeMillis();

            long usedTime = endTime - beginTime;

            System.out.println(Thread.currentThread().getName() + &quot; usedTime = &quot; + usedTime);

        }, &quot;thread-02&quot;).start();
    }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-效果-1" tabindex="-1"><a class="header-anchor" href="#_2-效果-1" aria-hidden="true">#</a> [2]效果</h4><blockquote><p>thread-02 usedTime = 233 thread-01 usedTime = 239</p></blockquote><p>性能的提升效果还是很明显的。原理我们会在后面结合 AQS 和 CAS 来说明。</p><h2 id="_5、可见性" tabindex="-1"><a class="header-anchor" href="#_5、可见性" aria-hidden="true">#</a> 5、可见性</h2><h3 id="_1概念-1" tabindex="-1"><a class="header-anchor" href="#_1概念-1" aria-hidden="true">#</a> ①概念</h3><p>JMM 模型中，每个线程都有自己私有的本地内存（工作内存），这个空间是不允许其它线程读写的<br></p><p>于是会导致一个问题：当前线程如果不重新从主内存加载数据，就看不到其它内存对数据的修改<br></p><h3 id="_2代码示例" tabindex="-1"><a class="header-anchor" href="#_2代码示例" aria-hidden="true">#</a> ②代码示例</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>day03</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo13CanSee</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> number<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Demo13CanSee</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo13CanSee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>demo<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A 线程看到了 number 的新值：&quot;</span> <span class="token operator">+</span> demo<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;thread-a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                demo<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;B 线程修改了 number 的值：&quot;</span> <span class="token operator">+</span> demo<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;thread-b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3运行效果" tabindex="-1"><a class="header-anchor" href="#_3运行效果" aria-hidden="true">#</a> ③运行效果</h3><p><img src="`+k+'" alt="img.png"></p><p>可以看到，程序一直在运行着没有停止。这是因为 while (demo.getNumber() == 100) 循环条件始终成立。证明 A 线程看到的 data 值始终是旧值。</p><br><h3 id="_4内存分析" tabindex="-1"><a class="header-anchor" href="#_4内存分析" aria-hidden="true">#</a> ④内存分析</h3><h4 id="_1-两个线程加载变量" tabindex="-1"><a class="header-anchor" href="#_1-两个线程加载变量" aria-hidden="true">#</a> [1]两个线程加载变量</h4><p><img src="'+m+'" alt="img.png"></p><br><h4 id="_2-线程-b-修改变量" tabindex="-1"><a class="header-anchor" href="#_2-线程-b-修改变量" aria-hidden="true">#</a> [2]线程 B 修改变量</h4><p>线程 B 首先在自己的本地内存修改数据：<br></p><p><img src="'+b+'" alt="img.png"></p><br><h4 id="_3-线程-b-将新数据写回主内存" tabindex="-1"><a class="header-anchor" href="#_3-线程-b-将新数据写回主内存" aria-hidden="true">#</a> [3]线程 B 将新数据写回主内存</h4><p><img src="'+h+'" alt="img.png"></p><br><h4 id="_4-问题核心" tabindex="-1"><a class="header-anchor" href="#_4-问题核心" aria-hidden="true">#</a> [4]问题核心</h4><p>线程 A 始终都是在从自己的本地内存获取数据，没有重新去读取主内存。</p><h3 id="_5问题解决" tabindex="-1"><a class="header-anchor" href="#_5问题解决" aria-hidden="true">#</a> ⑤问题解决</h3><p>把 number 用 volatile 关键词修改即可</p><br><h2 id="_6、有序性" tabindex="-1"><a class="header-anchor" href="#_6、有序性" aria-hidden="true">#</a> 6、有序性</h2><h3 id="_1指令重排序" tabindex="-1"><a class="header-anchor" href="#_1指令重排序" aria-hidden="true">#</a> ①指令重排序</h3><p>CPU 执行程序指令和 JVM 编译源程序之后，都会对指令做一定的重排序，目的是<strong>提高</strong>部分代码执行的<strong>效率</strong>。原则是重新排序后代码执行的结果和不重排<strong>执行的结果必须预期的一样</strong>。所以我们从开发的层面上完全感受不到。</p><br><h3 id="_2有序性概念" tabindex="-1"><a class="header-anchor" href="#_2有序性概念" aria-hidden="true">#</a> ②有序性概念</h3><p>从宏观和表面层次来看，我们感觉不到指令重排的存在，指令重排都是系统内部做的优化。保证无论是否指令重排，程序运行的结果都和预期一样，就是有序性。</p><br><h1 id="四、volatile" tabindex="-1"><a class="header-anchor" href="#四、volatile" aria-hidden="true">#</a> 四、volatile</h1><p><img src="'+g+'" alt="img.png"></p><h2 id="_1、概述" tabindex="-1"><a class="header-anchor" href="#_1、概述" aria-hidden="true">#</a> 1、概述</h2><h3 id="_1语法" tabindex="-1"><a class="header-anchor" href="#_1语法" aria-hidden="true">#</a> ①语法</h3><p>volatile 关键词<strong>只能修饰成员变量</strong>：</p><p><img src="'+f+`" alt="img.png"></p><br><h3 id="_2总体功能" tabindex="-1"><a class="header-anchor" href="#_2总体功能" aria-hidden="true">#</a> ②总体功能</h3><ul><li>微观层面：volatile 关键字能够提供有序性保证，但是从实际开发中编码层面感受不到。</li><li>宏观层面：volatile 关键字能够提供可见性保证，但是不能提供原子性保证。</li></ul><table><thead><tr><th>JMM特性</th><th>volatile能力</th></tr></thead><tbody><tr><td>原子性</td><td>无</td></tr><tr><td><strong>可见性</strong></td><td><strong>有</strong></td></tr><tr><td>有序性</td><td>有</td></tr></tbody></table><br><h3 id="_3定位" tabindex="-1"><a class="header-anchor" href="#_3定位" aria-hidden="true">#</a> ③定位</h3><p>实际开发时，我们编写业务代码基本上不会用到volatile，因为对volatile的各种使用场景，JDK都已经封装好了<br></p><h2 id="_2、原子性角度分析" tabindex="-1"><a class="header-anchor" href="#_2、原子性角度分析" aria-hidden="true">#</a> 2、原子性角度分析</h2><p>被 volatile 关键字修饰的变量是否满足原子性其实并不是由 volatile 本身来决定，而是和变量自身的数据类型有关。</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>public class Demo17AtomicTest {

    private volatile int data = 0;

    public void add() {
        System.out.println(Thread.currentThread().getName() + &quot; data = &quot; + ++data);
    }

    public static void main(String[] args) {

        Demo17AtomicTest demo = new Demo17AtomicTest();

        new Thread(()-&gt;{

            for (int i = 0; i &lt; 100; i++) {
                try {TimeUnit.MILLISECONDS.sleep(10);} catch (InterruptedException e) {}
                demo.add();
            }

        }, &quot;AAA&quot;).start();

        new Thread(()-&gt;{

            for (int i = 0; i &lt; 100; i++) {
                try {TimeUnit.MILLISECONDS.sleep(10);} catch (InterruptedException e) {}
                demo.add();
            }

        }, &quot;BBB&quot;).start();

    }

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>没有加到 200：</p><blockquote><p>BBB data = 195<br> BBB data = 196<br> BBB data = 197<br> BBB data = 198<br> BBB data = 199</p></blockquote><p>但是把数据类型从 int 换成 AtomicInteger 即使不加 volatile 也能够保证原子性。所以，结论是：<strong>volatile 关键字<strong><strong>不提供</strong></strong>原子性保证</strong>。</p><h2 id="_3、可见性角度分析" tabindex="-1"><a class="header-anchor" href="#_3、可见性角度分析" aria-hidden="true">#</a> 3、可见性角度分析</h2><p>volatile 写的内存语义：当写一个 volatile 变量时，JMM 会把该线程对应的本地内存中的变量值 flush 到主内存。</p><p>volatile 读的内存语义：当读一个 volatile 变量时，JMM 会把该线程对应的本地内存置为无效。线程接下来将从主内存中读取共享变量。</p><p>所以 volatile 关键字是能够保证可见性的。</p><p>大家可以运行下面的例子测试一下：</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>public class Demo15CanSeeTest {

    private volatile int data = 100;

    public int getData() {
        return data;
    }

    public void setData(int data) {
        this.data = data;
    }

    public static void main(String[] args) {

        Demo15CanSeeTest demo = new Demo15CanSeeTest();

        new Thread(()-&gt;{

            while (demo.getData() == 100) {}

            System.out.println(&quot;AAA 线程发现 data 新值：&quot; + demo.getData());

        }, &quot;AAA&quot;).start();

        new Thread(()-&gt;{

            try {
                TimeUnit.SECONDS.sleep(5);} catch (InterruptedException e) {}

            demo.setData(200);

            System.out.println(&quot;BBB 线程修改 data，新值是：&quot; + demo.getData());

        }, &quot;BBB&quot;).start();

    }

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、有序性角度分析" tabindex="-1"><a class="header-anchor" href="#_4、有序性角度分析" aria-hidden="true">#</a> 4、有序性角度分析</h2><p>volatile确实是一个为数不多的能够从编码层面影响指令重排序的关键字。因为它可以在底层指令中添加<strong>内存屏障</strong>。</p><p>所谓内存屏障，就是一种特殊的指令。底层指令中加入内存屏障，会禁止一定范围内指令的重排。</p><h3 id="_1volatile-写" tabindex="-1"><a class="header-anchor" href="#_1volatile-写" aria-hidden="true">#</a> ①volatile 写</h3><p>在每个 volatile 写操作的前面插入一个 StoreStore 屏障。在每个 volatile 写操作的后面插入一个 StoreLoad 屏障。 <img src="`+y+'" alt="img.png"></p><br><h3 id="_2volatile-读" tabindex="-1"><a class="header-anchor" href="#_2volatile-读" aria-hidden="true">#</a> ②volatile 读</h3><p>在每个 volatile 读操作的后面插入一个 LoadLoad 屏障和一个 LoadStore 屏障。<br></p><p><img src="'+w+`" alt="img.png"></p><br><h2 id="_5、请谈谈你对volatile的理解。" tabindex="-1"><a class="header-anchor" href="#_5、请谈谈你对volatile的理解。" aria-hidden="true">#</a> 5、请谈谈你对volatile的理解。</h2><ul><li>内涵 <ul><li>从 JMM 三大特性的角度来说明 volatile 的功能： <ul><li>原子性：没有</li><li>可见性：有 <ul><li>volatile读的内存语义</li><li>volatile写的内存语义</li></ul></li><li>有序性：有 <ul><li>内存屏障</li></ul></li></ul></li><li><strong>volatile 关键词<strong><strong>最重要</strong></strong>的功能就是为我们的程序提供<strong><strong>可见性</strong></strong>保证</strong></li></ul></li><li>外延 <ul><li>从 volatile 在整个技术系统中的作用来说： <ul><li>volatile + CAS = 原子类的底层原理</li><li>volatile + CAS + 线程对象的双向链表 = AQS 的底层原理</li><li>AQS 是 JUC 中各种 API 底层用到的同步器的实现原理</li></ul></li></ul></li><li>扩展 <ul><li>从 Lock 系列 API 扩展到传统的 synchronized 同步方式</li><li>从多线程的技术领域扩展到项目中多线程的实际应用 <ul><li>本地锁：synchronized、ReentrantLock、ReentrantReadLock……</li><li>分布式锁</li></ul></li></ul></li></ul><br><h1 id="五、cas" tabindex="-1"><a class="header-anchor" href="#五、cas" aria-hidden="true">#</a> 五、CAS</h1><h2 id="_1、名称解释" tabindex="-1"><a class="header-anchor" href="#_1、名称解释" aria-hidden="true">#</a> 1、名称解释</h2><p>CAS：<strong>C</strong>ompare <strong>A</strong>nd <strong>S</strong>wap 比较并交换。</p><p>谁和谁比较？</p><p>为什么比较完了才能交换？</p><p>谁和谁交换？</p><p>这东西有什么用？</p><p>下面我们一一来解释。</p><br><h2 id="_2、工作机制" tabindex="-1"><a class="header-anchor" href="#_2、工作机制" aria-hidden="true">#</a> 2、工作机制</h2><h3 id="_3初步体验" tabindex="-1"><a class="header-anchor" href="#_3初步体验" aria-hidden="true">#</a> ③初步体验</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 1、创建原子类对象</span>
<span class="token class-name">AtomicInteger</span> atomicValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2、使用 CAS 的方式修改原子类对象的值</span>
<span class="token comment">// [1]提供“期待值”：你要修改对象中的数据，那么就先猜一下对象中的当前值是多少</span>
<span class="token comment">// 猜对了就可以修改，猜错了就不能修改</span>
<span class="token keyword">int</span> expectedValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// [2]提供“新值”</span>
<span class="token keyword">int</span> newValue <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">// [3]执行修改</span>
atomicValue<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expectedValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [4]打印修改后的值</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicValue<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3、测试猜错的情况</span>
expectedValue <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
newValue <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
atomicValue<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>expectedValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicValue<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h3 id="_3底层实现" tabindex="-1"><a class="header-anchor" href="#_3底层实现" aria-hidden="true">#</a> ③底层实现</h3><p>CAS底层是基于jdk.internal.misc.Unsafe类实现的<br> Unsafe是Java中直接基于内存地址操作数据的解决方案<br> 本来Java是替程序员屏蔽了内存操作的，所以平时写Java代码不能直接操作内存地址<br> Unsafe这个类相当于是Java给自己留了一个后门，在特殊情况下操作内存地址<br> 正因为它直接操作内存地址，这在程序中是危险的行为，所以它的名字叫：不安全<br></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Object o：要修改的数据所在的对象</span>
<span class="token comment">// long offset：要修改的数据所在的内存地址</span>
<span class="token comment">// int expected：想要修改数据的人认为当前数据实际值是多少</span>
<span class="token comment">// int x：修改后的新值</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>
                                             <span class="token keyword">int</span> expected<span class="token punctuation">,</span>
                                             <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h3 id="_4自旋" tabindex="-1"><a class="header-anchor" href="#_4自旋" aria-hidden="true">#</a> ④自旋</h3><p>尝试执行 CAS 修改的时候，先去读取当前地址对应的实际值，然后以此作为猜测值去执行 CAS 修改：</p><ul><li>猜对了：执行修改，流程结束</li><li>猜错了：重新读取实际值，再次尝试修改</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@IntrinsicCandidate</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> v<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            v <span class="token operator">=</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">weakCompareAndSetInt</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="_3、非阻塞同步" tabindex="-1"><a class="header-anchor" href="#_3、非阻塞同步" aria-hidden="true">#</a> 3、非阻塞同步</h2><p>前面我们比较过AtomicInteger和synchronized两种方案实现原子性操作的性能差距，AtomicInteger方式对比synchronized方式性能优势非常明显。</p><p>那AtomicInteger是如何做到既保证原子性（同步），又能够达到非常高的效率呢？</p><p>原因是：</p><ul><li>使用 CAS 机制修改数据不需要对代码块加同步锁，各线程通过自旋的方式不断尝试修改，线程不会被阻塞。</li><li>配合 volatile 关键字使各个线程直接操作主内存避免了数据不一致。</li></ul><p>所以 CAS 配合 volatile 不需要阻塞线程就能够实现同步效果，性能自然就会比 synchronized 更好。我们把这种机制称为：非阻塞同步。</p><p>当然，这种机制也并不能完全取代同步锁。因为 CAS 针对的是内存中的一个具体数据，无法对一段代码实现同步效果。</p><p>原子类的局限性：不能实现通用的加锁、解锁操作，它只能针对某个特定的值包装成原子类，对于这个特定值的操作提供原子性。</p><h2 id="_4、cas和乐观锁" tabindex="-1"><a class="header-anchor" href="#_4、cas和乐观锁" aria-hidden="true">#</a> 4、CAS和乐观锁</h2><p>总体机制来说，很像，但是乐观锁比CAS机制多维护了一个版本号<br> 在乐观锁机制中要求：必须基于最新版修改，否则就会拒绝<br> 所以乐观锁不会有ABA问题<br> ABA问题：</p><ul><li>数据初始状态下值是A</li><li>修改为B</li><li>修改为A</li><li>此时基于A所做的修改该不该允许？因为此时A不知道是不是最新版</li></ul><h1 id="六、debug方式查看aqs工作机制" tabindex="-1"><a class="header-anchor" href="#六、debug方式查看aqs工作机制" aria-hidden="true">#</a> 六、DEBUG方式查看AQS工作机制</h1><h2 id="_1、申请锁成功" tabindex="-1"><a class="header-anchor" href="#_1、申请锁成功" aria-hidden="true">#</a> 1、申请锁成功</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">initialTryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1、获取当前线程</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 2、尝试使用 CAS 方式修改 state 的值</span>
    <span class="token comment">// 锁对象没有被任何线程占用时，state 的值就是 0</span>
    <span class="token comment">// 所以 CAS 修改成功，state 的值被修改成了 1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// first attempt is unguarded</span>
        <span class="token comment">// 3、把独占当前锁对象的线程设置为当前线程</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="_2、锁重入" tabindex="-1"><a class="header-anchor" href="#_2、锁重入" aria-hidden="true">#</a> 2、锁重入</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">initialTryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1、获取当前线程</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 2、尝试修改 state 的值</span>
    <span class="token comment">// 在锁重入的情况下，state 已经被当前线程自己在更早的时候改成 1</span>
    <span class="token comment">// 所以用 0 去猜就猜错了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// first attempt is unguarded</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    
    <span class="token comment">// 3、判断当前独占锁对象的线程是不是当前线程自己</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4、如果确实是当前线程自己，那么就知道是发生了锁重入，state 值再 +1</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 5、设置 state 的值</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 6、返回 true 表示获取锁成功</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><br><h2 id="_3、申请锁失败" tabindex="-1"><a class="header-anchor" href="#_3、申请锁失败" aria-hidden="true">#</a> 3、申请锁失败</h2><p>判断当前线程申请锁失败：<br></p><p><img src="`+T+'" alt="img.png"></p><br><p>把申请锁失败的线程存入双向链表：<br></p><p><img src="'+x+`" alt="img.png"></p><h2 id="_4、释放锁" tabindex="-1"><a class="header-anchor" href="#_4、释放锁" aria-hidden="true">#</a> 4、释放锁</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ReservedStackAccess</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1、给 state 减去指定的值</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
        
    <span class="token comment">// 2、要求执行释放锁操作的必须是当前线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 3、检查锁重入是否全部退出了</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>free<span class="token punctuation">)</span>
        <span class="token comment">// 4、如果锁重入全部退出了，那么独占锁对象的线程这里置空</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 5、修改 state 的值</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,227),S=[A];function q(J,B){return a(),s("div",null,S)}const M=n(_,[["render",q],["__file","04-Lock原理.html.vue"]]);export{M as default};
