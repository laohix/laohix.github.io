import{_ as n,o as s,c as a,e as t}from"./app-8007fa1b.js";const p="/assets/tingshu012-a5e06d5b.png",e="/assets/tingshu060-5fccb24b.png",o="/assets/tingshu061-db306373.png",c="/assets/tingshu010-e4502d6a.png",l="/assets/tingshu011-fcda4273.png",i="/assets/tingshu013-ea4e5abb.png",u="/assets/tingshu015-07f0a5e4.png",k="/assets/tingshu014-a0557b8d.png",r={},d=t('<h1 id="谷粒随享" tabindex="-1"><a class="header-anchor" href="#谷粒随享" aria-hidden="true">#</a> 谷粒随享</h1><h2 id="专辑详情" tabindex="-1"><a class="header-anchor" href="#专辑详情" aria-hidden="true">#</a> 专辑详情</h2><p>主要功能如下：</p><p><img src="'+p+'" alt=""></p><p>我的--&gt;创作中心--&gt;专辑详情 查看专辑详细信息 或在检索列表中直接点击专辑都可以查看专辑详细信息！</p><p><img src="'+e+'" alt=""></p><p><img src="'+o+`" alt=""></p><p>http://127.0.0.1/api/search/albumInfo/125</p><p>在商品检索微服务中编写控制器：</p><p>以下是详情需要获取到的数据集</p><ol><li>通过专辑Id 获取专辑数据{已存在}</li><li>通过专辑Id 获取专辑统计信息{不存在}</li><li>通过三级分类Id 获取到分类数据{已存在}</li><li>通过用户Id 获取到主播信息{已存在}</li></ol><h3 id="通过专辑id-获取专辑数据" tabindex="-1"><a class="header-anchor" href="#通过专辑id-获取专辑数据" aria-hidden="true">#</a> 通过专辑Id 获取专辑数据</h3><p>service-album-client 远程调用中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">AlbumInfoDegradeFeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumStatVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 产品列表API接口
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
 *
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-album&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">AlbumInfoDegradeFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AlbumInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 获取专辑信息
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/album/albumInfo/getAlbumInfo/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAlbumInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">AlbumInfoFeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumStatVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlbumInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">AlbumInfoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAlbumInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AlbumInfoApiController 控制器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据id 获取到专辑信息
  * <span class="token keyword">@param</span> <span class="token parameter">id</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取专辑信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getAlbumInfo/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAlbumInfoById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	调用服务层方法</span>
  <span class="token class-name">AlbumInfo</span> albumInfo <span class="token operator">=</span> albumInfoService<span class="token punctuation">.</span><span class="token function">getAlbumInfoById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="根据专辑id-获取到状态信息" tabindex="-1"><a class="header-anchor" href="#根据专辑id-获取到状态信息" aria-hidden="true">#</a> 根据专辑Id 获取到状态信息</h3><p>根据专辑Id 获取到状态数据之后，将数据封装到 AlbumStatVo 实体类中</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>album</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>oas<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑统计信息&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlbumStatVo</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;播放量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> playStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;订阅量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> subscribeStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;购买量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> buyStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;评论数&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> commentStatNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AlbumInfoFeignClient 接口中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 通过专辑Id 获取到专辑状态信息
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/album/albumInfo/getAlbumStatVo/{albumId}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumStatVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAlbumStatVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlbumInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">AlbumInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumStatVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAlbumStatVo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AlbumInfoApiController 控制器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据专辑Id 获取到统计信息
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取到专辑统计信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getAlbumStatVo/{albumId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getAlbumStatVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//	获取服务层方法</span>
  <span class="token class-name">AlbumStatVo</span> albumStatVo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>albumInfoService<span class="token punctuation">.</span><span class="token function">getAlbumStatVoByAlbumId</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>albumStatVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口与实现类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 根据专辑Id 获取到统计信息
     * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
     * <span class="token keyword">@return</span>
     */</span>
<span class="token class-name">AlbumStatVo</span> <span class="token function">getAlbumStatVoByAlbumId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">AlbumStatVo</span> <span class="token function">getAlbumStatVoByAlbumId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	调用mapper 层方法</span>
  <span class="token keyword">return</span> albumInfoMapper<span class="token punctuation">.</span><span class="token function">selectAlbumStat</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>albumInfoMapper.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 根据专辑Id 获取到统计信息
* <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token class-name">AlbumStatVo</span> <span class="token function">selectAlbumStat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;albumId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>albumInfoMapper.xml</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--根据专辑Id 获取到统计数据--&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectAlbumStat&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;com.atguigu.tingshu.vo.album.AlbumStatVo&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span>
        <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token string">&#39;0401&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> playStatNum<span class="token punctuation">,</span>
        <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token string">&#39;0402&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> subscribeStatNum<span class="token punctuation">,</span>
        <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token string">&#39;0403&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> buyStatNum<span class="token punctuation">,</span>
        <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token string">&#39;0404&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> commentStatNum
    <span class="token keyword">from</span> <span class="token punctuation">(</span>
             <span class="token keyword">select</span>
                 stat<span class="token punctuation">.</span>album_id <span class="token keyword">as</span> albumId<span class="token punctuation">,</span>
                 stat<span class="token punctuation">.</span>stat_type <span class="token keyword">as</span> statType<span class="token punctuation">,</span>
                 stat<span class="token punctuation">.</span>stat_num <span class="token keyword">as</span> statNum
             <span class="token keyword">from</span> album_stat stat
             <span class="token keyword">where</span> album_id <span class="token operator">=</span> <span class="token comment">#{albumId}</span>
         <span class="token punctuation">)</span> info
    <span class="token keyword">group</span> <span class="token keyword">by</span> info<span class="token punctuation">.</span>albumId
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="根据三级分类id获取到分类信息数据" tabindex="-1"><a class="header-anchor" href="#根据三级分类id获取到分类信息数据" aria-hidden="true">#</a> 根据三级分类Id获取到分类信息数据</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">CategoryDegradeFeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">BaseCategoryView</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 产品列表API接口
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
 *
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-album&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">CategoryDegradeFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CategoryFeignClient</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据三级分类Id 获取到分类数据
     * <span class="token keyword">@param</span> <span class="token parameter">category3Id</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/album/category/getCategoryView/{category3Id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseCategoryView</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCategoryView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> category3Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CategoryDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">CategoryFeignClient</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseCategoryView</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCategoryView</span><span class="token punctuation">(</span><span class="token class-name">Long</span> category3Id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BaseCategoryApiController 添加控制器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据三级分类Id 获取到分类信息
  * <span class="token keyword">@param</span> <span class="token parameter">category3Id</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;通过三级分类id查询分类信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getCategoryView/{category3Id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseCategoryView</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCategoryView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> category3Id<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//	调用服务层方法</span>
  <span class="token class-name">BaseCategoryView</span> baseCategoryView <span class="token operator">=</span> baseCategoryService<span class="token punctuation">.</span><span class="token function">getCategoryViewByCategory3Id</span><span class="token punctuation">(</span>category3Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>baseCategoryView<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 根据三级分类Id 获取到分类信息
* <span class="token keyword">@param</span> <span class="token parameter">category3Id</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token class-name">BaseCategoryView</span> <span class="token function">getCategoryViewByCategory3Id</span><span class="token punctuation">(</span><span class="token class-name">Long</span> category3Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
	 * 根据三级分类Id获取到分类数据
	 * <span class="token keyword">@param</span> <span class="token parameter">category3Id</span>
	 * <span class="token keyword">@return</span>
	 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BaseCategoryView</span> <span class="token function">getCategoryViewByCategory3Id</span><span class="token punctuation">(</span><span class="token class-name">Long</span> category3Id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> baseCategoryViewMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>category3Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="根据用户id-获取主播信息" tabindex="-1"><a class="header-anchor" href="#根据用户id-获取主播信息" aria-hidden="true">#</a> 根据用户Id 获取主播信息</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-user&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">UserInfoDegradeFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据userId 获取到用户信息
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/user/userInfo/getUserInfoVo/{userId}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfoVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfoVo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserInfoApiController 用户控制器</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 根据用户Id获取用户信息
* <span class="token keyword">@param</span> <span class="token parameter">userId</span>
* <span class="token keyword">@return</span>
*/</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;根据用户id获取用户信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getUserInfoVo/{userId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfoVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	获取用户信息</span>
  <span class="token class-name">UserInfoVo</span> userInfoVo <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfoVoByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="整合详情信息接口" tabindex="-1"><a class="header-anchor" href="#整合详情信息接口" aria-hidden="true">#</a> 整合详情信息接口</h3><p>回显时，后台需要提供将数据封装到map集合中;</p><p>result.put(&quot;albumInfo&quot;, albumInfo); 获取专辑信息 result.put(&quot;albumStatVo&quot;, albumStatVo); 获取专辑统计信息 result.put(&quot;baseCategoryView&quot;, baseCategoryView); 获取分类信息 result.put(&quot;announcer&quot;, userInfoVo); 获取主播信息</p><h4 id="itemapicontroller-控制器" tabindex="-1"><a class="header-anchor" href="#itemapicontroller-控制器" aria-hidden="true">#</a> itemApiController 控制器</h4><p>在service-list 微服务中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Tag</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;专辑详情管理&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/search/albumInfo&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> itemApiController <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">ItemService</span> itemService<span class="token punctuation">;</span>

   <span class="token doc-comment comment">/**
    * 根据专辑Id 获取详情数据
    * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
    * <span class="token keyword">@return</span>
    */</span>
   <span class="token annotation punctuation">@GuiGuLogin</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;专辑详情&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;{albumId}&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 获取到专辑详情数据</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemService<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回数据</span>
      <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口" tabindex="-1"><a class="header-anchor" href="#接口" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemService</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 根据专辑Id 获取数据
     * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类" tabindex="-1"><a class="header-anchor" href="#实现类" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>album<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">GuiguCache</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AuthContextHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">BaseCategoryView</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ItemService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>album<span class="token punctuation">.</span></span><span class="token class-name">AlbumStatVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserInfoVo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">ServletRequestAttributes</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CompletableFuture</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ItemService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AlbumInfoFeignClient</span> albumInfoFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TrackInfoFeignClient</span> trackInfoFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CategoryFeignClient</span> categoryFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoFeignClient</span> userInfoFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserListenProcessFeignClient</span> userListenProcessFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GuiguCache</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//远程调用接口之前 提前知道用户访问的专辑id是否存在与布隆过滤器</span>
<span class="token comment">//        RBloomFilter&lt;Object&gt; bloomFilter = redissonClient.getBloomFilter(RedisConstant.ALBUM_BLOOM_FILTER);</span>
<span class="token comment">//        if (!bloomFilter.contains(albumId)) {</span>
<span class="token comment">//            log.error(&quot;用户查询专辑不存在：{}&quot;, albumId);</span>
<span class="token comment">//            //查询数据不存在直接返回空对象</span>
<span class="token comment">//            return result;</span>
<span class="token comment">//        }</span>

        <span class="token comment">// 通过albumId 查询albumInfo</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumInfo</span><span class="token punctuation">&gt;</span></span> albumCompletableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumInfo</span><span class="token punctuation">&gt;</span></span> albumInfoResult <span class="token operator">=</span> albumInfoFeignClient<span class="token punctuation">.</span><span class="token function">getAlbumInfo</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>albumInfoResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AlbumInfo</span> albumInfo <span class="token operator">=</span> albumInfoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 保存albumInfo</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;albumInfo&quot;</span><span class="token punctuation">,</span> albumInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;albumInfo:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> albumInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> albumStatCompletableFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumStatVo</span><span class="token punctuation">&gt;</span></span> albumStatVoResult <span class="token operator">=</span> albumInfoFeignClient<span class="token punctuation">.</span><span class="token function">getAlbumStatVo</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AlbumStatVo</span> albumStatVo <span class="token operator">=</span> albumStatVoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;albumStatVo&quot;</span><span class="token punctuation">,</span> albumStatVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;albumStatVo:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>albumStatVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> baseCategoryViewCompletableFuture <span class="token operator">=</span> albumCompletableFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>albumInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseCategoryView</span><span class="token punctuation">&gt;</span></span> baseCategoryViewResult <span class="token operator">=</span> categoryFeignClient<span class="token punctuation">.</span><span class="token function">getCategoryView</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BaseCategoryView</span> baseCategoryView <span class="token operator">=</span> baseCategoryViewResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;baseCategoryView&quot;</span><span class="token punctuation">,</span> baseCategoryView<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;baseCategoryView:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>baseCategoryView<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> announcerCompletableFuture <span class="token operator">=</span> albumCompletableFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>albumInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> userInfoVoResult <span class="token operator">=</span> userInfoFeignClient<span class="token punctuation">.</span><span class="token function">getUserInfoVo</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UserInfoVo</span> userInfoVo <span class="token operator">=</span> userInfoVoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;announcer&quot;</span><span class="token punctuation">,</span> userInfoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;announcer:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>userInfoVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> threadPoolExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>albumCompletableFuture<span class="token punctuation">,</span> albumStatCompletableFuture<span class="token punctuation">,</span> baseCategoryViewCompletableFuture<span class="token punctuation">,</span> announcerCompletableFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置自定义线程池：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>search<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> atguigu-mqx
 * @ClassName ThreadPoolExecutorConfig
 * <span class="token keyword">@description</span>: TODO
 * <span class="token keyword">@date</span> 2023年09月24日
 * <span class="token keyword">@version</span>: 1.0
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">threadPoolExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//  自定义线程池-不能使用工具类创建线程池. 阻塞队列或最大线程个数是21亿，这样会导致OOM!</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token number">8</span><span class="token punctuation">,</span>    <span class="token comment">//  核心线程数 IO:2n  cpu:n+1</span>
                <span class="token number">16</span><span class="token punctuation">,</span>   <span class="token comment">//  最大线程数</span>
                <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">//  空闲线程存活时间</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token comment">// 空闲线程存活时间单位</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 阻塞队列</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> threadPoolExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="根据专辑id获取专辑声音列表" tabindex="-1"><a class="header-anchor" href="#根据专辑id获取专辑声音列表" aria-hidden="true">#</a> 根据专辑Id获取专辑声音列表</h3><p><img src="`+c+'" alt=""></p><p>http://127.0.0.1/api/album/trackInfo/findAlbumTrackPage/1593/1/10 获取专辑声音列表</p><p><img src="'+l+`" alt=""></p><h5 id="控制器" tabindex="-1"><a class="header-anchor" href="#控制器" aria-hidden="true">#</a> 控制器</h5><p>我们将数据都统一封装到 AlbumTrackListVo 实体类中</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>album</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>oas<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;用户专辑声音列表信息&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AlbumTrackListVo</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;标题&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> trackTitle<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音媒体时长，单位秒&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> mediaDuration<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;排序&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> orderNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;播放量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> playStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;评论数&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> commentStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;发布时间&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;是否显示付费标识，isShowPiadMark=true，则显示付费标识&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isShowPaidMark <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在service-album 微服务中添加控制器TrackInfoApiController. 获取专辑声音列表时</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据专辑Id获取声音列表
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">page</span>
  * <span class="token keyword">@param</span> <span class="token parameter">limit</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取专辑声音分页列表&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findAlbumTrackPage/{albumId}/{page}/{limit}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IPage</span><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAlbumTrackPage</span><span class="token punctuation">(</span>
		<span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;albumId&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span>
		<span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;当前页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> page<span class="token punctuation">,</span>
		<span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;limit&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;每页记录数&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//	获取用户Id</span>
	<span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	构建分页对象</span>
	<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	调用服务层方法</span>
	<span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageModel <span class="token operator">=</span> trackInfoService<span class="token punctuation">.</span><span class="token function">findAlbumTrackPage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span> albumId<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	返回数据</span>
	<span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="接口-1" tabindex="-1"><a class="header-anchor" href="#接口-1" aria-hidden="true">#</a> 接口</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TrackInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrackInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>   
	<span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAlbumTrackPage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="实现类-1" tabindex="-1"><a class="header-anchor" href="#实现类-1" aria-hidden="true">#</a> 实现类</h5><p>思路：</p><ol><li><p>根据专辑Id 获取到声音列表 ，将数据封装到 AlbumTrackListVo 类中</p><ol><li><p>用户为空的时候，只要是付费专辑，都需要在页面显示要付款的标识 {<strong>但是，要出去试听集数</strong>} isShowPaidMark=true</p><p>付费类型： 0101-免费 0102-vip付费 0103-付费</p></li><li><p>用户不为空的时候</p><ol><li><p>判断用户的类型</p><ol><li><p>专辑类型属于 vip 免费类型</p><p>判断用户如果不是vip ，则需要付费</p><p>判断用户如果是vip 但是已经过期了, 也需要显示付费</p></li><li><p>需要付费</p><p>需要显示付费</p></li><li><p>统一处理需要付费业务</p><p>​ 获取到声音Id列表集合 与 用户购买声音Id集合进行比较 [ 将用户购买的声音存储到map中，key=trackId value = 1或0; 1:表示购买过，0：表示没有购买过 ]</p><p>如果声音Id集合不包含购买的声音Id，则将显示为付费，否则不需要付费</p></li></ol></li></ol></li></ol></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAlbumTrackPage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	根据专辑Id 获取到声音集合</span>
  <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageInfo <span class="token operator">=</span> trackInfoMapper<span class="token punctuation">.</span><span class="token function">selectAlbumTrackPage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//	判断用户是否需要付费：0101-免费 0102-vip付费 0103-付费</span>
  <span class="token class-name">AlbumInfo</span> albumInfo <span class="token operator">=</span> albumInfoService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">,</span><span class="token string">&quot;专辑对象不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	判断用户是否登录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//	除免费的专辑都需要显示付费表示</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ALBUM_PAY_TYPE_FREE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">.</span><span class="token function">getPayType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//	处理试听声音，获取需要付费的声音列表</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> albumTrackNeedPaidListVoList <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>albumTrackListVo <span class="token operator">-&gt;</span> albumTrackListVo<span class="token punctuation">.</span><span class="token function">getOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> albumInfo<span class="token punctuation">.</span><span class="token function">getTracksForFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>albumTrackNeedPaidListVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        albumTrackNeedPiadListVoList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>albumTrackListVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//	显示付费通知</span>
          albumTrackListVo<span class="token punctuation">.</span><span class="token function">setIsShowPiadMark</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//	用户已登录</span>
    <span class="token comment">//	声明变量是否需要付费，默认不需要付费</span>
    <span class="token keyword">boolean</span> isNeedPaid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//  vip 付费情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ALBUM_PAY_TYPE_VIPFREE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">.</span><span class="token function">getPayType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//	获取用户信息</span>
      <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> userInfoVoResult <span class="token operator">=</span> userInfoFeignClient<span class="token punctuation">.</span><span class="token function">getUserInfoVo</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userInfoVoResult<span class="token punctuation">,</span><span class="token string">&quot;用户信息不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">UserInfoVo</span> userInfoVo <span class="token operator">=</span> userInfoVoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//	1.	VIP 免费,如果不是vip则需要付费，将这个变量设置为true，需要购买</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfoVo<span class="token punctuation">.</span><span class="token function">getIsVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        isNeedPiad <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//1.1 如果是vip但是vip过期了（定时任务还为更新状态）</span>
	  <span class="token keyword">if</span><span class="token punctuation">(</span>userInfoVo<span class="token punctuation">.</span><span class="token function">getIsVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> userInfoVo<span class="token punctuation">.</span><span class="token function">getVipExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		isNeedPiad <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ALBUM_PAY_TYPE_REQUIRE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>albumInfo<span class="token punctuation">.</span><span class="token function">getPayType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//	2.	付费</span>
      isNeedPiad <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//需要付费，判断用户是否购买过专辑或声音</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isNeedPiad<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//	处理试听声音，获取需要付费的声音列表</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> albumTrackNeedPaidListVoList <span class="token operator">=</span> pageInfo<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>albumTrackListVo <span class="token operator">-&gt;</span> albumTrackListVo<span class="token punctuation">.</span><span class="token function">getOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> albumInfo<span class="token punctuation">.</span><span class="token function">getTracksForFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//	判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>albumTrackNeedPaidListVoList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//	判断用户是否购买该声音</span>
        <span class="token comment">//	获取到声音Id 集合列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList <span class="token operator">=</span> albumTrackNeedPaidListVoList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">AlbumTrackListVo</span><span class="token operator">::</span><span class="token function">getTrackId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//	获取用户购买的声音列表</span>
        <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapResult <span class="token operator">=</span> userInfoFeignClient<span class="token punctuation">.</span><span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span>albumId<span class="token punctuation">,</span>trackIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>mapResult<span class="token punctuation">,</span><span class="token string">&quot;声音集合不能为空.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> mapResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token string">&quot;map集合不能为空.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        albumTrackNeedPaidListVoList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>albumTrackListVo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>          
            <span class="token comment">//	如果map.get(albumTrackListVo.getTrackId()) == 1 已经购买过，则不显示付费标识;</span>
            <span class="token keyword">boolean</span> isBuy <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>albumTrackListVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            albumTrackListVo<span class="token punctuation">.</span><span class="token function">setIsShowPiadMark</span><span class="token punctuation">(</span>isBuy<span class="token punctuation">)</span><span class="token punctuation">;</span>         
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回集合数据</span>
  <span class="token keyword">return</span> pageInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="根据专辑id-获取到声音列表" tabindex="-1"><a class="header-anchor" href="#根据专辑id-获取到声音列表" aria-hidden="true">#</a> 根据专辑Id 获取到声音列表</h4><p>条件必须是当前已经<strong>开放</strong>并且是<strong>审核通过状态</strong>的数据,并且还需要获取到声音的<strong>播放量以及评论数量</strong></p><h5 id="trackinfomapper接口" tabindex="-1"><a class="header-anchor" href="#trackinfomapper接口" aria-hidden="true">#</a> TrackInfoMapper接口</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TrackInfoMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrackInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 获取专辑声音列表
     * <span class="token keyword">@param</span> <span class="token parameter">pageParam</span>
     * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectAlbumTrackPage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlbumTrackListVo</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;albumId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="trackinfomapper-xml-映射文件" tabindex="-1"><a class="header-anchor" href="#trackinfomapper-xml-映射文件" aria-hidden="true">#</a> TrackInfoMapper.xml 映射文件</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--根据专辑 Id 获取到声音列表--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectAlbumTrackPage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.atguigu.tingshu.vo.album.AlbumTrackListVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  select
  info.trackId,
  info.trackTitle,
  info.mediaDuration,
  info.orderNum,
  info.createTime,
  MAX(IF(info.statType = &#39;0701&#39;, info.statNum, 0)) as playStatNum,
  MAX(IF(info.statType = &#39;0704&#39;, info.statNum, 0)) as commentStatNum
  from
  (select
  track.id as trackId,
  track.track_title as trackTitle,
  track.media_duration as mediaDuration,
  track.order_num as orderNum,
  track.create_time as createTime,
  stat.stat_type as statType,
  stat.stat_num as statNum
  from track_info track
  left join track_stat stat on stat.track_id = track.id
  where track.album_id = #{albumId} and track.is_open = &#39;1&#39; and track.status = &#39;0501&#39;) info
  group by info.trackId
  order by info.orderNum asc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="判断用户是否购买声音列表" tabindex="-1"><a class="header-anchor" href="#判断用户是否购买声音列表" aria-hidden="true">#</a> 判断用户是否购买声音列表</h4><p>user_paid_album 这张表记录了用户购买过的专辑</p><p>如果购买过，则在 map 中存储数据 key=trackId value = 1</p><h5 id="userinfofeignclient-远程调用接口中添加" tabindex="-1"><a class="header-anchor" href="#userinfofeignclient-远程调用接口中添加" aria-hidden="true">#</a> UserInfoFeignClient 远程调用接口中添加：</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 判断用户是否购买声音列表
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">trackIdList</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/user/userInfo/userIsPaidTrack/{albumId}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;albumId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="userinfoapicontroller-控制器" tabindex="-1"><a class="header-anchor" href="#userinfoapicontroller-控制器" aria-hidden="true">#</a> UserInfoApiController 控制器</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 判断用户是否购买声音列表
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">trackIdList</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;判断用户是否购买声音列表&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;userIsPaidTrack/{albumId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	获取用户Id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	调用服务层方法</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> albumId<span class="token punctuation">,</span> trackIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	返回map 集合数据</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="接口-2" tabindex="-1"><a class="header-anchor" href="#接口-2" aria-hidden="true">#</a> 接口</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 判断用户是否购买过声音列表
  * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">trackIdList</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="实现类-2" tabindex="-1"><a class="header-anchor" href="#实现类-2" aria-hidden="true">#</a> 实现类</h5><ol><li>根据用户Id，专辑Id 获取到用户付款专辑对象 <ol><li>如果对象不为空，说明购买过专辑，则设置在map集合中 声音Id为1 map.put(trackId,1); 并返回集合map</li><li>如果对象为空，说明用户没有购买过专辑，但是，需要查询当前用户Id是否购买过声音Id集合中的声音 <ol><li>判断当前专辑声音Id集合列表 中是否包含已购买的声音Id。 <ol><li>true: 设置为1</li><li>false: 设置为0</li></ol></li></ol></li></ol></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">userIsPaidTrack</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> trackIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	根据UserId,albumId 获取到用户付款专辑对象</span>
  <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserPaidAlbum</span><span class="token punctuation">&gt;</span></span> userPaidAlbumLambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  userPaidAlbumLambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">UserPaidAlbum</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">UserPaidAlbum</span><span class="token operator">::</span><span class="token function">getAlbumId</span><span class="token punctuation">,</span>albumId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">UserPaidAlbum</span> userPaidAlbum <span class="token operator">=</span> userPaidAlbumMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>userPaidAlbumLambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> userPaidAlbum<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//	创建一个map 集合</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	如果查询到对应的专辑购买记录，则默认将声音Id 赋值为 1</span>
    trackIdList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>trackId<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>trackId<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//	根据用户Id 与专辑Id 查询用户购买声音记录</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserPaidTrack</span><span class="token punctuation">&gt;</span></span> userPaidTrackLambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userPaidTrackLambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">UserPaidTrack</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">UserPaidTrack</span><span class="token operator">::</span><span class="token function">getTrackId</span><span class="token punctuation">,</span>trackIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserPaidTrack</span><span class="token punctuation">&gt;</span></span> userPaidTrackList <span class="token operator">=</span> userPaidTrackService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>userPaidTrackLambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	获取到用户购买声音Id 集合</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userPaidTrackIdList <span class="token operator">=</span> userPaidTrackList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">UserPaidTrack</span><span class="token operator">::</span><span class="token function">getTrackId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	创建一个map 集合</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    trackIdList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>trackId <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userPaidTrackIdList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>trackId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//	用户已购买声音</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>trackId<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>trackId<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="声音详情" tabindex="-1"><a class="header-anchor" href="#声音详情" aria-hidden="true">#</a> 声音详情</h2><h3 id="获取声音播放进度" tabindex="-1"><a class="header-anchor" href="#获取声音播放进度" aria-hidden="true">#</a> 获取声音播放进度</h3><p>在播放声音的时候，会有触发一个获取播放进度的控制器！因为页面每隔10s会自动触发一次保存功能，会将数据写入MongoDB中。所以我们直接从MongoDB中获取到声音的播放时间即可！</p><p><img src="`+i+`" alt=""></p><h4 id="控制器-1" tabindex="-1"><a class="header-anchor" href="#控制器-1" aria-hidden="true">#</a> 控制器</h4><p>在 service-user 微服务的 UserListenProcessApiController 控制器中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 获取声音播放的时间
  * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取声音的上次跳出时间&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getTrackBreakSecond/{trackId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTrackBreakSecond</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	获取用户Id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	调用服务层方法</span>
  <span class="token class-name">BigDecimal</span> trackBreakSecond <span class="token operator">=</span> userListenProcessService<span class="token punctuation">.</span><span class="token function">getTrackBreakSecond</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	返回数据</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>trackBreakSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-3" tabindex="-1"><a class="header-anchor" href="#接口-3" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据用户Id,声音Id 获取到播放进度
  * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">BigDecimal</span> <span class="token function">getTrackBreakSecond</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-3" tabindex="-1"><a class="header-anchor" href="#实现类-3" aria-hidden="true">#</a> 实现类</h4><p>思路：</p><ol><li>根据userId, 声音Id 获取数据 从MongoDB 获取数据</li><li>给集合起一个名称 userListenProcess_userId</li><li>存储数据的时候，将数据封装到 UserListenProcess 这个对象中</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>oas<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;UserListenProcess&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Document</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserListenProcess</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;用户id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音id，声音id为0时，浏览的是专辑&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;相对于音频开始位置的播放跳出位置，单位为秒。比如当前音频总时长60s，本次播放到音频第25s处就退出或者切到下一首，那么break_second就是25&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> breakSecond<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;是否显示&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> isShow<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;创建时间&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;更新时间&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTrackBreakSecond</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	根据用户Id,声音Id获取播放进度对象</span>
  <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;trackId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>trackId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">UserListenProcess</span> userListenProcess <span class="token operator">=</span> mongoTemplate<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">UserListenProcess</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MongoUtil</span><span class="token punctuation">.</span><span class="token function">getCollectionName</span><span class="token punctuation">(</span><span class="token class-name">MongoUtil<span class="token punctuation">.</span>MongoCollectionEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LISTEN_PROCESS</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> userListenProcess<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//	获取到播放的跳出时间</span>
    <span class="token keyword">return</span> userListenProcess<span class="token punctuation">.</span><span class="token function">getBreakSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新播放进度" tabindex="-1"><a class="header-anchor" href="#更新播放进度" aria-hidden="true">#</a> 更新播放进度</h3><p><img src="`+u+`" alt=""></p><h4 id="实体类" tabindex="-1"><a class="header-anchor" href="#实体类" aria-hidden="true">#</a> 实体类</h4><p>在 UserListenProcessApiController 控制器中添加</p><p>页面每隔10秒左右更新播放进度.</p><ol><li>更新播放进度页面会传递 专辑Id ，秒数，声音Id 。后台会将这个三个属性封装到UserListenProcessVo 对象中。然后利用MongoDB进行存储到UserListenProcess实体类中！</li><li>为了更好的统计声音播放次数，将用户信息与声音信息存储到缓存中，判断同一个用户在一天之内，对同一个声音多次播放，只计算一次。并且要发送消息给kafka。</li><li>kafka 监听消息并消费，更新专辑与声音的统计数据。</li></ol><h5 id="接收前端页面传递参数实体类" tabindex="-1"><a class="header-anchor" href="#接收前端页面传递参数实体类" aria-hidden="true">#</a> 接收前端页面传递参数实体类</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;UserListenProcess&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserListenProcessVo</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音id，声音id为0时，浏览的是专辑&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;相对于音频开始位置的播放跳出位置，单位为秒。比如当前音频总时长60s，本次播放到音频第25s处就退出或者切到下一首，那么break_second就是25&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;break_second&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> breakSecond<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="数据存储实体类" tabindex="-1"><a class="header-anchor" href="#数据存储实体类" aria-hidden="true">#</a> 数据存储实体类</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;UserListenProcess&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Document</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserListenProcess</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;用户id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音id，声音id为0时，浏览的是专辑&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;相对于音频开始位置的播放跳出位置，单位为秒。比如当前音频总时长60s，本次播放到音频第25s处就退出或者切到下一首，那么break_second就是25&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> breakSecond<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;是否显示&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> isShow<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;创建时间&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;更新时间&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="控制器-2" tabindex="-1"><a class="header-anchor" href="#控制器-2" aria-hidden="true">#</a> 控制器</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 更新播放进度
  * <span class="token keyword">@param</span> <span class="token parameter">userListenProcessVo</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;更新播放进度&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/updateListenProcess&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">updateListenProcess</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserListenProcessVo</span> userListenProcessVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	获取用户Id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	调用服务层方法</span>
  userListenProcessService<span class="token punctuation">.</span><span class="token function">updateListenProcess</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> userListenProcessVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-4" tabindex="-1"><a class="header-anchor" href="#接口-4" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 更新播放进度
* <span class="token keyword">@param</span> <span class="token parameter">userId</span>
* <span class="token keyword">@param</span> <span class="token parameter">userListenProcessVo</span>
*/</span>
<span class="token keyword">void</span> <span class="token function">updateListenProcess</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">UserListenProcessVo</span> userListenProcessVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-4" tabindex="-1"><a class="header-anchor" href="#实现类-4" aria-hidden="true">#</a> 实现类</h4><p>思路：</p><ol><li>根据用户Id，声音Id 查询当前存储对象信息</li><li>如果对象不为空，修改当前对象的更新时间与跳出时间，并写入MongoDB</li><li>如果对象为空，说明当前声音从来没有播放过，需要创建对象并赋值然后写入缓存中</li><li>通过声音Id，用户Id 两个维度来判断是否存在当前声音记录</li><li>如果存在，将声音存储到缓存中，在发送一个消息来更新声音的统计数据 封装发送消息的实体类 TrackStatMqVo</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;TrackStatMqVo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrackStatMqVo</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;业务编号：去重使用&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> businessNo<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;专辑id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;声音id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;统计类型&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> statType<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;更新数目&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateListenProcess</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">UserListenProcessVo</span> userListenProcessVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据用户Id，声音Id 设置查询条件</span>
  <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">Query</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;trackId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>userListenProcessVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">UserListenProcess</span> userListenProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">UserListenProcess</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MongoUtil</span><span class="token punctuation">.</span><span class="token function">getCollectionName</span><span class="token punctuation">(</span><span class="token class-name">MongoUtil<span class="token punctuation">.</span>MongoCollectionEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LISTEN_PROCESS</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> userListenProcess<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//	设置更新时间</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	设置跳出时间</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setBreakSecond</span><span class="token punctuation">(</span>userListenProcessVo<span class="token punctuation">.</span><span class="token function">getBreakSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	存储数据</span>
    mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userListenProcess<span class="token punctuation">,</span><span class="token class-name">MongoUtil</span><span class="token punctuation">.</span><span class="token function">getCollectionName</span><span class="token punctuation">(</span><span class="token class-name">MongoUtil<span class="token punctuation">.</span>MongoCollectionEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LISTEN_PROCESS</span><span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//	创建对象</span>
    userListenProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserListenProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	进行属性拷贝</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>userListenProcessVo<span class="token punctuation">,</span> userListenProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	设置Id</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">ObjectId</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	设置用户Id</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	设置是否显示</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setIsShow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	创建时间</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	更新时间</span>
    userListenProcess<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//	保存数据</span>
    mongoTemplate<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userListenProcess<span class="token punctuation">,</span> <span class="token class-name">MongoUtil</span><span class="token punctuation">.</span><span class="token function">getCollectionName</span><span class="token punctuation">(</span><span class="token class-name">MongoUtil<span class="token punctuation">.</span>MongoCollectionEnum</span><span class="token punctuation">.</span><span class="token constant">USER_LISTEN_PROCESS</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//记录专辑与声音播放量，同一个用户同一个声音每天只记录一次播放量</span>
  <span class="token comment">//专辑的播放量 = 声音播放量的总和   声音：用户</span>
  <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;user:track:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMdd&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
  <span class="token class-name">Boolean</span> isExist <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userListenProcessVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isExist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userListenProcessVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
     <span class="token comment">//  设置key 的过期时间</span>
     <span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusHours</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusMinutes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusNanos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>localDateTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
     redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
     <span class="token comment">//发送消息，更新播放量统计</span>
     <span class="token class-name">TrackStatMqVo</span> trackStatMqVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackStatMqVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     trackStatMqVo<span class="token punctuation">.</span><span class="token function">setBusinessNo</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     trackStatMqVo<span class="token punctuation">.</span><span class="token function">setAlbumId</span><span class="token punctuation">(</span>userListenProcessVo<span class="token punctuation">.</span><span class="token function">getAlbumId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     trackStatMqVo<span class="token punctuation">.</span><span class="token function">setTarckId</span><span class="token punctuation">(</span>userListenProcessVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     trackStatMqVo<span class="token punctuation">.</span><span class="token function">setStatType</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">TRACK_STAT_PLAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     trackStatMqVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     kafkaService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_TRACK_STAT_UPDATE</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>trackStatMqVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="在service-album-监听消息" tabindex="-1"><a class="header-anchor" href="#在service-album-监听消息" aria-hidden="true">#</a> 在service-album 监听消息</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrackReceiver</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TrackInfoService</span> trackInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
      * 监听更新统计状态
      * <span class="token keyword">@param</span> <span class="token parameter">consumerRecord</span>
      */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_TRACK_STAT_UPDATE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//  获取发送的数据</span>
      <span class="token class-name">TrackStatMqVo</span> trackStatMqVo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TrackStatMqVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot; 更新声音统计：&quot;</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>trackStatMqVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//  业务去重</span>
      <span class="token class-name">String</span> key <span class="token operator">=</span> trackStatMqVo<span class="token punctuation">.</span><span class="token function">getBusinessNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> isExist <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//  第一次执行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isExist<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//  调用服务层方法</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
 trackInfoService<span class="token punctuation">.</span><span class="token function">updateStat</span><span class="token punctuation">(</span>trackStatMqVo<span class="token punctuation">.</span><span class="token function">getAlbumId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>trackStatMqVo<span class="token punctuation">.</span><span class="token function">getTrackId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>trackStatMqVo<span class="token punctuation">.</span><span class="token function">getStatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>trackStatMqVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="trackinfoservice接口" tabindex="-1"><a class="header-anchor" href="#trackinfoservice接口" aria-hidden="true">#</a> TrackInfoService接口</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 更新统计方法
 * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">statType</span>
 * <span class="token keyword">@param</span> <span class="token parameter">count</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">,</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span><span class="token class-name">Integer</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="trackinfoserviceimpl-实现类" tabindex="-1"><a class="header-anchor" href="#trackinfoserviceimpl-实现类" aria-hidden="true">#</a> TrackInfoServiceImpl 实现类</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">,</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	更新声音播放数据</span>
  trackInfoMapper<span class="token punctuation">.</span><span class="token function">updateStat</span><span class="token punctuation">(</span>trackId<span class="token punctuation">,</span> statType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	更新播放量</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>statType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">TRACK_STAT_PLAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    albumInfoService<span class="token punctuation">.</span><span class="token function">updateStat</span><span class="token punctuation">(</span>albumId<span class="token punctuation">,</span> <span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ALBUM_STAT_PLAY</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="更新声音播放量" tabindex="-1"><a class="header-anchor" href="#更新声音播放量" aria-hidden="true">#</a> 更新声音播放量</h5><h6 id="trackinfomapper-添加方法" tabindex="-1"><a class="header-anchor" href="#trackinfomapper-添加方法" aria-hidden="true">#</a> TrackInfoMapper 添加方法</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
   * 更新评论数据
   * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
   * <span class="token keyword">@param</span> <span class="token parameter">statType</span>
   * <span class="token keyword">@param</span> <span class="token parameter">count</span>
   */</span>
<span class="token class-name">Integer</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;trackId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;statType&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="trackinfomapper-xml-实现" tabindex="-1"><a class="header-anchor" href="#trackinfomapper-xml-实现" aria-hidden="true">#</a> TrackInfoMapper.xml 实现</h6><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--更新统计状态--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateStat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        update track_stat
        set stat_num = stat_num + #{count}
where track_id = #{trackId} and stat_type = #{statType}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="更新专辑的播放量" tabindex="-1"><a class="header-anchor" href="#更新专辑的播放量" aria-hidden="true">#</a> 更新专辑的播放量</h5><h6 id="albuminfoservice-接口" tabindex="-1"><a class="header-anchor" href="#albuminfoservice-接口" aria-hidden="true">#</a> AlbumInfoService 接口</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 更新播放量
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">statType</span>
  * <span class="token keyword">@param</span> <span class="token parameter">count</span>
  */</span>
<span class="token keyword">void</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="albuminfoserviceimpl-实现类" tabindex="-1"><a class="header-anchor" href="#albuminfoserviceimpl-实现类" aria-hidden="true">#</a> AlbumInfoServiceImpl 实现类</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	更新数据</span>
  albumInfoMapper<span class="token punctuation">.</span><span class="token function">updateStat</span><span class="token punctuation">(</span>albumId<span class="token punctuation">,</span> statType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="albuminfomapper接口" tabindex="-1"><a class="header-anchor" href="#albuminfomapper接口" aria-hidden="true">#</a> AlbumInfoMapper接口</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 更新播放量
  * <span class="token keyword">@param</span> <span class="token parameter">albumId</span>
  * <span class="token keyword">@param</span> <span class="token parameter">statType</span>
  * <span class="token keyword">@param</span> <span class="token parameter">count</span>
  */</span>
<span class="token class-name">Integer</span> <span class="token function">updateStat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;albumId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> albumId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;statType&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> statType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="albuminfomapper-xml-实现" tabindex="-1"><a class="header-anchor" href="#albuminfomapper-xml-实现" aria-hidden="true">#</a> AlbumInfoMapper.xml 实现</h6><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateStat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        update album_stat
        set stat_num = stat_num + #{count}
where album_id = #{albumId} and stat_type = #{statType}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="声音统计" tabindex="-1"><a class="header-anchor" href="#声音统计" aria-hidden="true">#</a> 声音统计</h3><p><img src="`+k+`" alt=""></p><p>统计声音需要更新的数据如下，我们将数据封装到一个实体类中便于操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;用户声音统计信息&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrackStatVo</span> <span class="token punctuation">{</span>


   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;播放量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> playStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;订阅量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> collectStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;点赞量&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> praiseStatNum<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;评论数&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> commentStatNum<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="控制器-3" tabindex="-1"><a class="header-anchor" href="#控制器-3" aria-hidden="true">#</a> 控制器</h4><p>在TrackInfoApiController 控制器中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 获取声音统计接口
  * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取声音统计信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getTrackStatVo/{trackId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TrackStatVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTrackStatVo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> trackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	调用服务层方法</span>
  <span class="token class-name">TrackStatVo</span> trackStatVo <span class="token operator">=</span> trackInfoService<span class="token punctuation">.</span><span class="token function">getTrackStatVoByTrackId</span><span class="token punctuation">(</span>trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	返回对象</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>trackStatVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-5" tabindex="-1"><a class="header-anchor" href="#接口-5" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据声音Id 获取统计信息
  * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">TrackStatVo</span> <span class="token function">getTrackStatVoByTrackId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-5" tabindex="-1"><a class="header-anchor" href="#实现类-5" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">TrackStatVo</span> <span class="token function">getTrackStatVoByTrackId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> trackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	<span class="token comment">//	调用mapper 层方法</span>
 	<span class="token keyword">return</span> trackInfoMapper<span class="token punctuation">.</span><span class="token function">selectTrackStat</span><span class="token punctuation">(</span>trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TrackInfoMapper.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据声音Id 获取到声音统计
  * <span class="token keyword">@param</span> <span class="token parameter">trackId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">TrackStatVo</span> <span class="token function">selectTrackStat</span><span class="token punctuation">(</span><span class="token class-name">Long</span> trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TrackInfoMapper.xml</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>  根据声音<span class="token class-name">Id</span>统计声音状态<span class="token punctuation">.</span>  <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectTrackStat&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;com.atguigu.tingshu.vo.album.TrackStatVo&quot;</span><span class="token operator">&gt;</span>
        select
            <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token function">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token char">&#39;0701&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as playStatNum<span class="token punctuation">,</span>
<span class="token function">MAX</span><span class="token punctuation">(</span><span class="token function">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token char">&#39;0702&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as collectStatNum<span class="token punctuation">,</span>
<span class="token function">MAX</span><span class="token punctuation">(</span><span class="token function">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token char">&#39;0703&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as praiseStatNum<span class="token punctuation">,</span>
<span class="token function">MAX</span><span class="token punctuation">(</span><span class="token function">IF</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>statType <span class="token operator">=</span> <span class="token char">&#39;0704&#39;</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>statNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as commentStatNum
        from <span class="token punctuation">(</span>
  select
                     stat<span class="token punctuation">.</span>track_id as trackId<span class="token punctuation">,</span>
  stat<span class="token punctuation">.</span>stat_type as statType<span class="token punctuation">,</span>
  stat<span class="token punctuation">.</span>stat_num as statNum
                 from track_stat stat
                 where track_id <span class="token operator">=</span> #<span class="token punctuation">{</span>trackId<span class="token punctuation">}</span>
<span class="token punctuation">)</span> info
        group by info<span class="token punctuation">.</span>trackId
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,165),m=[d];function v(b,g){return s(),a("div",null,m)}const y=n(r,[["render",v],["__file","第5章 详情介绍.html.vue"]]);export{y as default};
