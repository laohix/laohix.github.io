import{_ as n,o as s,c as a,e as t}from"./app-8007fa1b.js";const p="/assets/tingshu041-59c59c80.png",e="/assets/tingshu042-700398df.png",o="/assets/tingshu043-4f6685b8.png",c="/assets/tingshu044-9c298e66.png",l="/assets/tingshu045-c5b155bc.png",i="/assets/tingshu046-e1c868ea.png",u="/assets/tingshu047-258a7e57.png",k="/assets/tingshu048-5ad8dd15.png",r={},d=t('<h1 id="谷粒随享" tabindex="-1"><a class="header-anchor" href="#谷粒随享" aria-hidden="true">#</a> 谷粒随享</h1><h2 id="微信支付" tabindex="-1"><a class="header-anchor" href="#微信支付" aria-hidden="true">#</a> 微信支付</h2><p>接口文档入口：https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html</p><p><img src="'+p+`" alt=""></p><p>接收前端传递的<strong>支付类型</strong>以及<strong>订单编号</strong></p><p>先在配置文件中添加支付相关信息配置：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token value attr-value">service-payment</span>
<span class="token key attr-name">spring.profiles.active</span><span class="token punctuation">=</span><span class="token value attr-value">dev</span>
<span class="token key attr-name">spring.main.allow-bean-definition-overriding</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">spring.cloud.nacos.discovery.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.130:8848</span>
<span class="token key attr-name">spring.cloud.nacos.config.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.130:8848</span>
<span class="token key attr-name">spring.cloud.nacos.config.prefix</span><span class="token punctuation">=</span><span class="token value attr-value">\${spring.application.name}</span>
<span class="token key attr-name">spring.cloud.nacos.config.file-extension</span><span class="token punctuation">=</span><span class="token value attr-value">yaml</span>
<span class="token key attr-name">wechat.v3pay.appid</span><span class="token punctuation">=</span><span class="token value attr-value">wxcc651fcbab275e33</span>
<span class="token key attr-name">wechat.v3pay.merchantId</span><span class="token punctuation">=</span><span class="token value attr-value">1631833859</span>
<span class="token key attr-name">wechat.v3pay.privateKeyPath</span><span class="token punctuation">=</span><span class="token value attr-value">E:\\\\tingshu\\\\apiclient_key.pem</span>
<span class="token key attr-name">wechat.v3pay.merchantSerialNumber</span><span class="token punctuation">=</span><span class="token value attr-value">4AE80B52EBEAB2B96F68E02510A42801E952E889</span>
<span class="token key attr-name">wechat.v3pay.apiV3key</span><span class="token punctuation">=</span><span class="token value attr-value">84dba6dd51cdaf779e55bcabae564b53</span>
<span class="token key attr-name">wechat.v3pay.notifyUrl</span><span class="token punctuation">=</span><span class="token value attr-value">http://127.0.0.1/api/payment/wxPay/notify</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>apiclient_key.pem 商户API私钥路径 的私钥要放入指定位置，让程序读取！</p><h3 id="控制器" tabindex="-1"><a class="header-anchor" href="#控制器" aria-hidden="true">#</a> 控制器</h3><p>微信支付成功之后，需要返回一个 map 集合来存储数据给页面使用.</p><p>格式如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timeStamp&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 时间戳</span>
result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nonceStr&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 随机字符串</span>
result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;package&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getPackageVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 订单详情扩展字符串</span>
result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;signType&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 签名方式</span>
result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;paySign&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getPaySign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 签名</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 微信支付
  * <span class="token keyword">@param</span> <span class="token parameter">paymentType</span>
  * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;微信下单&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Parameters</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;paymentType&quot;</span><span class="token punctuation">,</span>description <span class="token operator">=</span> <span class="token string">&quot;支付类型：1301-订单 1302-充值&quot;</span><span class="token punctuation">,</span>in <span class="token operator">=</span> <span class="token class-name">ParameterIn</span><span class="token punctuation">.</span><span class="token constant">PATH</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">,</span>description <span class="token operator">=</span> <span class="token string">&quot;订单号&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>in <span class="token operator">=</span> <span class="token class-name">ParameterIn</span><span class="token punctuation">.</span><span class="token constant">PATH</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createJsapi/{paymentType}/{orderNo}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createJsapi</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> paymentType<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  调用微信支付方法</span>
  <span class="token class-name">Map</span> map <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">createJsapi</span><span class="token punctuation">(</span>paymentType<span class="token punctuation">,</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="接口" tabindex="-1"><a class="header-anchor" href="#接口" aria-hidden="true">#</a> 接口</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 微信支付
  * <span class="token keyword">@param</span> <span class="token parameter">paymentType</span>
  * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
  * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">Map</span> <span class="token function">createJsapi</span><span class="token punctuation">(</span><span class="token class-name">String</span> paymentType<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="实现类" tabindex="-1"><a class="header-anchor" href="#实现类" aria-hidden="true">#</a> 实现类</h3><p>微信支付：小程序调起支付需要返回的参数</p><p><img src="`+e+`" alt=""></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RSAAutoCertificateConfig</span> rsaAutoCertificateConfig<span class="token punctuation">;</span>

<span class="token comment">//	支付文档入口：https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html</span>
<span class="token comment">//	对接方式：https://github.com/wechatpay-apiv3/wechatpay-java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">createJsapi</span><span class="token punctuation">(</span><span class="token class-name">String</span> paymentType<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">//	根据业务判断类型：</span>
	    <span class="token comment">//	充值业务不需要判断当前订单是否取消</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paymentType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_TYPE_RECHARGE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    	<span class="token comment">//	查询当前订单状态，如果订单状态已经取消，则不能生成二维码！</span>
	    	<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> orderInfoResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>orderInfoFeignClient<span class="token punctuation">.</span><span class="token function">getOrderInfo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    	<span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderInfoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_CANCEL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	    		<span class="token comment">//	此时订单已取消，不能生成二维码！</span>
	    		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    	<span class="token punctuation">}</span>
	    <span class="token punctuation">}</span>
		<span class="token comment">// 保存支付记录</span>
		<span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> paymentInfoService<span class="token punctuation">.</span><span class="token function">savePaymentInfo</span><span class="token punctuation">(</span>paymentType<span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//	构建service</span>
		<span class="token class-name">JsapiServiceExtension</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsapiServiceExtension<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>rsaAutoCertificateConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">PrepayRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注意在这个包下 com.wechat.pay.java.service.payments.jsapi.model.Amount</span>
		<span class="token class-name">Amount</span> amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		amount<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setAppid</span><span class="token punctuation">(</span>wxPayV3Config<span class="token punctuation">.</span><span class="token function">getAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setMchid</span><span class="token punctuation">(</span>wxPayV3Config<span class="token punctuation">.</span><span class="token function">getMerchantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>wxPayV3Config<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//	获取用户信息</span>
		<span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> userInfoVoResult <span class="token operator">=</span> userInfoFeignClient<span class="token punctuation">.</span><span class="token function">getUserInfoVo</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userInfoVoResult<span class="token punctuation">,</span><span class="token string">&quot;返回用户结果集对象不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">UserInfoVo</span> userInfoVo <span class="token operator">=</span> userInfoVoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userInfoVo<span class="token punctuation">,</span><span class="token string">&quot;用户对象不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> openid <span class="token operator">=</span> userInfoVo<span class="token punctuation">.</span><span class="token function">getWxOpenId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Payer</span> payer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		payer<span class="token punctuation">.</span><span class="token function">setOpenid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		request<span class="token punctuation">.</span><span class="token function">setPayer</span><span class="token punctuation">(</span>payer<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 调用下单方法，得到应答</span>
		<span class="token comment">// response包含了调起支付所需的所有参数，可直接用于前端调起支付</span>
		<span class="token class-name">PrepayWithRequestPaymentResponse</span> response <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">prepayWithRequestPayment</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;微信支付下单返回参数：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timeStamp&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;nonceStr&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;package&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getPackageVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;signType&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getSignType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;paySign&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getPaySign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//	返回数据</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GuiguException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
		e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">GuiguException</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
		e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GuiguException</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span><span class="token string">&quot;微信下单异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：RSAAutoCertificateConfig 对象必须在配置文件中注入到spring 容器中，不要直接使用原生的，否则会报错！</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>payment<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>java<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RSAAutoCertificateConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">&quot;wechat.v3pay&quot;</span><span class="token punctuation">)</span> <span class="token comment">//读取节点</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayV3Config</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 商户号 */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> merchantId<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 商户API私钥路径 */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> privateKeyPath<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 商户证书序列号 */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> merchantSerialNumber<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 商户APIV3密钥 */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> apiV3key<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/** 回调地址 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RSAAutoCertificateConfig</span> <span class="token function">rsaAutoCertificateConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RSAAutoCertificateConfig<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">merchantId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>merchantId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">privateKeyFromPath</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">merchantSerialNumber</span><span class="token punctuation">(</span>merchantSerialNumber<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">apiV3Key</span><span class="token punctuation">(</span>apiV3key<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="保存交易记录" tabindex="-1"><a class="header-anchor" href="#保存交易记录" aria-hidden="true">#</a> 保存交易记录</h3><h4 id="接口-1" tabindex="-1"><a class="header-anchor" href="#接口-1" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 保存交易记录
     * <span class="token keyword">@param</span> <span class="token parameter">paymentType</span>
     * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">PaymentInfo</span> <span class="token function">savePaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> paymentType<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-1" tabindex="-1"><a class="header-anchor" href="#实现类-1" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PaymentInfo</span> <span class="token function">savePaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> paymentType<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  获取到交易记录对象</span>
  <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PaymentInfo</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> paymentInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//  创建对象</span>
    paymentInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  支付信息</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>paymentType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_TYPE_ORDER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//  远程调用获取到订单对象</span>
      <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> orderInfoResult <span class="token operator">=</span> orderInfoFeignClient<span class="token punctuation">.</span><span class="token function">getOrderInfo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>orderInfoResult<span class="token punctuation">,</span><span class="token string">&quot;返回订单对象不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderInfoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//  充值信息</span>
      <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> rechargeInfoResult <span class="token operator">=</span>  rechargeInfoFeignClient<span class="token punctuation">.</span><span class="token function">getRechargeInfo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>rechargeInfoResult<span class="token punctuation">,</span><span class="token string">&quot;返回充值对象不能不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">RechargeInfo</span> rechargeInfo <span class="token operator">=</span> rechargeInfoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">&quot;充值&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      paymentInfo<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getRechargeAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span>paymentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    paymentInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_STATUS_UNPAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> paymentInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="远程调用获取订单对象" tabindex="-1"><a class="header-anchor" href="#远程调用获取订单对象" aria-hidden="true">#</a> 远程调用获取订单对象</h5><p>service-order 订单微服务已经有这个方法了，直接编写一个远程调用即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-order&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">OrderInfoDegradeFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderInfoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 根据订单号获取订单信息
     * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/order/orderInfo/getOrderInfo/{orderNo}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">OrderInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="远程调用获取充值记录信息" tabindex="-1"><a class="header-anchor" href="#远程调用获取充值记录信息" aria-hidden="true">#</a> 远程调用获取充值记录信息</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-account&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">RechargeInfoDegradeFeignClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RechargeInfoFeignClient</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据订单号获取充值信息
     * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;api/account/rechargeInfo/getRechargeInfo/{orderNo}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRechargeInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>熔断类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RechargeInfoDegradeFeignClient</span> <span class="token keyword">implements</span> <span class="token class-name">RechargeInfoFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRechargeInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service-account 微服务控制器中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 根据订单号获取充值信息
 * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;根据订单号获取充值信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getRechargeInfo/{orderNo}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRechargeInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">// 调用服务层方法</span>
   <span class="token class-name">RechargeInfo</span> rechargeInfo <span class="token operator">=</span> rechargeInfoService<span class="token punctuation">.</span><span class="token function">getRechargeInfoByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 返回对象</span>
   <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口与实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RechargeInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 根据订单号获取充值信息
     * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">RechargeInfo</span> <span class="token function">getRechargeInfoByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>account<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>account<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">RechargeInfoMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>account<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">RechargeInfoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>account<span class="token punctuation">.</span></span><span class="token class-name">RechargeInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RechargeInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RechargeInfoService</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> <span class="token class-name">RechargeInfoMapper</span> rechargeInfoMapper<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token class-name">RechargeInfo</span> <span class="token function">getRechargeInfoByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据订单号查询对象</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RechargeInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">RechargeInfo</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询支付状态" tabindex="-1"><a class="header-anchor" href="#查询支付状态" aria-hidden="true">#</a> 查询支付状态</h3><p>页面有个主动查询支付状态的接口，检查用户是否支付成功</p><p>http://127.0.0.1/api/payment/wxPay/queryPayStatus/0d7e74b3a17040adb89dc252e189ed19</p><p><img src="`+o+`" alt=""></p><h4 id="控制器-1" tabindex="-1"><a class="header-anchor" href="#控制器-1" aria-hidden="true">#</a> 控制器</h4><p>思路：</p><ol><li>调用接口查询数据得到Transaction对象{这个对象能够获取到支付状态}</li><li>当这个对象不为空的时候并且支付状态是成功时，则调用更新交易状态方法</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 查询支付状态 https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml
  * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;支付状态查询&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/queryPayStatus/{orderNo}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryPayStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用查询接口 com.wechat.pay.java.service.payments.model.Transaction;</span>
    <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">queryPayStatus</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queryPayStatus: &quot;</span><span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transaction <span class="token operator">&amp;&amp;</span> transaction<span class="token punctuation">.</span><span class="token function">getTradeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Transaction<span class="token punctuation">.</span>TradeStateEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//更改订单状态</span>
      paymentInfoService<span class="token punctuation">.</span><span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-2" tabindex="-1"><a class="header-anchor" href="#接口-2" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 根据orderNo 查询数据
  * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">Transaction</span> <span class="token function">queryPayStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-2" tabindex="-1"><a class="header-anchor" href="#实现类-2" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Transaction</span> <span class="token function">queryPayStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//	构建service</span>
    <span class="token class-name">JsapiServiceExtension</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsapiServiceExtension<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>rsaAutoCertificateConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">QueryOrderByOutTradeNoRequest</span> queryRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryOrderByOutTradeNoRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryRequest<span class="token punctuation">.</span><span class="token function">setMchid</span><span class="token punctuation">(</span>wxPayV3Config<span class="token punctuation">.</span><span class="token function">getMerchantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryRequest<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Transaction</span> result <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">queryOrderByOutTradeNo</span><span class="token punctuation">(</span>queryRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Transaction:\\t&quot;</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result <span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// API返回失败, 例如ORDER_NOT_EXISTS</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;code=[%s], message=[%s]\\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;reponse body=[%s]\\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="更新状态接口" tabindex="-1"><a class="header-anchor" href="#更新状态接口" aria-hidden="true">#</a> 更新状态接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *	更改订单状态
 * <span class="token keyword">@param</span> <span class="token parameter">transaction</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="更新状态实现类" tabindex="-1"><a class="header-anchor" href="#更新状态实现类" aria-hidden="true">#</a> 更新状态实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">PaymentInfo</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>paymentInfo<span class="token punctuation">.</span><span class="token function">getPaymentStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_STATUS_PAID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//更新支付信息</span>
  paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentStatus</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_STATUS_PAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paymentInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paymentInfo<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>transaction<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paymentInfo<span class="token punctuation">.</span><span class="token function">setCallbackTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  paymentInfo<span class="token punctuation">.</span><span class="token function">setCallbackContent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 表示交易成功！</span>

  <span class="token comment">// 后续更新订单状态！ 使用消息队列！</span>
  <span class="token class-name">String</span> topic <span class="token operator">=</span> paymentInfo<span class="token punctuation">.</span><span class="token function">getPaymentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_TYPE_ORDER</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ORDER_PAY_SUCCESS</span> <span class="token operator">:</span> <span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_RECHARGE_PAY_SUCCESS</span><span class="token punctuation">;</span>
  <span class="token comment">//rabbitService.sendMessage(MqConstant.EXCHANGE_PAYMENT, routingKey, paymentInfo.getOrderNo());</span>
  kafkaService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> paymentInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="监听信息修改订单状态" tabindex="-1"><a class="header-anchor" href="#监听信息修改订单状态" aria-hidden="true">#</a> 监听信息修改订单状态</h4><p>监听支付发送的消息，充值状态监听消息，在后面的充值业务中体现</p><p>在这个OrderReceiver类中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>order<span class="token punctuation">.</span>receiver</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constant<span class="token punctuation">.</span></span><span class="token class-name">KafkaConstant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderInfoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">KafkaListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> atguigu-mqx
 * @ClassName OrderReceiver
 * <span class="token keyword">@description</span>: TODO
 * <span class="token keyword">@date</span> 2023年08月31日
 * <span class="token keyword">@version</span>: 1.0
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderReceiver</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderInfoService</span> orderInfoService<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 订单支付成功通知
     * <span class="token keyword">@param</span> <span class="token parameter">record</span>
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_ORDER_PAY_SUCCESS</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">orderPaySuccess</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//  获取数据</span>
        <span class="token class-name">String</span> orderNo <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 修改订单状态</span>
            orderInfoService<span class="token punctuation">.</span><span class="token function">orderPaySuccess</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="支付异步回调" tabindex="-1"><a class="header-anchor" href="#支付异步回调" aria-hidden="true">#</a> 支付异步回调</h3><p>控制器：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//  https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml</span>
<span class="token doc-comment comment">/**
  * 异步回调
  * <span class="token keyword">@param</span> <span class="token parameter">request</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;微信支付异步通知接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/notify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//  调用方法</span>
    wxPayService<span class="token punctuation">.</span><span class="token function">wxnotify</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回成功</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//返回失败</span>
  result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">wxnotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>实现类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wxnotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//1.回调通知的验签与解密</span>
  <span class="token comment">//从request头信息获取参数</span>
  <span class="token comment">//HTTP 头 Wechatpay-Signature</span>
  <span class="token comment">// HTTP 头 Wechatpay-Nonce</span>
  <span class="token comment">//HTTP 头 Wechatpay-Timestamp</span>
  <span class="token comment">//HTTP 头 Wechatpay-Serial</span>
  <span class="token comment">//HTTP 头 Wechatpay-Signature-Type</span>
  <span class="token comment">//HTTP 请求体 body。切记使用原始报文，不要用 JSON 对象序列化后的字符串，避免验签的 body 和原文不一致。</span>
  <span class="token class-name">String</span> wechatPaySerial <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Serial&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> nonce <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Nonce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> signature <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Signature&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用工具类来获取请求体数据</span>
  <span class="token class-name">String</span> requestBody <span class="token operator">=</span> <span class="token class-name">PayUtils</span><span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//2.构造 RequestParam</span>
  <span class="token class-name">RequestParam</span> requestParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestParam<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">serialNumber</span><span class="token punctuation">(</span>wechatPaySerial<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">nonce</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//3.初始化 NotificationParser</span>
  <span class="token class-name">NotificationParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotificationParser</span><span class="token punctuation">(</span>rsaAutoCertificateConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//4.以支付通知回调为例，验签、解密并转换成 Transaction</span>
  <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>requestParam<span class="token punctuation">,</span> <span class="token class-name">Transaction</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;成功解析：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> transaction <span class="token operator">&amp;&amp;</span> transaction<span class="token punctuation">.</span><span class="token function">getTradeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Transaction<span class="token punctuation">.</span>TradeStateEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 5.处理支付业务</span>
    paymentInfoService<span class="token punctuation">.</span><span class="token function">updatePaymentStatus</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="充值业务" tabindex="-1"><a class="header-anchor" href="#充值业务" aria-hidden="true">#</a> 充值业务</h2><h3 id="业务分析" tabindex="-1"><a class="header-anchor" href="#业务分析" aria-hidden="true">#</a> 业务分析</h3><p>点击我的----&gt;我的钱包</p><p><img src="`+c+`" alt=""></p><p>http://127.0.0.1/api/account/rechargeInfo/submitRecharge</p><p>在service-account 模块中添加控制器</p><h4 id="控制器-2" tabindex="-1"><a class="header-anchor" href="#控制器-2" aria-hidden="true">#</a> 控制器</h4><p>充值时，将前端页面数据封装到 RechargeInfoVo 对象中，充值成功之后保存orderNo 到map 集合中并将map 放入result类中返回</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>vo<span class="token punctuation">.</span>account</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>oas<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;充值对象&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RechargeInfoVo</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;充值金额&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;支付方式：1101-微信 1102-支付宝&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> payWay<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RechargeInfoApiController</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 给用户充值
  * <span class="token keyword">@param</span> <span class="token parameter">rechargeInfoVo</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;充值&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;submitRecharge&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">submitRecharge</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RechargeInfoVo</span> rechargeInfoVo<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//	获取到用户Id</span>
  <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	调用充值方法</span>
  <span class="token class-name">String</span> orderNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rechargeInfoService<span class="token punctuation">.</span><span class="token function">submitRecharge</span><span class="token punctuation">(</span>rechargeInfoVo<span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	创建map 集合对象</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	存储订单Id</span>
  map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">,</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	返回数据</span>
  <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-3" tabindex="-1"><a class="header-anchor" href="#接口-3" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 用户充值接口
  * <span class="token keyword">@param</span> <span class="token parameter">rechargeInfoVo</span>
  * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
  * <span class="token keyword">@return</span>
  */</span>
<span class="token class-name">String</span> <span class="token function">submitRecharge</span><span class="token punctuation">(</span><span class="token class-name">RechargeInfoVo</span> rechargeInfoVo<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-3" tabindex="-1"><a class="header-anchor" href="#实现类-3" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">submitRecharge</span><span class="token punctuation">(</span><span class="token class-name">RechargeInfoVo</span> rechargeInfoVo<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//	创建对象</span>
  <span class="token class-name">RechargeInfo</span> rechargeInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RechargeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	赋值操作</span>
  rechargeInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rechargeInfo<span class="token punctuation">.</span><span class="token function">setRechargeStatus</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_UNPAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rechargeInfo<span class="token punctuation">.</span><span class="token function">setRechargeAmount</span><span class="token punctuation">(</span>rechargeInfoVo<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rechargeInfo<span class="token punctuation">.</span><span class="token function">setPayWay</span><span class="token punctuation">(</span>rechargeInfoVo<span class="token punctuation">.</span><span class="token function">getPayWay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rechargeInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	插入数据库</span>
  rechargeInfoMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//	返回订单编号</span>
  <span class="token keyword">return</span> rechargeInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="充值成功业务处理" tabindex="-1"><a class="header-anchor" href="#充值成功业务处理" aria-hidden="true">#</a> 充值成功业务处理</h3><p>在支付成功之后，会在updatePaymentStatus方法中发送充值成功消息。所以我们要在在service-account 模块添加监听器中</p><h4 id="监听信息修改充值状态" tabindex="-1"><a class="header-anchor" href="#监听信息修改充值状态" aria-hidden="true">#</a> 监听信息修改充值状态</h4><p>在这个AccountReceiver类中添加数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 充值成功通知
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 */</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token class-name">KafkaConstant</span><span class="token punctuation">.</span><span class="token constant">QUEUE_RECHARGE_PAY_SUCCESS</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rechargePaySuccess</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> orderNo <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;充值成功通知: {}&quot;</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通知更新用户账号</span>
    rechargeInfoService<span class="token punctuation">.</span><span class="token function">rechargePaySuccess</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口与实现" tabindex="-1"><a class="header-anchor" href="#接口与实现" aria-hidden="true">#</a> 接口与实现</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 充值成功
 * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">rechargePaySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rechargePaySuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取到充值信息对象</span>
   <span class="token class-name">RechargeInfo</span> rechargeInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRechargeInfoByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 如果当前状态是已支付，则直接返回</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_PAID</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getRechargeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token comment">// 否则赋值为已支付状态</span>
   rechargeInfo<span class="token punctuation">.</span><span class="token function">setRechargeStatus</span><span class="token punctuation">(</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ORDER_STATUS_PAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 更新数据</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 更新余额</span>
  userAccountService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getRechargeAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rechargeInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">SystemConstant</span><span class="token punctuation">.</span><span class="token constant">ACCOUNT_TRADE_TYPE_DEPOSIT</span><span class="token punctuation">,</span><span class="token string">&quot;充值&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新增 user_account 与 user_account_detail 表数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 充值
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">amount</span>
 * <span class="token keyword">@param</span> <span class="token parameter">orderNo</span>
 * <span class="token keyword">@param</span> <span class="token parameter">tradeType</span>
 * <span class="token keyword">@param</span> <span class="token parameter">title</span>
 */</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">String</span> tradeType<span class="token punctuation">,</span> <span class="token class-name">String</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">,</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">String</span> tradeType<span class="token punctuation">,</span> <span class="token class-name">String</span> title<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 查看是否有当前对象</span>
   <span class="token keyword">long</span> count <span class="token operator">=</span> userAccountDetailMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">UserAccountDetail</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token comment">//添加账号金额</span>
   userAccountMapper<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//添加账户明细</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> title<span class="token punctuation">,</span> tradeType<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountMapper.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 充值
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">amount</span>
 */</span>
<span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">)</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountMapper.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   update user_account
   set total_amount = total_amount + #{amount}, available_amount = available_amount + #{amount}, total_income_amount = total_income_amount + #{amount}
   where user_id = #{userId}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="充值记录" tabindex="-1"><a class="header-anchor" href="#充值记录" aria-hidden="true">#</a> 充值记录</h3><p><img src="`+l+`" alt=""></p><p>http://127.0.0.1/api/account/userAccount/findUserRechargePage/1/10</p><h4 id="控制器-3" tabindex="-1"><a class="header-anchor" href="#控制器-3" aria-hidden="true">#</a> 控制器</h4><p>用户充值记录回显信息保存到实体类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>account</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>tingshu<span class="token punctuation">.</span>model<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">BaseEntity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>oas<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span>media<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;UserAccountDetail&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">&quot;user_account_detail&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAccountDetail</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;用户id&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;交易标题&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;交易类型：1201-充值 1202-锁定 1203-解锁 1204-消费&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;trade_type&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> tradeType<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;金额&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">&quot;订单编号&quot;</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span><span class="token string">&quot;order_no&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在service-account 微服务 UserAccountApiController 控制器添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 用户充值记录
 * <span class="token keyword">@param</span> <span class="token parameter">page</span>
 * <span class="token keyword">@param</span> <span class="token parameter">limit</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取用户充值记录&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findUserRechargePage/{page}/{limit}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findUserRechargePage</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;当前页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> page<span class="token punctuation">,</span>

      <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;limit&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;每页记录数&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取到用户Id</span>
   <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 构建Page对象</span>
   <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 调用服务层方法</span>
   <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageModel <span class="token operator">=</span> userAccountService<span class="token punctuation">.</span><span class="token function">findUserRechargePage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 返回数据</span>
   <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-4" tabindex="-1"><a class="header-anchor" href="#接口-4" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 查看用户充值记录
 * <span class="token keyword">@param</span> <span class="token parameter">pageParam</span>
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserRechargePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-4" tabindex="-1"><a class="header-anchor" href="#实现类-4" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserRechargePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 调用mapper 方法</span>
   <span class="token keyword">return</span> userAccountDetailMapper<span class="token punctuation">.</span><span class="token function">selectUserRechargePage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountDetailMapper.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserAccountDetailMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     *
     * <span class="token keyword">@param</span> <span class="token parameter">pageParam</span>
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectUserRechargePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountDetailMapper.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--
   充值记录类型 固定1201
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectUserRechargePage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>RechargeInfoMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   select <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>columns<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   from user_account_detail
   where user_id = #{userId} and trade_type = &#39;1201&#39;
   and is_deleted = 0
   order by id desc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="消费记录" tabindex="-1"><a class="header-anchor" href="#消费记录" aria-hidden="true">#</a> 消费记录</h3><p><img src="`+i+`" alt=""></p><p>消费记录</p><p>http://127.0.0.1/api/account/userAccount/findUserConsumePage/1/10</p><h4 id="控制器-4" tabindex="-1"><a class="header-anchor" href="#控制器-4" aria-hidden="true">#</a> 控制器</h4><p>返回消费记录的时候，也是将数据封装到 UserAccountDetail 对象中！</p><p>在service-account 微服务中添加</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;获取用户消费记录&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findUserConsumePage/{page}/{limit}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findUserConsumePage</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;当前页码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> page<span class="token punctuation">,</span>

      <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;limit&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;每页记录数&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 获取到用户Id</span>
   <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageModel <span class="token operator">=</span> userAccountService<span class="token punctuation">.</span><span class="token function">findUserConsumePage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>pageModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="接口-5" tabindex="-1"><a class="header-anchor" href="#接口-5" aria-hidden="true">#</a> 接口</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费记录
 * <span class="token keyword">@param</span> <span class="token parameter">pageParam</span>
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserConsumePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现类-5" tabindex="-1"><a class="header-anchor" href="#实现类-5" aria-hidden="true">#</a> 实现类</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUserConsumePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 调用mapper 层方法</span>
   <span class="token keyword">return</span> userAccountDetailMapper<span class="token punctuation">.</span><span class="token function">selectUserConsumePage</span><span class="token punctuation">(</span>pageParam<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountDetailMapper.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 消费记录
 * <span class="token keyword">@param</span> <span class="token parameter">pageParam</span>
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@return</span>
 */</span>
<span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectUserConsumePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> pageParam<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserAccountDetailMapper.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectUserConsumePage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>RechargeInfoMap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   select <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>columns<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   from user_account_detail
   where user_id = #{userId} and trade_type = &#39;1204&#39;
   and is_deleted = 0
   order by id desc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：充值一百元之后，查看余额与</p><p><img src="`+u+'" alt=""></p><p>充值记录：</p><p><img src="'+k+`" alt=""></p><p>总结：</p><p>​ 优化将查询充值记录与消费记录合并：</p><p>http://127.0.0.1/api/account/userAccount/findUserConsumePage/1/10/1201</p><p>http://127.0.0.1/api/account/userAccount/findUserConsumePage/1/10/1204</p><p>控制器：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@GuiGuLogin</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;查看消费记录&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findUserConsumePage/{page}/{limit}/{tradeType}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findUserConsumePage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> page<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> limit<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> tradeType<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">// 获取用户Id</span>
   <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">AuthContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 创建Page 对象</span>
   <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> userAccountDetailPage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 调用服务层方法.</span>
   <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserAccountDetail</span><span class="token punctuation">&gt;</span></span> iPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userAccountService<span class="token punctuation">.</span><span class="token function">findUserConsumePage</span><span class="token punctuation">(</span>userAccountDetailPage<span class="token punctuation">,</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 返回数据</span>
   <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>iPage<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_account_detail uad <span class="token keyword">where</span> uad<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token number">19</span> <span class="token operator">and</span> uad<span class="token punctuation">.</span>trade_type <span class="token operator">=</span> ? <span class="token operator">and</span> is_deleted <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">order</span> <span class="token keyword">by</span> uad<span class="token punctuation">.</span>id <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,140),m=[d];function v(b,g){return s(),a("div",null,m)}const y=n(r,[["render",v],["__file","第8章 支付.html.vue"]]);export{y as default};
