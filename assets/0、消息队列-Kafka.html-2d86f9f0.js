import{_ as o,r as c,o as i,c as l,a as n,b as t,w as p,d as s,e}from"./app-8007fa1b.js";const u="/assets/2023-10-12_14-44-17-935b6f74.png",r="/assets/2023-10-12_14-48-21-28c64826.png",k="/assets/2023-10-12_14-45-21-b464f135.png",d="/assets/image-20230606195328011-8c9e3ab3.png",m="/assets/2023-10-12_14-51-15-a9494999.png",v="/assets/image-20230804170122667-b54fd5c0.png",g="/assets/image-20230609180142754-2776e9d2.png",b="/assets/image-20230609203907844-fa6efc4c.png",f="/assets/server.properties-3778bb69.jpg",h="/assets/image-20230804153319649-c0ba64ba.png",y="/assets/image-20230804153457067-35031a2f.png",_="/assets/image-20230808153411878-a2d0a2e6.png",w="/assets/image-20230609204453523-f6e02de5.png",q="/assets/image-20230804160500636-96cd33e0.png",S="/assets/image-20230804161515068-031c180f.png",x="/assets/image-20230804162815260-3c25d3ae.png",P="/assets/image-20230804163106533-1791c583.png",C="/assets/image-20230804163335828-49f7e124.png",K="/assets/2023-10-12_14-55-33-ed20e776.png",I="/assets/image-20230819212740880-6c656855.png",T="/assets/image-20230819212959269-fccf4259.png",E="/assets/image-20230819213209251-ec41db80.png",z="/assets/image-20230819213456271-9aa7eee8.png",R="/assets/image-20230908221625515-1e390f9d.png",A="/assets/image-20230819214225116-71b444cb.png",j="/assets/image-20230618160300739-973c4ea0.png",O="/assets/image-20230816105127132-4eb73bed.png",N="/assets/image-20230804171551073-758e39ac.png",L="/assets/image-20230816104740315-559fc235.png",M="/assets/image-20230804171822562-67671ad1.png",B="/assets/image-20230804171959421-6ffb0c8f.png",D="/assets/image-20230908223104808-ce6fab42.png",G="/assets/image-20230804172203509-77e452b1.png",F="/assets/image-20230804172338214-6faf977d.png",U="/assets/image-20230604192924364-af8c3f17.png",V="/assets/image-20230820154852175-b8f33f8c.png",H="/assets/image-20230820155854728-6fbc94cf.png",Q="/assets/image-20230820160230983-32c0c7dc.png",Z="/assets/image-20230820160456932-4f1e21dd.png",Y="/assets/image-20230820160740347-2dd84d83.png",X="/assets/image-20230820160915323-ccb54750.png",W="/assets/image-20230820161523091-cd55ee6c.png",J="/assets/image-20230818223919146-6ae082c6.png",$="/assets/image-20230820164318852-59e82fa7.png",nn="/assets/image-20230820164536274-0abef9b9.png",sn="/assets/image-20230820164813876-06e674a2.png",an="/assets/image-20230625192719254-0d88a388.png",tn="/assets/image-20230625194330933-be835159.png",pn="/assets/image-20230625194537473-fad241b0.png",en="/assets/image-20230625195715792-9d3a2093.png",on="/assets/image-20230625195938075-572e7d51.png",cn="/assets/image-20230625201515206-9947a556.png",ln="/assets/image-20230625201742134-0b4527e0.png",un="/assets/image-20230625202302790-a743e5d0.png",rn="/assets/image-20230625202356808-b3ed0ff5.png",kn="/assets/image-20230605205316992-af329865.png",dn="/assets/image-20230809174016338-a52d4776.png",mn="/assets/image-20230624201927263-f1854feb.png",vn="/assets/image-20230908221625515-1e390f9d.png",gn="/assets/image-20230618172112600-76d56ef7.png",bn="/assets/image-20230618172948921-8870288e.png",fn="/assets/image-20230618174131714-1bbab265.png",hn="/assets/image-20230618174216958-f2327b8a.png",yn="/assets/image-20230618174028329-de8616fc.png",_n="/assets/image-20230618182243962-6323ea17.png",wn="/assets/image-20230618094421625-df6afd7a.png",qn="/assets/image-20230618093627180-e81f1460.png",Sn="/assets/image-20230619205607970-4b40743b.png",xn="/assets/image-20230619205910433-3f77df15.png",Pn="/assets/image-20230619205947191-0e000dd5.png",Cn="/assets/1089984-20190827171146743-496360203-e738308b.jpg",Kn="/assets/image-20211217110322026-d521ed97.png",In="/assets/image-20211217110358983-9afb7547.png",Tn="/assets/image-20230619212042741-cf60dd14.png",En="/assets/image-20230811105100769-d2ca7496.png",zn="/assets/image-20230619212251944-ce350612.png",Rn="/assets/wps4-5efecb62.jpg",An="/assets/image-20230811165306451-c1085872.png",jn="/assets/image-20230817122751774-0d8ffb6b.png",On="/assets/image-20230817123137094-304b7a45.png",Nn="/assets/image-20230817123223762-0af592f4.png",Ln="/assets/image-20230816191642209-e04e4c09.png",Mn="/assets/image-20230817123413354-5f8981d8.png",Bn="/assets/image-20230817123457939-694d09ce.png",Dn="/assets/image-20230623211045190-695c5940.png",Gn="/assets/image-20230625210331393-3c53c975.png",Fn="/assets/image-20230910164309000-159a9b03.png",Un="/assets/image-20230625213505026-c241d214.png",Vn="/assets/image-20230625215424568-49093da6.png",Hn="/assets/image-20230625221400542-3d384aad.png",Qn="/assets/image-20230625223106680-821c7fd9.png",Zn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA3cAAAAsCAYAAADGkkG/AAAPBUlEQVR4nO2dPZKqThfGH976L+VqmcwCYAdaN5jE2AxipyY1Mp3CWDNjE4Mp2AEuwMSCu5d+Az+mbRtosFFknl8Vde9A01/ndHNOnwYhKgJAwA1Pf0XCB47nAOFH59O+cKXzrh+KNA1P53wRqZle0rsiTHMKTiMRuu4lT8AVrh+Jm+RpJHz3p2y4vojOiSJfuv9Yj8g/1TFMhbjUcWCYTmpLUbk5Zef2X4V+SUOpr11fhKkQoavPL72Sy6n/pHzPbdQeUmam6dLQFW4YidB3pTq6IoxyGpPX3qu+K6rLqV8jX8CPbtrrq+VWSZfTXlnnjeWbm59GzmV6depnNS9XpzCG4zJXvpdx/1OusXzTUGmHK/zwWkFNy+0cJvNfyf1PHR/G1TSYN544jky5jDdbz0HDdlgvV6jpc/TPUA8qjV9DedyUGaY//XD1rDF8DhrbEU+YryzrcyP1ox40rweXsXp73NiIxlmW9EuFebeafMv7TwhFvpf6Xet9U3ZnmV1s2o7G+6VA73U4QggBQrpEHMDZvkMsh3bSEdIlOD5IFagHBKAekIey8DxgnWDae3ZNXpP/nl0BQgghhBBCCMniAB8YI6VjV5v/PbsChNgkDhw4oxWwGsFxHDhBfFc6QroExwepAvWAANQD0jBxcNSr09GfA9F6Cvp29eG2TEIIIYQQQgjpAIzcEUIIIYQQQkgHoHNHCCGEEEIIIR2Azh0hhBBCCCGEdAA6d4QQQgghhBDSAejcEUIIIYQQQkgHoHNHCCG/BMdxnnKvrTzy7i/Lt+5999SpCc5lPVKOTfYducZmn1LOz+MZ4/Te+03TUx9eAzp3hBDSIdSHrw2jzXEc1PnVnLpOV951IYRV48I0v7YZNLb7QcWmoS//flXe8Vu51/i/tx8p52ZpepwC7ZubSDv479kVIIQQYo+zQXF2xtS/TTFxEu/9mdSyupnU/d7rNur5DJqsi66997S/TD6kHqp86txPOTdLm+YME5qY58njebnI3cJz4C2yZ1eDEEJeFlMDTgiRe1QtI69MU8NBXv1XowFVIgO6aEKbIgxlkY+iiIjNqIkqF52cTMtgNKc5dH1YxUGjnOvRlnFatc555+XFwPO/8lzfRRl2mZdz7tpOtgjgyYPVCxBn52ve6dziuZVsgIV3bC8db0Keg/zwLTPYqjpUdY0QE4OnLD+dsVF0Ti1fNU7K8iiKIj6KIoe6qL5FaU2d2TJD9fy3rqyq7XlUn2bxAoHnwAni4nQL7/L89oIFmnyalS1U3Gvwl42zTsr5gfIDnjtOq1LF4X8WtsepbX0wyS8OTna+4yF4oj38cs7dNBFIpr36GcTB1WA5OyNn5+QuByVbYPIBzFJpQCdLDE/V7U0TiDSEW7/2SnGedvJ+xKSmMk0E0tBWyx6EogvyUTK35JMt4HXQec/lt7W3xeS931FmwJXlWddYMzV4mjL+1Pbqrt+7re2VyJNDWTrdv2VUdeobi1xkC3ieh+/DAJ8zvySphwnWSE7tXw82mDRsnFV1CkxQHTI1X7Xs8/91/5qU1Qo54znyawLTcVqFIscuTxZNyuqGBsapbX0wyi8OMMcYqRAQYo3BZoJnqeDLOXd3M1weHSw3hBA/juJ0HcKFCz+6w3n8d8DOHVycuabpTROIyAf86GoSWA8OmNDgLme4vPRZGrpww/Ty93L47MoRch/yQ7muwVgn0paXTxUDxcaKdVHEQVcfnXNcZqDajrZUpalyTPsnjyInvuywSm+KJEkwnQ5R/FjO8PXxhpn07O9N1xhvvlB3na+IpqIo53xN5dQZOT9YflVpej4omnvq6lpTi25arI9T2/rQbv3SYd25i4OTggWxskXRQxDXdWFjBJpomy2yOIDT32CcJtdGfRYj8LzrNizi26hYtjimGa2A3UelCNClvxxpu6ZpuTn0pkuMsflZMZAiVEF8DH17edsos/gYFr/U6Wdbqdpn1/W7XcG4ahPkSKOnWc3IsAjkSKSHYBHcRIXi4Dpa6QULZGpeVdpbhtwOuc03/XLS0f4HdooOOE5wMwHYb4ed/jMfv9Xaa6RXNuX2Slz0SjcuqmH7YWzTOKviKOrKqetUqcZN2b15TnFen+T10z08w1GUy86r/9nwr+pAlB1PJ/vG3n/H9ZpeD4O3FbYNWG9NGc1VF1A6I+cHy+9MW/Q4b+4pc+x015taeLCCqZxt64NpfsMlZtig7zhwnAkO4zXu2Wh4D9adu+FSHKNJqxEmmwHWly2Ka7xvJzWNtCGWUoTFJtnCQ38ORGlyK4TeH3yuk0sYVogE74cR+qrH1pse00Q+cIoImkaA/gxcuG54DOMm02rl5rfq+s9ThCrygf3cw2QLrBMBIVKM5bBxtoA32eJ9LU0U63dsJ9dGZ7bwMJlLsk3XGBwmmGyUMpUtqL1pAiEEbkUYI3D62Axmp3D2SV+wx05u1cLDHHIagfU7MJkozoRpe024tGMDb/6z5TYd7zHqB1JPn3RUigr/HMurScF+O+z1n/n4NW+vqV5ZldsvR+fQ1DFEbBhqcl3ucYLqOFU6Q0V3v/r/Z9NchMOs7DN5/SdjYgwWya0V/DtczZVNUjamHuUcdUrOD5SfTOv0WMFEXjpaseCiw1TOtvWhQn7DZXKx25d/gfi8SF77XZ96NPhTCD7WyVQKsfYwXM6wdb6QTZclodfHEAceRivAjz5ztlL20FPODz9DuJMDgHv37WWIgwnmmCFJ1LzuKzdbfOHjbQaha9N4LW077WGaJJdL8dcG43Vy3Re9IZazLZyvGNPlEJfwtJBk2+thulwDXh+yf2dKtphjH6bKdtgehtMEYnpJha/NG9bJddi+N5wiQQBvkWGoWyIpaG8ldsA4ld+fXCPcTPCdoeLKjP12NNN/9savmV6Zt7dzDJdIxLLRInQPcZMHeNmqb9U62FoVlqMKZQaKGokzqWdbUSMqVetqco8q16r9VzVP03vbLJcqFOmrrTFioieUc3M8Ypw2SZ16d0l+95BlMb6/5tisdtjBheuPMUtTDFWjvmGae+fOf9cYgEMM3D2+27ACv/s4RjHSGTDv50QU1a1uDpzJxsKKwAaB18d8sEaiDe1VLHc1uko7ObwjzQkZvg3yFCzGdvUG7eXhO/zV9hjdyb6xdwcaF7OHwVteBYv5d9gV1OtE9o39bnUKdyvHaIXd4Z/2ttJ8TXHHihNXM98G2tFI/1kbv4Z6pWBNbr8IWaY2HrC6lfui63l1qrotqApF28ZaGyVqOaaRlyoGYOsjd09GjW4/InJCORMVnR5SdubEgYN+f47DYHza5ZUgWU4f7tgBv/GDKmfcEMlyiF5viGUS4e1D3faVYeH1sVG2sYnZ+P6vXe4AvLmA1pCvUa7yQZVkWfZS6oty3r6qO17pCyjPakdX+o9oKTKi7tmWKeevu6+KISrnUddwUO8zcfC6hGp0FfV/3S19to26oq2HZTzEOfgzgLs/GCd/9jtWgNnPnTS9uKLL7ylybqH8HjFO61BUxr0Lba0ZpxX1wVZ+w+VpO+Z0ij/fgfSzCY//7Epzzt1qq/kASIzD7g1/W+d5DLGM3vAxkT4+kX1jg/DWUfpjoTh3jOUywQyj2324TZZbyBDvfs7LpvEWq/PLpL2/eNsdNNGWDIe9STkxDkoI8s/AxarsLdfeX4yxaUfU9x4aaEcj/Wdt/BrqFWkUnUOfR1XHr8jpuzcSYJqnyX1yHU22cxblVYfLB6UMH/R55VQxEmV5191mdf6/LpJrEmXS6Z2pLsptapTeX7xBfa5l2K58vDc8Qen61jR6VyQDU/l0Qs5Pll+V8+drtsapLl8b6BbRHlV2LqZytq0PVfPLFlffLJhhVP/ntWpSz7kz+bqbu8fEk7/ElyEO5kCkeV/H4tfiauc3/ESIjx8B9AZ4222wuHzSLzu+GNn/sPai5nCZItyPrreEPqDc3Pp8htjPla8YZjGC+R7h51mDe/gM95jLss0yLLwJNmps8dyW84+4xwt4zggrpdzedAZ/Nbr+GmN2ardzrk8P09kbPvqe1DfAsX+8h7+sWojUZmTZ6QuV54+v2G9HI/1XZfwWttdUr34xtue/BjE1Osqcp7rGa16euvPqNlUbq8r3GF7fmx0At1Dny7ZFyW3R9Z9qVNdFLuPe6I4uYlwnitwsPSxnwFYagNlign34qV18shWhKOpb0zGiS2u6zbM7cn6s/NoyTuXy2jLPNYupnKvpQ/kzuGJ+bUDUIfKFCwjAFWGqvw4/Eukl3TGtH+kSl+cX+ec8NIcfVcsv8q/ud6UEaegez7uhks8prR+KNA1P53wR5eQJqc1y+Tf5i0j4UvpLUwzLveSX057S/rvUQyKNhO/KaXyhE9uNbMP0pz6STNJQSuf6IkyFCF2lvadyQ9e96jvXj8RN0Wmo1M8VfnitA8btzZXbtSx+zp/7PkduOX3j+pFI1YbYbIfl/qs6fs3aW65XldrbJcrm04qo03re37rpP+9c3lG1Xrq65OWTl7bsMGlPUf1M61N2/orz/K17XhnmVSSbMqrogC5vU50yoa7ZUYvLc7NgjpeI/J851C2QlY02mOZRZXxUSS+ff3k5n3iU/No2Touumczb8rky/WlErg2NU9N0ps9g4/zEte1blrYJHCEacM/jAM72ne/xEPKKcPx2iqKtVo8o+0xReWWROZv1sV2GUZ5xAGe0R6j7yR2DfOpeK7pedB64lYUcRTXJr06k5hE6+Wzq6Lp6T1WZ6q5TzvVoyzi1SZnMH1kXYocGfwqBEELIs9E9jB/1gDYtp231sZ1nvF0BflT4sylF+dS9VnS97nnT+2gE6qnTL6Z9W0UXKOd6tGWc2qRM5o+sC7GD9chdHDgYyS9V+REjAIS8CBy/hBBCCCGvSzPbMgkhhBBCCCGEPJTf+zt3hBBCCCGEENIh6NwRQgghhBBCSAegc0cIIYQQQgghHYDOHSGEEEIIIYR0ADp3hBBCCCGEENIB6NwRQgghhBBCSAegc0cIIYQQQgghHYDOHSGEEEIIIYR0ADp3hBBCCCGEENIB6NwRQgghhBBCSAegc0cIIYQQQgghHYDOHSGEEEIIIYR0ADp3hBBCCCGEENIB6NwRQgghhBBCSAegc0cIIYQQQgghHeD/PMitGCj1G0QAAAAASUVORK5CYII=",Yn="/assets/image-20230910171101193-c9dab40d.png",Xn="/assets/image-20230619204352039-6ac86880.png",Wn="/assets/image-20230626213637222-e5787a99.png",Jn="/assets/image-20230629203614581-3682da2e.png",$n="/assets/image-20230910231610065-efbb4b43.png",ns="/assets/image-20230629211709251-dd1bec94.png",ss="/assets/image-20230702170108082-645dda31.png",as="/assets/image-20230702191014703-506b45e6.png",ts="/assets/image-20230819182844092-4c94b94d.png",ps="/assets/image-20230819201901436-3daa5b0b.png",es="/assets/image-20230702211127738-75374191.png",os={},cs=e('<h1 id="_1-kafka简介" tabindex="-1"><a class="header-anchor" href="#_1-kafka简介" aria-hidden="true">#</a> 1. Kafka简介</h1><h2 id="_1-1-开发中遇到的问题" tabindex="-1"><a class="header-anchor" href="#_1-1-开发中遇到的问题" aria-hidden="true">#</a> 1.1 开发中遇到的问题</h2><ul><li>非必要的业务逻辑以同步(串行)的方式运行，太耗费时间</li></ul><p><img src="'+u+'" alt="kafka-tongbu"></p><ul><li>系统间耦合性太强</li></ul><p><img src="'+r+'" alt="kafka-jieouhe"></p><ul><li>流量激增导致宕机</li></ul><p><img src="'+k+'" alt="kafka-xuefengtiangu"></p><h2 id="_1-2-消息队列message-queue" tabindex="-1"><a class="header-anchor" href="#_1-2-消息队列message-queue" aria-hidden="true">#</a> 1.2 消息队列Message Queue</h2><h3 id="_1-2-1-消息队列是什么" tabindex="-1"><a class="header-anchor" href="#_1-2-1-消息队列是什么" aria-hidden="true">#</a> 1.2.1 消息队列是什么</h3><p>消息队列，即MQ，Message Queue。</p><p><img src="'+d+'" alt="image-20230606195328011"></p><p>不同进程（process）之间传递消息时，两个进程之间<strong>耦合</strong>程度过高，改动一个进程，引发必须修改另一个进程，为了<strong>隔离</strong>这两个进程，在两进程间抽离出一层（一个模块），所有两进程之间传递的消息，都必须通过消息队列来传递，单独修改某一个进程，不会影响另一个；</p><p>不同进程（process）之间传递消息时，为了实现标准化，将消息的格式规范化了，并且，某一个进程接受的<strong>消息太多</strong>，一下子无法处理完，并且也有先后顺序，必须对收到的消息<strong>进行排队</strong>，因此诞生了事实上的消息队列；</p><p>消息队列是典型的：生产者、消费者模型。生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入，这样就实现了生产者和消费者的解耦。</p><p>结合前面所说的问题：</p><ul><li><p>注册服务对保存注册信息以后，无需去发送邮件短信、保存日志，只是发送一条消息，不用关心消息被谁接收。</p></li><li><p>邮件、短信服务接收消息，去处理各自的业务。</p><p>如果以后有其它系统(如日志系统)也依赖注册服务的数据，同样监听消息即可，注册服务无需任何代码修改。</p></li></ul><h3 id="_1-2-2-消息队列的作用" tabindex="-1"><a class="header-anchor" href="#_1-2-2-消息队列的作用" aria-hidden="true">#</a> 1.2.2 消息队列的作用</h3><p><img src="'+m+'" alt="kafka-duiliezuoyong"></p><p><strong>异步处理</strong></p><p>用户注册后，需要发注册邮件和注册短信。传统的串行方式会等所有业务执行完成后再返回结果。并行方式将注册信息写入数据库成功后，发送注册邮件的同时，发送注册短信，可以加快响应速度。</p><p><strong>应用解耦</strong></p><p>利用消息队列存储消息，需要消费消息的系统只需要订阅消息队列即可，有新的业务加入时无需修改原本的代码。</p><p><strong>流量削锋</strong></p><p>高并发请求同时对数据库执行写操作，<code>可能会导致数据库卡死导致宕机</code>。将请求消息保存到消息队列，系统可以按照自己的能力来消费消息。</p><h3 id="_1-2-3-消息队列主流产品概述" tabindex="-1"><a class="header-anchor" href="#_1-2-3-消息队列主流产品概述" aria-hidden="true">#</a> 1.2.3 消息队列主流产品概述</h3><p><strong>1、Apache Kafka：</strong></p><p>Apache Kafka是一个分布式流处理平台，具有高吞吐量、低延迟和可靠性等特点。它广泛应用于实时数据处理、日志收集、消息队列等场景。</p><p><strong>2、基于JMS的产品：</strong></p><p>​ JMS: Java Message Service API（Java消息服务）只能在java中使用</p><ul><li>Apache ActiveMQ：比较成熟的产品</li><li>RocketMQ：阿里巴巴产品，目前交由Apache基金会</li></ul><p><strong>3、基于AMQP的产品</strong></p><p>​ AMQP：Advanced Message Queuing Protocol（高级消息队列协议） 基于协议的，可以跨语言使用</p><ul><li>RabbitMQ：erlang语言开发，稳定性好，响应快。</li></ul><p>主流消息队列对比表：</p><table><thead><tr><th><strong>特性</strong></th><th><strong>ActiveMQ</strong></th><th><strong>RabbitMQ</strong></th><th><strong>RocketMQ</strong></th><th><strong>Kafka</strong></th></tr></thead><tbody><tr><td>开发语言</td><td>java</td><td>erlang</td><td>java</td><td>scala</td></tr><tr><td>单机吞吐量</td><td>万级</td><td>万级</td><td>10万级</td><td>100万级</td></tr><tr><td>时效性</td><td>ms</td><td>us</td><td>ms</td><td>ms级以内</td></tr><tr><td>可用性</td><td>高（主从）</td><td>高（主从）</td><td>非常高（分布式）</td><td>非常高（分布式）</td></tr><tr><td>功能特性</td><td>成熟的产品、较全的文档、各种协议支持好</td><td>并发能力强、性能好、延迟低，社区活跃度高，数据量没有那么大，优先选择功能比较完备的RabbitMQ</td><td>MQ功能比较完善，扩展性佳，可靠性要求高的金融互联网领域使用多,稳定性高，经历了多次阿里双11考验</td><td>只支持主要的MQ功能，大数据领域使用多，追求高吞吐量，适合产生大量数据的互联网服务的数据收集业务</td></tr></tbody></table><h3 id="_1-2-4-消息分类" tabindex="-1"><a class="header-anchor" href="#_1-2-4-消息分类" aria-hidden="true">#</a> 1.2.4 消息分类</h3><p><img src="'+v+'" alt="image-20230804170122667"></p><h2 id="_1-3-kafka起源和特点" tabindex="-1"><a class="header-anchor" href="#_1-3-kafka起源和特点" aria-hidden="true">#</a> 1.3 Kafka起源和特点</h2><h3 id="_1-3-1-kafka是什么" tabindex="-1"><a class="header-anchor" href="#_1-3-1-kafka是什么" aria-hidden="true">#</a> 1.3.1 Kafka是什么</h3><p>Kafka是Apache开源的一款基于zookeeper协调的分布式消息系统，具有高吞吐率、高性能、实时、高可靠等特点，可实时处理流式数据。它最初由LinkedIn公司开发，使用Scala语言编写。</p><p><code>Kafka</code>历经数年的发展，从最初纯粹的消息引擎，到近几年开始在流处理平台生态圈发力，多个组织或公司发布了各种不同特性的产品。常见产品如下：</p>',42),is=n("li",null,"Cloudera/Hortonworks Kafka ：集成了目前主流的大数据框架，能够帮助用户实现从分布式存储、集群调度、流处理到机器学习、实时数据库等全方位的数据处理。",-1),ls=n("li",null,[s("Confluent Kafka ：主要提供基于"),n("code",null,"Kafka"),s("的企业级流处理解决方案。")],-1),us=e('<p><code>Apache Kafka</code>，它现在依然是开发人数最多、版本迭代速度最快的<code>Kafka</code>。我们使用此产品学习。<strong>Apache 目前为止总共演进了8个大版本，分别是0.7、0.8、0.9、0.11、1.0、2.0和3.0，我们选择kafka_2.13-3.5.1.tgz版本讲解(截止2023.8)。</strong></p><h3 id="_1-3-2-kafka能干嘛" tabindex="-1"><a class="header-anchor" href="#_1-3-2-kafka能干嘛" aria-hidden="true">#</a> 1.3.2 Kafka能干嘛</h3><p><strong>Kafka特点</strong></p><ul><li><p>高吞吐量、低延迟：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息，它的延迟最低只有几毫秒</p></li><li><p>持久性：支持消息持久化，即使数TB级别的消息也能够保持长时间的稳定性能。</p></li><li><p>可靠性：支持数据备份防止丢失</p></li><li><p>容错性：支持通过Kafka服务器和消费机集群来分区消息，允许集群中的节点失败（若分区副本数量为n，则允许n-1个节点失败）</p></li><li><p>高并发：单机可支持数千个客户端同时读写，支持在线水平扩展。可无缝对接hadoop、strom、spark等，支持Hadoop并行数据加载，</p></li></ul><h3 id="_1-3-3-kafka去哪下" tabindex="-1"><a class="header-anchor" href="#_1-3-3-kafka去哪下" aria-hidden="true">#</a> 1.3.3 Kafka去哪下</h3><table><thead><tr><th>kafka官网</th><th>https://kafka.apache.org/</th></tr></thead><tbody><tr><td>kafka下载</td><td>https://kafka.apache.org/downloads</td></tr></tbody></table><h3 id="_1-3-4-kafka怎么玩" tabindex="-1"><a class="header-anchor" href="#_1-3-4-kafka怎么玩" aria-hidden="true">#</a> 1.3.4 Kafka怎么玩</h3><table><thead><tr><th>ID</th><th>设计目标</th><th>功能</th></tr></thead><tbody><tr><td>1</td><td>日志收集</td><td>一个公司可以用Kafka可以收集各种服务的Log，通过Kafka以统一接口服务的方式开放给各种Consumer</td></tr><tr><td>2</td><td>消息系统</td><td>解耦生产者和消费者、缓存消息等</td></tr><tr><td>3</td><td>用户活动跟踪</td><td>用来记录web用户或者APP用户的各种活动，如网页搜索、搜索、点击，用户数据收集然后进行用户行为分析。</td></tr><tr><td>4</td><td>运营指标</td><td>Kafka也经常用来记录运营监控数据。包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告</td></tr><tr><td>5</td><td>流式处理</td><td>比如Spark Streaming和Storm</td></tr></tbody></table><h2 id="_1-4-尚硅谷mq视频资料" tabindex="-1"><a class="header-anchor" href="#_1-4-尚硅谷mq视频资料" aria-hidden="true">#</a> 1.4 尚硅谷MQ视频资料</h2>',9),rs=n("thead",null,[n("tr",null,[n("th",null,[n("strong",null,"尚硅谷ActiveMQ教程")]),n("th",null,"https://www.bilibili.com/video/BV164411G7aB?p=1")])],-1),ks=n("tr",null,[n("td",null,"尚硅谷RabbitMQ教程"),n("td",null,"https://www.bilibili.com/video/BV1cb4y1o7zz?p=1")],-1),ds=n("tr",null,[n("td",null,"尚硅谷RocketMQ教程"),n("td",null,"https://www.bilibili.com/video/BV164411G7aB?p=1")],-1),ms=n("td",null,null,-1),vs=e(`<h1 id="_2-kafka单机版安装" tabindex="-1"><a class="header-anchor" href="#_2-kafka单机版安装" aria-hidden="true">#</a> <strong>2. Kafka单机版安装</strong></h1><p><strong>上传课件资料下的《kafka_2.12-3.4.0.tgz》到虚拟机/opt目录下</strong></p><h2 id="_2-1-下载" tabindex="-1"><a class="header-anchor" href="#_2-1-下载" aria-hidden="true">#</a> 2.1 下载</h2><table><thead><tr><th>kafka官网</th><th>https://kafka.apache.org/</th></tr></thead><tbody><tr><td>kafka下载</td><td>https://kafka.apache.org/downloads</td></tr></tbody></table><h2 id="_2-2-解压" tabindex="-1"><a class="header-anchor" href="#_2-2-解压" aria-hidden="true">#</a> <strong>2.2 解压</strong></h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /opt
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> kafka_2.12-3.4.0.tgz
<span class="token comment"># 修改解压后的文件夹名称为Kafka</span>
<span class="token function">mv</span> kafka_2.12-3.4.0 Kafka
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-3-目录结构" tabindex="-1"><a class="header-anchor" href="#_2-3-目录结构" aria-hidden="true">#</a> <strong>2.3 目录结构</strong></h2><p><strong><img src="`+g+`" alt="image-20230609180142754"></strong></p><h2 id="_2-4-配置全局环境变量" tabindex="-1"><a class="header-anchor" href="#_2-4-配置全局环境变量" aria-hidden="true">#</a> <strong>2.4 配置全局环境变量</strong></h2><h3 id="_2-4-1-编辑profile" tabindex="-1"><a class="header-anchor" href="#_2-4-1-编辑profile" aria-hidden="true">#</a> <strong>2.4.1 编辑profile</strong></h3><ul><li>使用kafka前提是：Linux服务器上已经有Java环境并配置好</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>vim /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>文件最后的内容如下：</strong></p><p><strong><img src="`+b+`" alt="image-20230609203907844"></strong></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">JAVA_HOME</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/jdk1.8.0_152</span>
<span class="token key attr-name">KAFKA_HOME</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/kafka</span>
<span class="token key attr-name">PATH</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/jdk1.8.0_152/bin:/opt/kafka/bin:$PATH</span>
<span class="token key attr-name">export</span> <span class="token value attr-value">JAVA_HOME KAFKA_HOME PATH</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>保存退出</strong></p><h3 id="_2-4-2-激活profile" tabindex="-1"><a class="header-anchor" href="#_2-4-2-激活profile" aria-hidden="true">#</a> <strong>2.4.2 激活profile</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-4-3-编辑config目录下的server-properties" tabindex="-1"><a class="header-anchor" href="#_2-4-3-编辑config目录下的server-properties" aria-hidden="true">#</a> <strong>2.4.3 编辑config目录下的server.properties</strong></h3><p><img src="`+f+`" alt=""></p><ol><li>Kafka需要使用Zookeeper，默认下载包里面已经集成了Zookeeper，可以直接使用。</li><li>默认Kafka是仅在本地使用，如果要远程访问，请修改config/server.properties，代码+抓图如下：</li></ol><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.111.172:9092
<span class="token assign-left variable">advertised.listeners</span><span class="token operator">=</span>PLAINTEXT://192.168.111.172:9092
<span class="token comment"># 上面IP地址为你自己Linux系统的真实IP地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+h+`" alt="image-20230804153319649"></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">zookeeper.connect</span><span class="token operator">=</span><span class="token number">192.168</span>.111.172:2181
<span class="token comment"># 上面IP地址为你自己Linux系统的真实IP地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+y+'" alt="image-20230804153457067"></p><p><strong>最小化简单修改结论：</strong></p><p>kafka的默认端口9092 zookeeper默认端口2181</p><p><img src="'+_+`" alt="image-20230808153411878"></p><h2 id="_2-5-测试" tabindex="-1"><a class="header-anchor" href="#_2-5-测试" aria-hidden="true">#</a> <strong>2.5 测试</strong></h2><h3 id="_2-5-1-查看kafka版本" tabindex="-1"><a class="header-anchor" href="#_2-5-1-查看kafka版本" aria-hidden="true">#</a> <strong>2.5.1 查看Kafka版本：</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh <span class="token parameter variable">-version</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong><img src="`+w+`" alt="image-20230609204453523"></strong></p><h3 id="_2-5-2-启动kafka自带的zookeeper" tabindex="-1"><a class="header-anchor" href="#_2-5-2-启动kafka自带的zookeeper" aria-hidden="true">#</a> 2.5.2 启动Kafka自带的Zookeeper</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 前台启动，讲课用，为了给学生看到控制台浮现的zookeeper图标表示启动成功</span>
<span class="token comment"># &amp;使得进程在后台启动</span>
bin/zookeeper-server-start.sh config/zookeeper.properties <span class="token operator">&amp;</span>

<span class="token comment"># 后台启动，开发用，也即消息内容别往前台打</span>
<span class="token comment"># nohup 英文全称 no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</span>
<span class="token comment"># nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-3-启动kafka自身" tabindex="-1"><a class="header-anchor" href="#_2-5-3-启动kafka自身" aria-hidden="true">#</a> 2.5.3 启动Kafka自身</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 前台启动，讲课用</span>
bin/kafka-server-start.sh config/server.properties <span class="token operator">&amp;</span>
<span class="token comment"># 后台启动，开发用，也即消息内容别往前台打</span>
<span class="token comment"># nohup bin/kafka-server-start.sh config/server.properties &amp;</span>

<span class="token comment"># -daemon 守护启动，[]表示可以省略</span>
<span class="token comment"># server.properties Kafka配置文件</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成上述两步，可以用lsof -i:端口号分别验证下:</p><p><img src="`+q+`" alt="image-20230804160500636"></p><h3 id="_2-5-4-创建topic" tabindex="-1"><a class="header-anchor" href="#_2-5-4-创建topic" aria-hidden="true">#</a> 2.5.4 创建Topic</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> hellokafka-topic --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+S+`" alt="image-20230804161515068"></p><h3 id="_2-5-5-查看已经创建的topic信息" tabindex="-1"><a class="header-anchor" href="#_2-5-5-查看已经创建的topic信息" aria-hidden="true">#</a> 2.5.5 查看已经创建的Topic信息</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/kafka-topics.sh <span class="token parameter variable">--list</span> --bootstrap-server <span class="token number">192.168</span>.111.172:9092
<span class="token comment"># 第2种方式</span>
bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> hellokafka-topic --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+x+`" alt="image-20230804162815260"></p><h3 id="_2-5-6-发送消息" tabindex="-1"><a class="header-anchor" href="#_2-5-6-发送消息" aria-hidden="true">#</a> 2.5.6 发送消息</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/kafka-console-producer.sh  <span class="token parameter variable">--topic</span> hellokafka-topic --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+P+`" alt="image-20230804163106533"></p><h3 id="_2-5-7-消费消息" tabindex="-1"><a class="header-anchor" href="#_2-5-7-消费消息" aria-hidden="true">#</a> 2.5.7 消费消息</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 请新启一个客户端</span>
bin/kafka-console-consumer.sh <span class="token parameter variable">--topic</span> hellokafka-topic --from-beginning --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+C+`" alt="image-20230804163335828"></p><h3 id="_2-5-8-停止kafka" tabindex="-1"><a class="header-anchor" href="#_2-5-8-停止kafka" aria-hidden="true">#</a> 2.5.8 停止kafka</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/kafka-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-5-9-停止zookeeper" tabindex="-1"><a class="header-anchor" href="#_2-5-9-停止zookeeper" aria-hidden="true">#</a> 2.5.9 停止zookeeper</h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>bin/zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="_3-kafka基础架构和术语名词" tabindex="-1"><a class="header-anchor" href="#_3-kafka基础架构和术语名词" aria-hidden="true">#</a> 3. Kafka基础架构和术语名词</h1><p>从高阶和顶层看，生产者发送消息到kafka集群，然后消费者来获取消息进行后续处理</p><p><img src="`+K+'" alt=""></p><p>【以下是概念性质的基础名词和专业术语，请先了解，后续慢慢展开，首次听懵逼属于正常......^_^】</p>',58),gs=n("thead",null,[n("tr",null,[n("th",null,[n("strong",null,"核心组件")]),n("th",null,[n("strong",null,"概念")])])],-1),bs=n("td",null,[n("strong",null,"生产者，可以向Broker topic发布消息的客户端")],-1),fs=n("td",null,[n("strong",null,"消费者，从Broker topic订阅取消息的客户端")],-1),hs=n("td",null,[n("strong",null,"Broker是一个kafka实例，简单说就是一台kafka服务器，kafkaCluster表示集群。一个Linux服务器上启动一个或多个 kafka服务器实例。")],-1),ys=n("td",null,[n("strong",null,"主题,Kafka将消息分门别类，每一类的消息称之为一个主题。可以理解为一个队列，生产者和消费者面向的都是一个topic")],-1),_s=n("td",null,[n("strong",null,"Topic的分区，每个 Topic 可以有多个分区，同一个Topic 在不同分区的数据是不重复的，每个Partition是一个有序的队列。分区作用是做负载，提高 kafka 的吞吐量。每个partition都由一系列有序的、不可变的消息组成，这些消息被连续的追加到partition中。partition中的每个消息都有一个连续递增的序列号叫做offset，偏移量offset在每个分区中是唯一的。")],-1),ws=n("tr",null,[n("td",null,[n("strong",null,"Offset")]),n("td",null,[n("strong",null,"生产者Offset：消息写入的时候，每一个分区都有一个offset，这个offset就是生产者的offset，同时也是这个分区的最新最大的offset。 消费者Offset：某个分区的offset情况。例如：生产者写入的offset是最新值是10，当一个Consumer开始消费时，从0消费，一直消费到了5，消费者的offset为5。")])],-1),qs=n("tr",null,[n("td",null,[n("strong",null,"Replication")]),n("td",null,[n("strong",null,"Partition(分区)的副本。每个分区可以有多个Replication，由一个Leader和若干个Follower组成。Leader负责接收生产者push的消息和消费者poll消费消息。Follower会实时从自己的Leader中同步数据保持同步。Leader故障时,某个Follower会上位为新的Leader。保证高可用")])],-1),Ss=n("tr",null,[n("td",null,[n("strong",null,"Message")]),n("td",null,[n("strong",null,"kafka集群存储的消息是以topic为类别记录的，每个消息（也叫记录record）是由")])],-1),xs=n("td",null,[n("strong",null,"消费者组，由多个Consumer组成，每个ConsumerGroup中可以有多个consumer，每个consumer属于一个ConsumerGroup。同一个Topic下的某一个分区只能被某个消费者组内的同一个消费者所消费，但可以被多个 consumer group 消费")],-1),Ps=n("tr",null,[n("td",null,[n("strong",null,"In-sync Replicas（ISR）")]),n("td",null,[n("strong",null,"（ISR）已同步副本：表示存活且副本都已和Leader同步的的broker集合，是Leader所有replicas副本的子集。如果某个副本节点宕机，该副本就会从ISR集合中剔除。")])],-1),Cs=e('<p><strong>Kafka中的Broker、Topic、Consumer都会注册到zookeeper</strong></p><h2 id="_3-1-events-streams-topics" tabindex="-1"><a class="header-anchor" href="#_3-1-events-streams-topics" aria-hidden="true">#</a> <strong>3.1 Events, Streams, Topics</strong></h2><table><thead><tr><th style="text-align:left;"><strong>Event</strong></th><th><strong>Event</strong>（事件），代表过去发生的一个事实(比如下了一个购物订单)。简单理解就是一条消息、一条记录，Event 是不可变的，但是很活跃，经常从一个地方流向另一个地方。</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Stream</strong></td><td>事件流表示运动中的相关事件</td></tr><tr><td style="text-align:left;"><strong>Topic</strong></td><td>当一个事件流进入 Kafka 之后，它就成为了一个 <strong>Topic</strong> 主题。所以，Topic 就是具体的事件流，也可以理解为一个 Topic 就是一个静止的 Stream。Topic 把相关的 Event 组织在一起，并且保存。一个 Topic 就像数据库中的一张表。</td></tr></tbody></table><p><img src="'+I+'" alt="image-20230819212740880"></p><h2 id="_3-2-partition-分区" tabindex="-1"><a class="header-anchor" href="#_3-2-partition-分区" aria-hidden="true">#</a> <strong>3.2 Partition 分区</strong></h2>',5),Ks=e('<p><img src="'+T+'" alt="image-20230819212959269"></p><p><strong>每个 Partition 都是一个单独的 log 文件，每条记录都以追加的形式写入。</strong></p><p><img src="'+E+'" alt="image-20230819213209251"></p><h2 id="_3-3-offsets-偏移量-和消息的顺序" tabindex="-1"><a class="header-anchor" href="#_3-3-offsets-偏移量-和消息的顺序" aria-hidden="true">#</a> <strong>3.3 Offsets（偏移量）和消息的顺序</strong></h2><p><strong>Partition 中的每条记录都会被分配一个唯一的序号，称为 <strong>Offset</strong>（偏移量）。Offset 是一个递增的、不可变的数字，由 Kafka 自动维护。当一条记录写入 Partition 的时候，它就被追加到 log 文件的末尾，并被分配一个序号，作为 Offset。</strong></p><p><img src="'+z+'" alt="image-20230819213456271"></p><p><strong>如上图，这个 Topic 有 3 个 Partition 分区，向 Topic 发送消息的时候，实际上是被写入某一个 Partition，并赋予 Offset。消息的顺序性需要注意，一个 Topic 如果有多个 Partition 的话，那么从 Topic 这个层面来看，消息是无序的。但单独看 Partition 的话，Partition 内部消息是有序的。所以，一个 Partition 内部消息有序，一个 Topic 跨 Partition 是无序的。如果强制要求 Topic 整体有序，就只能让 Topic 只有一个 Partition。</strong></p><p>更进一步，如何指定写入到那个分区？</p><p><img src="'+R+'" alt="image-20230908221625515"></p><h2 id="_3-4-partition-为-kafka-提供了扩展能力" tabindex="-1"><a class="header-anchor" href="#_3-4-partition-为-kafka-提供了扩展能力" aria-hidden="true">#</a> <strong>3.4 Partition 为 Kafka 提供了扩展能力</strong></h2><p><strong>一个 Kafka 集群由多个 Broker（就是 Server） 构成，每个 Broker 中含有集群的部分数据。Kafka 把 Topic 的多个 Partition 分布在多个 Broker 中。</strong></p><p><img src="'+A+'" alt="image-20230819214225116"></p><table><thead><tr><th>扩容方便</th><th>如果把 Topic 的所有 Partition 都放在一个 Broker 上，那么这个 Topic 的可扩展性就大大降低了，会受限于这个 Broker 的 IO 能力。把 Partition 分散开之后，Topic 就可以水平扩展</th></tr></thead><tbody><tr><td>防止单点故障</td><td>一个 Topic 可以被多个 Consumer 并行消费。如果 Topic 的所有 Partition 都在一个 Broker，那么支持的 Consumer 数量就有限，而分散之后，可以支持更多的 Consumer。</td></tr><tr><td>高并发</td><td>一个 Consumer 可以有多个实例，Partition 分布在多个 Broker 的话，Consumer 的多个实例就可以连接不同的 Broker，大大提升了消息处理能力。可以让一个 Consumer 实例负责一个 Partition，这样消息处理既清晰又高效。</td></tr></tbody></table><h1 id="_4-kafka常用命令" tabindex="-1"><a class="header-anchor" href="#_4-kafka常用命令" aria-hidden="true">#</a> <strong>4. Kafka常用命令</strong></h1><p><strong><img src="'+j+`" alt="image-20230618160300739"></strong></p><h2 id="_4-1-启停命令" tabindex="-1"><a class="header-anchor" href="#_4-1-启停命令" aria-hidden="true">#</a> <strong>4.1 启停命令</strong></h2><p><strong>启动：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 一定先启动zookeeper</span>
<span class="token function">nohup</span> bin/zookeeper-server-start.sh config/zookeeper.properties <span class="token operator">&amp;</span>
<span class="token comment"># -daemon 守护启动</span>
<span class="token comment"># server.properties Kafka配置文件,在路径 /mykafka/kafka3.5.1目录下</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>停止：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_4-2-主题命令" tabindex="-1"><a class="header-anchor" href="#_4-2-主题命令" aria-hidden="true">#</a> <strong>4.2 主题命令</strong></h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>kafka-topics.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>常用参数列表：</strong></p><table><thead><tr><th><strong>参数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>--bootstrap-server &lt;String: server toconnect to&gt;</strong></td><td><strong>连接的Kafka Broker主机名称和端口号。</strong></td></tr><tr><td><strong>--topic &lt;String: topic&gt;</strong></td><td><strong>操作的topic名称。</strong></td></tr><tr><td><strong>--create</strong></td><td><strong>创建主题。</strong></td></tr><tr><td><strong>--delete</strong></td><td><strong>删除主题。</strong></td></tr><tr><td><strong>--alter</strong></td><td><strong>修改主题。</strong></td></tr><tr><td><strong>--list</strong></td><td><strong>查看所有主题。</strong></td></tr><tr><td><strong>--describe</strong></td><td><strong>查看主题详细描述。</strong></td></tr><tr><td><strong>--partitions &lt;Integer: # of partitions&gt;</strong></td><td><strong>设置分区数。</strong></td></tr><tr><td><strong>--replication-factor&lt;Integer: replication factor&gt;</strong></td><td><strong>设置分区副本。</strong></td></tr><tr><td><strong>--config &lt;String: name=value&gt;</strong></td><td><strong>更新系统默认的配置。</strong></td></tr></tbody></table><h3 id="_4-2-1-主题列表查询" tabindex="-1"><a class="header-anchor" href="#_4-2-1-主题列表查询" aria-hidden="true">#</a> <strong>4.2.1 主题列表查询</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_4-2-2-创建topic-含分区和副本" tabindex="-1"><a class="header-anchor" href="#_4-2-2-创建topic-含分区和副本" aria-hidden="true">#</a> <strong>4.2.2 创建topic(含分区和副本)</strong></h3><p><img src="`+O+`" alt=""></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 创建1个分区1个副本的first主题：partitions 分区数, replication-factor 副本数，topic 主题名</span>
<span class="token comment"># 各个参数含义如下：</span>
<span class="token comment"># --create：创建主题的动作指令</span>
<span class="token comment"># --bootstrap-server：指定kafka所连接的zookeeper服务地址</span>
<span class="token comment"># --topic：指定了所要创建主题的名称</span>
<span class="token comment"># --partitions：指定了分区个数</span>
<span class="token comment"># --replication-factor：指定了副本因子 一个broker创建topic的时候只能是一个副本</span>

kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">1</span> --replication-factor <span class="token number">1</span> <span class="token parameter variable">--topic</span> first
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+N+`" alt="image-20230804171551073"></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 创建3个分区1个副本的first2主题：partitions 分区数, replication-factor 副本数，topic 主题名</span>
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">1</span> <span class="token parameter variable">--topic</span> first2

<span class="token comment"># 上述命令执行完，按照【log.dirs=/tmp/kafka-logs】配置，进入到/tmp/kafka-logs</span>
<span class="token comment"># 会看到你所建立的主题和对应分区</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+L+`" alt="image-20230816104740315"></p><h3 id="_4-2-3-查看主题详情" tabindex="-1"><a class="header-anchor" href="#_4-2-3-查看主题详情" aria-hidden="true">#</a> <strong>4.2.3 查看主题详情</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> first
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+M+`" alt="image-20230804171822562"></p><h3 id="_4-2-4-修改分区数" tabindex="-1"><a class="header-anchor" href="#_4-2-4-修改分区数" aria-hidden="true">#</a> <strong>4.2.4 修改分区数</strong></h3><p><strong>注意：分区数只能增加,不能减少</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--alter</span> <span class="token parameter variable">--topic</span> first <span class="token parameter variable">--partitions</span> <span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>再次查看主题详情：</strong></p><p><img src="`+B+'" alt="image-20230804171959421"></p><p><strong>查询结果解释：</strong></p><p><strong>第一行显示所有partitions的概要信息：</strong></p><p><strong>​ 列出了Topic名字，partition总数，存储这些partition的broker数</strong></p><p><strong>其他每一行是一个partition的详细信息：</strong></p><table><thead><tr><th>Topic</th><th>主题</th></tr></thead><tbody><tr><td>Partition</td><td><strong>分区编号</strong></td></tr><tr><td>Leader</td><td><strong>当前Partiton所有broker中担任leader的broker id，每个broker都有可能成为leader</strong></td></tr><tr><td>Replicas</td><td>显示该partiton所有副本所在的broker列表，包括leader，不管该broker是否是存活，不管是否和leader保持了同步</td></tr><tr><td>Isr</td><td>in-sync replicas的简写，表示存活且副本都已同步的的broker集合，是replicas的子集</td></tr></tbody></table><p><strong>说明：当producer发送一个消息时，producer自己会判断发送到哪个partiton上，如果发到了partition0上，消息会发到leader上处理这个消息，其它broker会从leader上同步这个消息。如果这个leader挂了，那么Kafka会在Isr列表中选一个新的leader，不懂没关系，后续讲解Kafka集群再说</strong>。</p><p><img src="'+D+`" alt="image-20230908223104808"></p><h3 id="_4-2-5-删除主题" tabindex="-1"><a class="header-anchor" href="#_4-2-5-删除主题" aria-hidden="true">#</a> <strong>4.2.5 删除主题</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> first
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+G+`" alt="image-20230804172203509"></p><h2 id="_4-3-生产者命令" tabindex="-1"><a class="header-anchor" href="#_4-3-生产者命令" aria-hidden="true">#</a> <strong>4.3 生产者命令</strong></h2><p><strong>新建主题topic: second：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> hellokafka-topic --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+F+`" alt="image-20230804172338214"></p><p><strong>生产者发送消息到某个主题：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-producer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--topic</span> second
<span class="token comment"># 输入消息，回车发送消息</span>
<span class="token operator">&gt;</span>hello world
<span class="token operator">&gt;</span>atguigu
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-4-消费者命令" tabindex="-1"><a class="header-anchor" href="#_4-4-消费者命令" aria-hidden="true">#</a> <strong>4.4 消费者命令</strong></h2><h3 id="_4-4-1-消费者参数列表" tabindex="-1"><a class="header-anchor" href="#_4-4-1-消费者参数列表" aria-hidden="true">#</a> <strong>4.4.1 消费者参数列表</strong></h3><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>kafka-console-consumer.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>参数列表：</strong></p><table><thead><tr><th><strong>参数</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>--bootstrap-server &lt;String: server toconnect to&gt;</strong></td><td><strong>连接的Kafka Broker主机名称和端口号。</strong></td></tr><tr><td><strong>--topic &lt;String: topic&gt;</strong></td><td><strong>操作的topic名称。</strong></td></tr><tr><td><strong>--from-beginning</strong></td><td><strong>从头重新消费topic中的消息</strong></td></tr><tr><td><strong>--group &lt;String: consumer group id&gt;</strong></td><td><strong>指定消费者组名称。</strong></td></tr></tbody></table><h3 id="_4-4-2-消费主题数据" tabindex="-1"><a class="header-anchor" href="#_4-4-2-消费主题数据" aria-hidden="true">#</a> <strong>4.4.2 消费主题数据</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--topic</span> second

kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 --from-beginning <span class="token parameter variable">--topic</span> second
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-3-消费主题所有数据-包括历史数据" tabindex="-1"><a class="header-anchor" href="#_4-4-3-消费主题所有数据-包括历史数据" aria-hidden="true">#</a> <strong>4.4.3 消费主题所有数据(包括历史数据)</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092  --from-beginning <span class="token parameter variable">--topic</span> second
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong><img src="`+U+`" alt="image-20230604192924364"></strong></p><h2 id="_4-5-消费者组-consumergroup-命令" tabindex="-1"><a class="header-anchor" href="#_4-5-消费者组-consumergroup-命令" aria-hidden="true">#</a> <strong>4.5 消费者组(consumerGroup)命令</strong></h2><h3 id="_4-5-1-消费组查看list" tabindex="-1"><a class="header-anchor" href="#_4-5-1-消费组查看list" aria-hidden="true">#</a> 4.5.1 消费组查看list</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+V+`" alt="image-20230820154852175"></p><h3 id="_4-5-2-消费组-点对点" tabindex="-1"><a class="header-anchor" href="#_4-5-2-消费组-点对点" aria-hidden="true">#</a> 4.5.2 消费组(点对点)</h3><p>一条消息只能被同一个消费组里的一个消费者消费，组内有竞争先到先得，案例如下：</p><p>两个消费者都在同一个消费组，然后往主题里发送消息，结果只有一个消费者客户端能消费到。</p><p>也即，一个分区只能被一个消费组里面的一个消费者消费</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 新建topic kafkav1</span>
kafka-topics.sh <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> kafkav1 --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>发送消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-producer.sh  <span class="token parameter variable">--topic</span> kafkav1 --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+H+`" alt="image-20230820155854728"></p></li><li><p>两个消费者分别在不同的命令终端，但它两在同一个消费组却只有一个消费者能收到消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 关键参数：--consumer-property group.id=group01</span>
kafka-console-consumer.sh <span class="token parameter variable">--topic</span> kafkav1 --from-beginning --bootstrap-server <span class="token number">192.168</span>.111.172:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>group01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+Q+`" alt="image-20230820160230983"></p></li></ul><p>消费者2号，也在group01同一个组里面，消费不到消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 消费组查看list</span>
kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--list</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+Z+`" alt="image-20230820160456932"></p><h3 id="_4-5-3-消费组-发布-订阅模式" tabindex="-1"><a class="header-anchor" href="#_4-5-3-消费组-发布-订阅模式" aria-hidden="true">#</a> 4.5.3 消费组(发布-订阅模式)</h3><p>一条消息能被多个消费者消费，发布订阅模式，保证不同的消费者分属不同的消费组即可做到，结果两个客户端都能收到消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 新增一个消费者后可以看到新的分组+消费到消息</span>
kafka-console-consumer.sh <span class="token parameter variable">--topic</span> kafkav1 --from-beginning --bootstrap-server <span class="token number">192.168</span>.111.172:9092 --consumer-property <span class="token assign-left variable">group.id</span><span class="token operator">=</span>group02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+Y+'" alt="image-20230820160740347"></p><p><strong>第2个组的消费者可以消费到消息：</strong></p><p><img src="'+X+`" alt="image-20230820160915323"></p><h3 id="_4-5-4-消费组查看offset偏移量" tabindex="-1"><a class="header-anchor" href="#_4-5-4-消费组查看offset偏移量" aria-hidden="true">#</a> 4.5.4 消费组查看offset偏移量</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group02
<span class="token comment"># 上述命令完成后下图1步骤</span>
<span class="token comment"># 生产者发送一条消息，执行上述命令，下图步骤2</span>
<span class="token comment"># 先让2号小组消费者退出(ctrl—C退出kafka-console-consumer),生产者发送一条消息，下图3会发现，消息落后了一步</span>

<span class="token comment"># 生产者发送一条消息，执行上述命令，下图步骤4，会发现，消息落后了两步</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+W+'" alt="image-20230820161523091"></p><table><thead><tr><th>CURRENT-OFFSET</th><th>当前消费者群组最近提交的offset，也就是消费者分区里读取的当前位置</th></tr></thead><tbody><tr><td>LOG-END-OFFSET</td><td>当前最高水位偏移量，也就是最近一个读取消息的偏移量，同时也是最近一个提交到集群的偏移量</td></tr><tr><td>LAG</td><td>消费者的CURRENT-OFFSET与broker的LOG-END-OFFSET之间的差距</td></tr></tbody></table><h3 id="_4-5-5-消费者-消费组总结" tabindex="-1"><a class="header-anchor" href="#_4-5-5-消费者-消费组总结" aria-hidden="true">#</a> 4.5.5 消费者-消费组总结</h3><p><img src="'+J+`" alt="image-20230818223919146"></p><p><strong>一个分区同一个时刻在一个消费组中只能有一个消费者在消费，从而保证消费顺序。消费组中的消费者的数量不能比一个Topic中的分区的数量多，否则，多出来的消费者消费不到消息。</strong></p><h2 id="_4-6-offset偏移量命令" tabindex="-1"><a class="header-anchor" href="#_4-6-offset偏移量命令" aria-hidden="true">#</a> <strong>4.6 offset偏移量命令</strong></h2><h3 id="_4-6-1-偏移量重置策略" tabindex="-1"><a class="header-anchor" href="#_4-6-1-偏移量重置策略" aria-hidden="true">#</a> 4.6.1 偏移量重置策略</h3><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>--to-earliest</td><td>把位移调整到分区当前最小位移</td><td></td></tr><tr><td>--to-latest</td><td>把位移调整到分区当前最新位移</td><td></td></tr><tr><td>--to-current</td><td>把位移调整到分区当前位移</td><td></td></tr><tr><td>--to-offset 正整数</td><td>把位移调整到指定位移处</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>--execute：执行方案</td><td>执行真正的位移调整</td><td>只是打印出位移调整方案，不具体执行</td></tr></tbody></table><ol><li><p>to-earliest</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 1</span>
kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group02
<span class="token comment"># 看结果</span>

<span class="token comment"># 2</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-earliest <span class="token parameter variable">--execute</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+$+`" alt="image-20230820164318852"></p></li><li><p>to-latest</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-latest  <span class="token parameter variable">--execute</span>
<span class="token comment"># 再查看</span>
kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+nn+`" alt="image-20230820164536274"></p></li><li><p>to-current</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-current  <span class="token parameter variable">--execute</span>
<span class="token comment"># 再查看</span>
kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>to-offset</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-offset <span class="token number">7</span>  <span class="token parameter variable">--execute</span>
<span class="token comment"># 再查看</span>
kafka-consumer-groups.sh  --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--group</span> group02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p><img src="`+sn+`" alt="image-20230820164813876"></p><h1 id="_5-kafka图形化监控eagle" tabindex="-1"><a class="header-anchor" href="#_5-kafka图形化监控eagle" aria-hidden="true">#</a> <strong>5. Kafka图形化监控Eagle</strong></h1><h2 id="_5-1-安装" tabindex="-1"><a class="header-anchor" href="#_5-1-安装" aria-hidden="true">#</a> <strong>5.1 安装</strong></h2><p><strong>1、搜索镜像</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> search efak
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong><img src="`+an+`" alt="image-20230625192719254"></strong></p><p><strong>2、下载镜像运行容器</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#注意：配置zookeeper服务的地址,需要较大内存，如果启动后不能访问一般是内存不足，需要关闭不相关的进程腾出内存</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> Kafka-eagle <span class="token parameter variable">-p</span> <span class="token number">8048</span>:8048 <span class="token parameter variable">-e</span> <span class="token assign-left variable">EFAK_CLUSTER_ZK_LIST</span><span class="token operator">=</span><span class="token string">&quot;192.168.111.172:2181&quot;</span> nickzurich/efak:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3、访问测试（注意防火墙互ping通过，自己本机真实IP地址）</strong></p><p>eagle地址：</p><p>http://192.168.111.172:8048/account/signin</p><p><strong><img src="`+tn+'" alt="image-20230625194330933"></strong></p><h2 id="_5-2-使用" tabindex="-1"><a class="header-anchor" href="#_5-2-使用" aria-hidden="true">#</a> <strong>5.2 使用</strong></h2><h3 id="_5-2-1-首页" tabindex="-1"><a class="header-anchor" href="#_5-2-1-首页" aria-hidden="true">#</a> <strong>5.2.1 首页</strong></h3><p><strong>登录成功进入首页可以查看Kafka实例、主题、消费者等信息：</strong></p><p><strong><img src="'+pn+'" alt="image-20230625194537473"></strong></p><h3 id="_5-2-2-查看kafka列表" tabindex="-1"><a class="header-anchor" href="#_5-2-2-查看kafka列表" aria-hidden="true">#</a> <strong>5.2.2 查看Kafka列表</strong></h3><p><strong><img src="'+en+'" alt="image-20230625195715792"></strong></p><h3 id="_5-2-3-新建主题" tabindex="-1"><a class="header-anchor" href="#_5-2-3-新建主题" aria-hidden="true">#</a> <strong>5.2.3 新建主题</strong></h3><p><strong><img src="'+on+'" alt="image-20230625195938075"></strong></p><h3 id="_5-2-4-查看主题列表" tabindex="-1"><a class="header-anchor" href="#_5-2-4-查看主题列表" aria-hidden="true">#</a> <strong>5.2.4 查看主题列表</strong></h3><p><strong>此页面可以修改或者删除主题，鉴权token默认是<code>keadmin</code></strong></p><p><strong><img src="'+cn+'" alt="image-20230625201515206"></strong></p><h3 id="_5-2-5-查看主题详情" tabindex="-1"><a class="header-anchor" href="#_5-2-5-查看主题详情" aria-hidden="true">#</a> <strong>5.2.5 查看主题详情</strong></h3><p><strong><img src="'+ln+`" alt="image-20230625201742134"></strong></p><p><strong>执行命令向主题atguigu中发送消息：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[root@atguigu ~]# kafka-console-producer.sh --bootstrap-server 192.168.111.172:9092 --topic atguigu 
&gt;hello,atguigu
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看分区中的消息：</strong></p><p><strong><img src="`+un+'" alt="image-20230625202302790"></strong></p><p><strong>注意：加载数据速度有点慢，遇到查询失败时重新查询即可</strong></p><p><strong><img src="'+rn+'" alt="image-20230625202356808"></strong></p><h1 id="_6-kafka原生api入门篇" tabindex="-1"><a class="header-anchor" href="#_6-kafka原生api入门篇" aria-hidden="true">#</a> 6. Kafka原生API入门篇</h1><h2 id="_6-1-发送消息" tabindex="-1"><a class="header-anchor" href="#_6-1-发送消息" aria-hidden="true">#</a> <strong>6.1 发送消息</strong></h2><h3 id="_6-1-1-项目搭建" tabindex="-1"><a class="header-anchor" href="#_6-1-1-项目搭建" aria-hidden="true">#</a> <strong>6.1.1 项目搭建</strong></h3><p><strong>创建SpringBoot项目：kafka-producter</strong></p><p><strong>SpringBoot版本：3.1.0</strong></p><p><strong><img src="'+kn+`" alt="image-20230605205316992"></strong></p><p><strong>引入依赖：</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--kafka-clients 2023.8--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-1-2-producer发送消息-默认" tabindex="-1"><a class="header-anchor" href="#_6-1-2-producer发送消息-默认" aria-hidden="true">#</a> <strong>6.1.2 producer发送消息(默认)</strong></h3><p><strong>需求：创建Kafka生产者，采用异步的方式发送消息到Kafka Broker</strong></p><p><strong>官方文档：</strong></p><table><thead><tr><th>https://kafka.apache.org/35/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html</th></tr></thead></table><p><strong>新建主题topic:hellokafka</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--create</span>  <span class="token parameter variable">--topic</span> hellokafka
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>测试代码：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProducerDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
            	public class ProducerRecord&lt;K, V&gt; {
            		//主题名称，必选参数
                    private final String topic;
                    //分区号，大于等于0的整数，可选参数。
                    private final Integer partition;
                    //消息的头信息，类型是RecordHeaders，可选属性。
                    private final Headers headers;
                    //键，可选参数。
                    private final K key;
                    //消息内容，必选参数。
                    private final V value;
                    //每条消息都有一个时间戳，可选参数
                    private final Long timestamp;
                }
            */</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;hellokafka~&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：执行测试代码前，在控制台开启Kafka消费者监听hellokafka主题</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh <span class="token parameter variable">--topic</span> hellokafka  --bootstrap-server <span class="token number">192.168</span>.111.172:9092
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>执行测试代码后，消费者中可以看到接收的消息</strong></p><p><img src="`+dn+`" alt="image-20230809174016338"></p><p>备注：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>　　　　　　
    <span class="token comment">&lt;!-- 如果觉得idea控制台日志太多，src\\main\\resources目录下新建logback.xml
屏蔽kafka debug --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.apache.kafka.clients<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>debug<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-2-消费消息" tabindex="-1"><a class="header-anchor" href="#_6-2-消费消息" aria-hidden="true">#</a> <strong>6.2 消费消息</strong></h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-08-09 17:46
 *
 * https://kafka.apache.org/35/javadoc/org/apache/kafka/clients/consumer/KafkaConsumer.html
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConsumerDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-3-异步发送消息" tabindex="-1"><a class="header-anchor" href="#_6-3-异步发送消息" aria-hidden="true">#</a> <strong>6.3 异步发送消息</strong></h2>`,152),Is=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 异步发送 默认</span>
<span class="token comment">//kafkaProducer.send(new ProducerRecord&lt;&gt;(&quot;second&quot;,&quot;Kafka&quot; + i));</span>
<span class="token comment">// 同步发送</span>
kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Kafka&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-4-异步发送且callback回调" tabindex="-1"><a class="header-anchor" href="#_6-4-异步发送且callback回调" aria-hidden="true">#</a> <strong>6.4 异步发送且Callback回调</strong></h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-08-09 10:57
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerCallbackDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hellokafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//生产者配置文档：https://Kafka.apache.org/documentation.html#producerconfigs</span>

        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加回调</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//回调函数会在producer收到ack时调用，该方法有两个参数:元数据信息（RecordMetadata）和异常信息（Exception）。</span>
                <span class="token comment">// 如果Exception为null，说明消息发送成功，否则消息发送失败。</span>
                <span class="token comment">//注意：消息发送失败会自动重试，不需要我们在回调函数中手动重试。</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 没有异常,输出信息到控制台</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span>  <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;-&gt;&quot;</span><span class="token operator">+</span><span class="token string">&quot;偏移量: &quot;</span><span class="token operator">+</span>metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 出现异常打印</span>
                        exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_7-kafka原生api高阶篇" tabindex="-1"><a class="header-anchor" href="#_7-kafka原生api高阶篇" aria-hidden="true">#</a> 7. Kafka原生API高阶篇</h1><h2 id="_7-1-生产者消费者配置类" tabindex="-1"><a class="header-anchor" href="#_7-1-生产者消费者配置类" aria-hidden="true">#</a> 7.1 生产者消费者配置类</h2><h3 id="_7-1-1-生产者配置类producerconfig" tabindex="-1"><a class="header-anchor" href="#_7-1-1-生产者配置类producerconfig" aria-hidden="true">#</a> <strong>7.1.1 生产者配置类ProducerConfig</strong></h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerParameters</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.1.170:9091&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.Kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.Kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// batch.size：批次大小，默认16K</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BATCH_SIZE_CONFIG</span><span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// linger.ms：等待时间，默认0</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">LINGER_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// RecordAccumulator：缓冲区大小，默认32M：buffer.memory</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BUFFER_MEMORY_CONFIG</span><span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// compression.type：压缩，默认none，可配置值gzip、snappy、lz4和zstd(2.1.0开始支持)四种压缩算法</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">COMPRESSION_TYPE_CONFIG</span><span class="token punctuation">,</span><span class="token string">&quot;snappy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>四种压缩算法对比：CPU资源充足，带宽资源有限时可以考虑使用压缩算法压缩消息。</strong></p><table><thead><tr><th><strong>压缩类型</strong></th><th><strong>压缩比率</strong></th><th><strong>CPU 使用率</strong></th><th><strong>压缩速度</strong></th><th><strong>带宽使用率</strong></th></tr></thead><tbody><tr><td><strong>Gzip</strong></td><td><strong>高</strong></td><td><strong>高</strong></td><td><strong>慢</strong></td><td><strong>低</strong></td></tr><tr><td><strong>Snappy</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td></tr><tr><td><strong>Lz4</strong></td><td><strong>低</strong></td><td><strong>低</strong></td><td><strong>快</strong></td><td><strong>高</strong></td></tr><tr><td><strong>Zstd</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td><td><strong>一般</strong></td></tr></tbody></table><h3 id="_7-1-2-消费者配置consumerconfig" tabindex="-1"><a class="header-anchor" href="#_7-1-2-消费者配置consumerconfig" aria-hidden="true">#</a> <strong>7.1.2 消费者配置ConsumerConfig</strong></h3><table><thead><tr><th><strong>参数名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>bootstrap.servers</strong></td><td><strong>向Kafka集群建立初始连接用到的host/port列表。</strong></td></tr><tr><td><strong>key.deserializer和value.deserializer</strong></td><td><strong>指定接收消息的key和value的反序列化类型。一定要写全类名。</strong></td></tr><tr><td><strong>group.id</strong></td><td><strong>标记消费者所属的消费者组。</strong></td></tr><tr><td><strong>partition.assignment.strategy</strong></td><td><strong>消费者分区分配策略，默认策略是Range + CooperativeSticky。Kafka可以同时使用多个分区分配策略。可以选择的策略包括：Range、RoundRobin、Sticky、CooperativeSticky</strong></td></tr><tr><td><strong>enable.auto.commit</strong></td><td><strong>默认值为true，消费者会自动周期性地向服务器提交偏移量。</strong></td></tr><tr><td><strong>auto.commit.interval.ms</strong></td><td><strong>如果设置了 enable.auto.commit 的值为true， 则该值定义了消费者偏移量向Kafka提交的频率，默认5s。</strong></td></tr><tr><td><strong>auto.offset.reset</strong></td><td><strong>当Kafka中没有初始偏移量或当前偏移量在服务器中不存在（如，数据被删除了），该如何处理？ earliest：自动重置偏移量到最早的偏移量。 latest：默认，自动重置偏移量为最新的偏移量。 none：如果消费组原来的（previous）偏移量不存在，则向消费者抛异常。 anything：向消费者抛异常。</strong></td></tr><tr><td><strong>offsets.topic.num.partitions</strong></td><td><strong>__consumer_offsets的分区数，默认是50个分区。</strong></td></tr><tr><td><strong>heartbeat.interval.ms</strong></td><td><strong>Kafka消费者和coordinator之间的心跳时间，默认3s。该条目的值必须小于 session.timeout.ms ，也不应该高于 session.timeout.ms 的1/3。</strong></td></tr><tr><td><strong>session.timeout.ms</strong></td><td><strong>Kafka消费者和coordinator之间连接超时时间，默认45s。超过该值，该消费者被移除，消费者组执行再平衡。</strong></td></tr><tr><td><strong>max.poll.interval.ms</strong></td><td><strong>消费者处理消息的最大时长，默认是5分钟。超过该值，该消费者被移除，消费者组执行再平衡。</strong></td></tr><tr><td><strong>fetch.min.bytes</strong></td><td><strong>默认1个字节。消费者获取服务器端一批消息最小的字节数。</strong></td></tr><tr><td><strong>fetch.max.wait.ms</strong></td><td><strong>默认500ms。如果没有从服务器端获取到一批数据的最小字节数。该时间到，仍然会返回数据。</strong></td></tr><tr><td><strong>fetch.max.bytes</strong></td><td><strong>默认Default: 52428800（50 m）。消费者获取服务器端一批消息最大的字节数。如果服务器端一批次的数据大于该值（50m）仍然可以拉取回来这批数据，因此，这不是一个绝对最大值。一批次的大小受message.max.bytes （broker config）or max.message.bytes （topic config）影响。</strong></td></tr><tr><td><strong>max.poll.records</strong></td><td><strong>一次poll拉取数据返回消息的最大条数，默认是500条。</strong></td></tr></tbody></table><h2 id="_7-2-生产者分区" tabindex="-1"><a class="header-anchor" href="#_7-2-生产者分区" aria-hidden="true">#</a> <strong>7.2 生产者分区</strong></h2><h3 id="_7-2-1-生产者分区介绍" tabindex="-1"><a class="header-anchor" href="#_7-2-1-生产者分区介绍" aria-hidden="true">#</a> <strong>7.2.1 生产者分区介绍</strong></h3><p><strong>Kafka可以将主题划分为多个分区（Partition），会根据分区规则选择把消息存储到哪个分区中</strong></p><p><strong><img src="`+mn+'" alt="image-20230624201927263"></strong></p><p><strong>（1）便于合理使用存储资源，每个Partition在一个Broker上存储，可以把海量的数据按照分区切割成一块一块数据存储在多台Broker上。合理控制分区的任务，可以实现负载均衡的效果。</strong></p><p><strong>（2）提高并行度，生产者可以以分区为单位发送数据；消费者可以以分区为单位进行消费数据。</strong></p><p><img src="'+vn+`" alt="image-20230910142921721"></p><h3 id="_7-2-2-生产者分区策略" tabindex="-1"><a class="header-anchor" href="#_7-2-2-生产者分区策略" aria-hidden="true">#</a> <strong>7.2.2 生产者分区策略</strong></h3><p><strong>生产者分区策略是决定⽣产者将消息发送到哪个分区的算法。Kafka 为我们提供了默认的分区策略，同时它也⽀持你⾃定义分区策略。</strong></p><p><strong>在通过KafkaProducer的send方法发送包装成了ProducerRecord对象的消息时，必须要为ProducerRecord对象指定目标主题（topic）和消息内容（value），另外还有两个可选属性键：（key）和分区号（partition）。</strong></p><ul><li><p><strong>如果消息ProducerRecord指定分区发送，就不会使用到分区器。指定分区发送的实现方式，是在消息ProducerRecord设置分区号；</strong></p></li><li><p><strong>如果不指定分区发送，则需要使用分区器经过规则计算出partition分区号，将消息发送到指定的分区。</strong></p></li></ul><h3 id="_7-2-3-键和分区号的作用" tabindex="-1"><a class="header-anchor" href="#_7-2-3-键和分区号的作用" aria-hidden="true">#</a> <strong>7.2.3 键和分区号的作用</strong></h3><h4 id="_7-2-3-1-测试案例1-键为空-不指定分区值" tabindex="-1"><a class="header-anchor" href="#_7-2-3-1-测试案例1-键为空-不指定分区值" aria-hidden="true">#</a> <strong>7.2.3.1 测试案例1: 键为空，不指定分区值</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:28
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitions</span>
<span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;second&quot;</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不指定分区，key为空</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行结果：</strong></p><p><strong><img src="`+gn+`" alt="image-20230618172112600"></strong></p><h4 id="_7-2-3-2-测试案例2-键为空-指定分区值" tabindex="-1"><a class="header-anchor" href="#_7-2-3-2-测试案例2-键为空-指定分区值" aria-hidden="true">#</a> <strong>7.2.3.2 测试案例2:键为空，指定分区值</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:35
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitions2</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;second&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 指定分区，key为空</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试结果：</strong></p><p><strong><img src="`+bn+`" alt="image-20230618172948921"></strong></p><h4 id="_7-2-3-3-测试案例3-键不为空-不指定分区值" tabindex="-1"><a class="header-anchor" href="#_7-2-3-3-测试案例3-键不为空-不指定分区值" aria-hidden="true">#</a> <strong>7.2.3.3 测试案例3:键不为空，不指定分区值</strong></h4><p><strong>当前场景会将key的hash值与topic的partition数进行取余得到partition值。</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:37
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitions3</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 依次指定key值为a,b,f ，数据key的hash值与3个分区求余，分别发往1、2、0</span>
            key <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span><span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试结果：</strong></p><p><strong>①key=&quot;a&quot;时</strong></p><p><strong><img src="`+fn+'" alt="image-20230618174131714"></strong></p><p><strong>②key=&quot;b&quot;时</strong></p><p><strong><img src="'+hn+'" alt="image-20230618174216958"></strong></p><p><strong>③key=&quot;f&quot;时</strong></p><p><strong><img src="'+yn+`" alt="image-20230618174028329"></strong></p><h3 id="_7-2-4-默认分区器defaultpartitioner" tabindex="-1"><a class="header-anchor" href="#_7-2-4-默认分区器defaultpartitioner" aria-hidden="true">#</a> <strong>7.2.4 默认分区器DefaultPartitioner</strong></h3><p><strong>上述分区案例策略逻辑总结如下：</strong></p><p><strong>（1）指明partition的情况下，直接写入到指定partition分区；</strong><strong>例如partition=0，所有数据写入分区0</strong></p><p><strong>（2）没有指明partition值但有key的情况下，使用murmur2hash算法计算key的hash值与topic的partition数进行取余得到partition值；</strong> 例如：key1的hash值=5， key2的hash值=6 ，topic的partition数=2，那么</p><p>​ key1 对应的value1写入1号分区(5÷2余数1)，key2对应的value2写入0号分区(6÷2余数0)。</p><p><strong>（3）既没有partition值又没有key值的情况下，Kafka采用Sticky Partition（黏性分区器），会随机选择一个分区，并尽可能一直使用该分区，待该分区的batch（默认16k）已满或者已完成，Kafka再随机一个分区进行使用（和上一次的分区不同）。</strong> 例如：第一次随机选择0号分区，等0号分区当前批次满了或者linger.ms设置的时间到， Kafka再随机一个分区进行使用（如果还是0会继续随机）。</p><h3 id="_7-2-5-轮询分区器roundrobinpartitioner" tabindex="-1"><a class="header-anchor" href="#_7-2-5-轮询分区器roundrobinpartitioner" aria-hidden="true">#</a> <strong>7.2.5 轮询分区器RoundRobinPartitioner</strong></h3><p><strong>轮询分区器，将消息均匀地分配给每一个分区。</strong></p><p><strong>注意：在实际使用过程中，RoundRobinPartitioner分区器并不能真正的将将消息均匀地分配给每一个分区，而是将消费分配给第偶数分区（第0、2、4....个）。如果想要轮询效果，建议自定义分区策略。</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:45
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackRoundRobinPartitioner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;second&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置Kafka提供的RoundRobinPartitioner轮询分区器</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">PARTITIONER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">&quot;org.apache.kafka.clients.producer.RoundRobinPartitioner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试结果：</strong></p><p><strong><img src="`+_n+`" alt="image-20230618182243962"></strong></p><h3 id="_7-2-6-自定义分区器" tabindex="-1"><a class="header-anchor" href="#_7-2-6-自定义分区器" aria-hidden="true">#</a> <strong>7.2.6 自定义分区器</strong></h3><p><strong>我们实现一个自定义分区器，发送过来的数据中如果包含atguigu发往0号分区，包含sgg发往1号分区，其他的发往2号分区。</strong></p><h4 id="_7-2-6-1-实现自定义分区器" tabindex="-1"><a class="header-anchor" href="#_7-2-6-1-实现自定义分区器" aria-hidden="true">#</a> <strong>7.2.6.1 实现自定义分区器</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Cluster</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:47
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span>
<span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 返回信息发往的分区
     * <span class="token keyword">@param</span> <span class="token parameter">topic</span>         主题
     * <span class="token keyword">@param</span> <span class="token parameter">key</span>           消息的key
     * <span class="token keyword">@param</span> <span class="token parameter">keyBytes</span>      消息的key序列化后的字节数组
     * <span class="token keyword">@param</span> <span class="token parameter">value</span>         消息的value
     * <span class="token keyword">@param</span> <span class="token parameter">valueBytes</span>    消息的value序列化后的字节数组
     * <span class="token keyword">@param</span> <span class="token parameter">cluster</span>       集群元数据可以查看分区信息
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取消息</span>
        <span class="token class-name">String</span> msgValue <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建partition</span>
        <span class="token keyword">int</span> partition<span class="token punctuation">;</span>
        <span class="token comment">// 判断消息是否包含atguigu</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msgValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;sgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回分区号</span>
        <span class="token keyword">return</span> partition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 关闭资源</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 配置方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-2-6-2-发送消息配置使用自定义分区器" tabindex="-1"><a class="header-anchor" href="#_7-2-6-2-发送消息配置使用自定义分区器" aria-hidden="true">#</a> <strong>7.2.6.2 发送消息配置使用自定义分区器</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>partitions</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 14:49
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitionsBySelf</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;second&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置Kafka提供的RoundRobinPartitioner轮询分区器</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">PARTITIONER_CLASS_CONFIG</span><span class="token punctuation">,</span><span class="token string">&quot;com.atguigu.kafka.partitions.MyPartitioner&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//String  myValue = &quot;sgg&quot;;//分区：1</span>
        <span class="token class-name">String</span>  myValue <span class="token operator">=</span> <span class="token string">&quot;atguigu&quot;</span><span class="token punctuation">;</span><span class="token comment">//分区：0</span>
        <span class="token comment">//其它分区2</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">,</span> myValue <span class="token operator">+</span> i<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主题：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&gt;&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;分区：&quot;</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>测试结果：分别发送携带atguigu、sgg等信息测试。</strong></p>`,60),Ts=e(`<p><strong>分区为了提供负载均衡的能力，实现系统的高伸缩性。分区策略是决定生产者将消息发送到哪个分区的算法,避免造成数据“倾斜”</strong></p><p><strong>Kafka提供了默认的分区策略，同时也支持自定义的分区策略</strong></p><ul><li><strong>默认分区策略：如果指定了 Key，那么默认实现按消息键保序策略；如果没有指定 Key，则使用轮询策略。</strong></li><li><strong>自定义分区策略（限制配置生产者端的参数 partitioner.class,编写一个具体的类实现org.apache.kafka.clients.producer.Partitioner接口）：</strong><ul><li><strong>轮询策略（Round-robin）</strong></li><li><strong>随机策略（Randomness）</strong></li><li><strong>按消息键保序策略（Key-ordering）：保证同一个 Key 的所有消息都进入到相同的分区里</strong></li></ul></li></ul><h2 id="_7-3-发送消息ack可靠性" tabindex="-1"><a class="header-anchor" href="#_7-3-发送消息ack可靠性" aria-hidden="true">#</a> 7.3 发送消息ack可靠性</h2><h3 id="_7-3-1-生产者数据可靠性配置" tabindex="-1"><a class="header-anchor" href="#_7-3-1-生产者数据可靠性配置" aria-hidden="true">#</a> <strong>7.3.1 生产者数据可靠性配置</strong></h3><p><strong>Kafka支持了ack机制，保证生产者可以将消息可靠的发送到达broker。</strong></p><p><strong>生产者发送消息时可以配置ack的值：ProducerConfig.ACKS_CONFIG</strong></p><ul><li><p><strong>acks=0：生产者发送过来数据，就不管了，可靠性差数据会丢，效率最高</strong></p></li><li><p><strong>acks=1：生产者发送过来数据，只需要Leader确认即可返回，可靠性中等，效率中等</strong></p></li><li><p><strong>acks=-1(all)：生产者发送过来数据，Leader和ISR队列里面所有Follwer应答，可靠性高效率最低</strong></p></li></ul><p><strong>在生产环境中：</strong></p><ul><li><strong>acks=0很少使用；</strong></li><li><strong>acks=1，一般用于传输普通日志，允许丢个别数据；</strong></li><li><strong>acks=-1(all)，一般用于传输重要不能丢失的数据(例如：钱、订单、积分等)，对可靠性要求比较高的场景。</strong></li></ul><p><strong>测试代码：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerAck</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.1.170:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置acks  可以设置 &quot;0&quot;,&quot;1&quot;或者&quot;all&quot;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">ACKS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重试次数retries，默认Integer.MAX_VALUE （RETRY_BACKOFF_MS_CONFIG：重试间隔毫秒）</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">RETRIES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 创建Kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用send方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;atguigu &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-4-kafka消费模式" tabindex="-1"><a class="header-anchor" href="#_7-4-kafka消费模式" aria-hidden="true">#</a> <strong>7.4 Kafka消费模式</strong></h2><p><strong>Kafka有两种模式消费数据：</strong></p><p><strong>1、pull(拉模式，也叫发布订阅模式)：Kafka现在使用的方式，消费者可以自主选择从哪个分区开始拉取消息，并可以自主控制拉取消息的速度。Kafka 中为消费者维护着一个 offset，表示消费者已经消费的消息序号，当消费者拉取消息时，Kafka会返回该消费者还未消费的消息。虽然相比push模式实时性低一些，但是消费者灵活性高可以减少资源浪费。Kafka现在采用这种方式。</strong></p><ul><li><p><strong>可以有多个topic主题(例如：发送短息、发送邮件、保存日志等)</strong></p></li><li><p><strong>消费者消费数据后,不会删除数据</strong></p></li><li><p><strong>消费数据的多个消费者都可以消费到数据</strong></p></li></ul><p><strong><img src="`+wn+'" alt="image-20230618094421625"></strong></p><p><strong>2、push(推模式，也叫点对点模式)：Kafka最初的默认方式，此模式生产者将消息直接推送到 Kafka 集群中的分区中，分区自动将消息存储在磁盘上，并异步将消息传输到消费者。生产者主动控制消息的推送速度，消费者则以自己的速度从Kafka集群中拉取可用消息。虽然push模式实时性高，但是可能会发送大量重复或无效消息，浪费资源。</strong></p><ul><li><strong>消费者主动拉取数据，消息收到后删除消息，每个消费者都属于不同的消费者组</strong></li></ul><p><strong><img src="'+qn+'" alt="image-20230618093627180"></strong></p><h2 id="_7-5-消费者组" tabindex="-1"><a class="header-anchor" href="#_7-5-消费者组" aria-hidden="true">#</a> <strong>7.5 消费者组</strong></h2><p><strong>所有的消费者都属于某个消费者组，即消费者组是逻辑上的一个订阅者。</strong></p><h3 id="_7-5-1-消费者组介绍" tabindex="-1"><a class="header-anchor" href="#_7-5-1-消费者组介绍" aria-hidden="true">#</a> <strong>7.5.1 消费者组介绍</strong></h3><p><strong>Consumer Group（CG）：消费者组，由多个consumer组成。groupid相同的消费者们会形成一个消费者组。没有指定groupid的消费者</strong></p><p><strong>消费者组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费。</strong></p><ul><li><strong>消费者组之间互不影响。</strong></li></ul><p><strong><img src="'+Sn+'" alt="image-20230619205607970"></strong></p><ul><li><strong>如果向消费组中添加更多的消费者，超过主题分区数量，则有一部分消费者就会闲置，不会接收任何消息。</strong></li></ul><p><strong><img src="'+xn+'" alt="image-20230619205910433"></strong></p><ul><li><strong>消费者组之间互不影响。</strong></li></ul><p><strong><img src="'+Pn+'" alt="image-20230619205947191"></strong></p><h2 id="_7-6-offset偏移量" tabindex="-1"><a class="header-anchor" href="#_7-6-offset偏移量" aria-hidden="true">#</a> <strong>7.6 offset偏移量</strong></h2><h3 id="_7-6-1-offset说明" tabindex="-1"><a class="header-anchor" href="#_7-6-1-offset说明" aria-hidden="true">#</a> <strong>7.6.1 offset说明</strong></h3>',33),Es=n("p",null,[n("strong",null,"每个分区无论Leader还是Follower，都有一个LEO（log end offset，如下图虚线标注）日志末端offset，表示生产者待写入消息的offset。")],-1),zs=n("p",null,[n("strong",null,[n("img",{src:Cn,alt:"file"})])],-1),Rs=e('<p><strong>Kafka会创建__consumer_offsets主题来保存 consumer 提交的位移，并采用key和value的方式存储：</strong></p><p><strong>key是group.id+topic+分区号，value就是当前offset的值。</strong></p><p><strong>consumer 根据offset依次消费消息。</strong></p><p><strong>同一个消费者/消费者组也可以通过重置offset多次消费某些数据，或者跳过消费某些数据。</strong></p><p><strong><img src="'+Kn+'" alt="image-20211217110322026"></strong></p><p><strong>消费者消费数据时，会涉及到下图所示的几个概念：</strong></p><ul><li><p><strong>HW(high watermark高水位)：消费者最多能消费到的位置，也就是该分区Leader和所有Follower都到达的位置。如下图[0,8]都可以被消费，[9,12]Follower正在同步数据还未提交对消费者不可见</strong></p></li><li><p><strong>LEO(log end offset)：待写入消息的offset，此位置暂时没有消息。</strong></p></li></ul><p><strong><img src="'+In+'" alt="image-20211217110358983"></strong></p><p><strong>Kafka提供了offset提交机制，使得Kafka在消费的过程中即使挂了或者引发再均衡问题重新分配Partation，恢复消费时仍然知道从哪里开始消费。</strong></p><p><strong>Kafka的offset有两种提交方式：</strong></p><p>(1) 自动提交(默认方式)</p><p><strong>(2) 手动提交(可以灵活地控制offset)</strong></p><h3 id="_7-6-2-自动提交offset" tabindex="-1"><a class="header-anchor" href="#_7-6-2-自动提交offset" aria-hidden="true">#</a> <strong>7.6.2 自动提交offset</strong></h3><p><strong>自动提交offset可以让我们能够专注于自己的业务逻辑。</strong></p><p><strong>Kafka中偏移量的自动提交是由参数<code>enable_auto_commit</code>和<code>auto_commit_interval_ms</code>控制的，当<code>enable_auto_commit=true</code>时，Kafka在消费时会以频率为<code>auto_commit_interval_ms</code>（默认5秒）将offset提交到Kafka的__consumer_offsets主题中。</strong></p><p><strong><img src="'+Tn+`" alt="image-20230619212042741"></strong></p><p><strong>消费者自动提交offset案例：先在IDEA工具里面启动消费者开始监听</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>senior</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 15:19
 先在IDEA工具里面启动消费者开始监听,再去生产者发送消息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetSeniorDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消费者组指定ID，每个消费者都在一个消费者组里面，是消费者组去订阅了Topic</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认值为true，消费者会自动周期性地向服务器提交偏移量,true表示读过的就不来了</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置了 enable.auto.commit 的值为true， 则该值定义了消费者偏移量向Kafka提交的频率，默认5s。</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消费者仅关闭自动提交，但没有手动提交，导致重复消费案例：等30秒内</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>senior</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 15:28
 *
 * **消费者仅关闭自动提交，但没有手动提交，导致重复消费案例：等30秒内**
 *
 *  1 先启动一个消费者，出来结果抓个图
 *
 *  2 再启动一个消费者，看结果和第一次对比，发现一样内容被重复消费了。
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetCloseSeniorDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+En+'" alt="image-20230811105100769"></p><p>消费者消费消息以后自动提交，只有当消息提交以后，该消息才不会被再次接收到，</p><p>还可以配合auto.commit.interval.ms控制自动提交的频率。 有自动必然有手动，我们也可以通过consumer.commitSync()的方式实现手动提交</p><h3 id="_7-6-3-手动提交offset" tabindex="-1"><a class="header-anchor" href="#_7-6-3-手动提交offset" aria-hidden="true">#</a> <strong>7.6.3 手动提交offset</strong></h3><p>鉴于Kafka自动提交offset的不灵活性和不精确性(只能按指定频率提交)，Kafka提供了手动提交offset策略。手动提交能对偏移量更加灵活精准地控制，以保证消息不被重复消费以及消息不被丢失。</p><p><strong>手动提交offset的方法有两种：</strong></p><p><strong>commitSync（手动提交offset之同步提交）：必须等待offset提交完毕，再去消费下一批数据。</strong></p><p><strong>commitAsync（手动提交offset之异步提交）：发送完提交offset请求后，就开始消费下一批数据了。</strong></p><p><strong>两者都会将本次提交的一批数据最高的偏移量提交；不同的是，同步提交阻塞当前线程，一直到提交成功，并且会自动失败重试（仍会出现提交失败），而异步提交则没有失败重试机制，当消费者异常关闭或者触发了再均衡前，偏移量还未提交会造成偏移量丢失。</strong></p><p><strong><img src="'+zn+`" alt="image-20230619212251944"></strong></p><h4 id="_7-6-3-1-同步提交offset" tabindex="-1"><a class="header-anchor" href="#_7-6-3-1-同步提交offset" aria-hidden="true">#</a> <strong>7.6.3.1 同步提交offset</strong></h4><p><strong>由于同步提交offset有失败重试机制，故更加可靠，但是由于一直等待提交结果，提交的效率比较低。以下为同步提交offset的示例。</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>senior</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 15:33
 *
 * commitSync（手动提交offset之同步提交）：必须等待offset提交完毕，再去消费下一批数据。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetManualSeniorDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// !!!!!!!!!!!同步提交offset</span>
            <span class="token comment">//commitSync（手动提交offset之同步提交）：必须等待offset提交完毕，再去消费下一批数据。</span>
            consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&quot;enable.auto.commit&quot;设置为&quot;false&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-6-3-2-异步提交offset" tabindex="-1"><a class="header-anchor" href="#_7-6-3-2-异步提交offset" aria-hidden="true">#</a> <strong>7.6.3.2 异步提交offset</strong></h4><p><strong>虽然同步提交offset更可靠一些，但是由于其会阻塞当前线程，直到提交成功。因此吞吐量会受到很大的影响。因此更多的情况下，会选用异步提交offset的方式，然后配合回调函数在broker做出响应的时候记录错误信息。</strong></p><p><strong>以下为异步提交offset的示例：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>senior</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 15:39
 *
 * **commitAsync（手动提交offset之异步提交）：发送完提交offset请求后，就开始消费下一批数据了。**
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetManualV2SeniorDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// !!!!!!!!!!异步提交offset</span>
            <span class="token comment">// commitAsync（手动提交offset之异步提交）：发送完提交offset请求后，就开始消费下一批数据了。</span>
            consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//&quot;enable.auto.commit&quot;设置为&quot;false&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6-4-指定offset消费" tabindex="-1"><a class="header-anchor" href="#_7-6-4-指定offset消费" aria-hidden="true">#</a> <strong>7.6.4 指定Offset消费</strong></h3><p><strong>当Kafka中没有初始偏移量（消费者组第一次消费）或服务器上不再存在当前消费者偏移量时（例如该数据已被删除），该怎么办？</strong></p><p>**可以配置参数：**ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</p><p><strong>auto.offset.reset = earliest | latest | none 默认是latest。</strong></p><p><strong>（1）earliest：自动将偏移量重置为最早的偏移量，--from-beginning。对于新的GroupId来说，如果设置为earliest，它会从最早的消息开始进行消费，但是对于已经消费过的GroupId来说，它还是会从最大的offset取</strong></p><p><strong>（2）latest（默认值）：自动将偏移量重置为最新偏移量。对于新的GroupId来说，它直接取最近的值，就是已经消费且提交的最大的offset值</strong></p><p><strong>（3）none：如果未找到消费者组的先前偏移量，则向消费者抛出异常。</strong></p><p><img src="`+Rn+`" alt="img"></p><p><strong>测试案例：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>senior</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 15:51
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerAutoCommitOffSetResetSeniorDemo</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;senior&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建Kafka生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给Kafka配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.111.172:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;senior77&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认值为true，修改为false关闭自动提交，如没有手动提交会重复消费消息</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;enable.auto.commit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置 auto.offset.reset   none、latest、earliest</span>
        <span class="token comment">//none: 使用新的消费者组名时，找不到自己的offset 会抛出异常NoOffsetForPartitionException</span>
        <span class="token comment">//latest: 将offset设置为最新的</span>
        <span class="token comment">//earliest：将offset设置为最早的</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation">,</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token constant">TOPIC_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;....进行中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置1秒消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;offset = %d, key = %s, value = %s%n&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>新的GroupId，earliest</p></li><li><p>新的GroupId，lastest</p></li><li><p>新的GroupId，none</p><p><img src="`+An+`" alt="image-20230811165306451"></p></li></ol><h1 id="_8-kafka分布式集群搭建" tabindex="-1"><a class="header-anchor" href="#_8-kafka分布式集群搭建" aria-hidden="true">#</a> <strong>8. Kafka分布式集群搭建</strong></h1><h2 id="_8-1-kafka集群机制" tabindex="-1"><a class="header-anchor" href="#_8-1-kafka集群机制" aria-hidden="true">#</a> <strong>8.1 Kafka集群机制</strong></h2><ul><li><strong>Kafka是天然支持集群的，哪怕是一个节点实际上也是集群模式</strong></li><li><strong>Kafka集群依赖于Zookeeper进行协调，并且在早期的Kafka版本中很多数据都是存放在Zookeeper的</strong></li><li><strong>Kafka节点只要注册到同一个Zookeeper上就代表它们是同一个集群的</strong></li><li><strong>Kafka通过brokerId来区分集群中的不同节点</strong></li></ul><h2 id="_8-2-分析" tabindex="-1"><a class="header-anchor" href="#_8-2-分析" aria-hidden="true">#</a> <strong>8.2 分析</strong></h2><p><strong>为了测试方便，我们选择搭建伪分布式Kafka集群，在同一台虚拟机上启动</strong></p><p><strong>1个zookeeper实例，</strong></p><p><strong>3个Kafka实例搭建集群，创建Topic时可以分成3个partition,每个partition包括leader在内3个replication。</strong></p><p><strong>集群配置如下：</strong></p><table><thead><tr><th></th><th><strong>server1</strong></th><th><strong>server2</strong></th><th><strong>server3</strong></th></tr></thead><tbody><tr><td><strong>zookeeper</strong></td><td><strong>192.168.111.172:2181</strong></td><td><strong>192.168.111.172:2181</strong></td><td><strong>192.168.111.172:2181</strong></td></tr><tr><td><strong>kafka</strong></td><td><strong>192.168.111.172:9095</strong></td><td><strong>192.168.111.172:9096</strong></td><td><strong>192.168.111.172:9097</strong></td></tr><tr><td><strong>kafka配置文件</strong></td><td><strong>/mykafka/kafka3.5.1/config/server1.properties</strong></td><td><strong>/mykafka/kafka3.5.1/config/server2.properties</strong></td><td><strong>/mykafka/kafka3.5.1/config/server3.properties</strong></td></tr><tr><td><strong>kafka日志文件</strong></td><td><strong>/tmp/kafkacluster-logs1</strong></td><td><strong>/tmp/kafkacluster-logs2</strong></td><td><strong>/tmp/kafkacluster-logs3</strong></td></tr></tbody></table><h2 id="_8-3-搭建" tabindex="-1"><a class="header-anchor" href="#_8-3-搭建" aria-hidden="true">#</a> <strong>8.3 搭建</strong></h2><h3 id="_8-3-1-配置文件" tabindex="-1"><a class="header-anchor" href="#_8-3-1-配置文件" aria-hidden="true">#</a> <strong>8.3.1 配置文件</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 此步可选，也可以用原来单机版的zookeeper.properties，如果想单独为集群做一个zookeeper.properties</span>
<span class="token comment"># 进入/mykafka/kafka3.5.1路径下，准备zookeeper配置文件zookeeper.properties</span>
<span class="token function">cp</span> zookeeper.properties zookeeper4cluster.properties

<span class="token comment"># 进入/mykafka/kafka3.5.1/config路径下，准备Kafka配置文件，参考原来单机版server.properties</span>
<span class="token function">cp</span> server.properties server1.properties
<span class="token function">cp</span> server.properties server2.properties
<span class="token function">cp</span> server.properties server3.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Kafka实例1配置文件：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /mykafka/kafka3.5.1/config/server1.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>修改内容如下：</strong></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># Kafka实例1配置文件,配置完1后照着它拷贝进行2和3实例配置</span>
<span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9095</span>
<span class="token key attr-name">advertised.listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9095</span>
<span class="token key attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/kafkacluster-logs1</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.172:2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Kafka实例2配置文件：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /mykafka/kafka3.5.1/config/server2.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>修改内容如下：</strong></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">2</span>
<span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9096</span>
<span class="token key attr-name">advertised.listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9096</span>
<span class="token key attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/kafkacluster-logs2</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.172:2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Kafka实例3配置文件：</strong></p><p><strong>修改内容如下：</strong></p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">broker.id</span><span class="token punctuation">=</span><span class="token value attr-value">3</span>
<span class="token key attr-name">listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9097</span>
<span class="token key attr-name">advertised.listeners</span><span class="token punctuation">=</span><span class="token value attr-value">PLAINTEXT://192.168.111.172:9097</span>
<span class="token key attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token value attr-value">/tmp/kafkacluster-logs3</span>
<span class="token key attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.111.172:2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-2-修改kafka和zk的启动内存-可选-可选-可选" tabindex="-1"><a class="header-anchor" href="#_8-3-2-修改kafka和zk的启动内存-可选-可选-可选" aria-hidden="true">#</a> <strong>8.3.2 修改Kafka和zk的启动内存[可选+可选+可选]</strong></h3><p><strong>修改Kafka启动内存大小：</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /opt/Kafka/bin/Kafka-server-start.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>修改内容如下：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then
    export KAFKA_HEAP_OPTS=&quot;-Xmx256M -Xms256M&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>修改zk启动内存大小:</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /opt/Kafka/bin/zookeeper-server-start.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>修改内容如下：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then
    export KAFKA_HEAP_OPTS=&quot;-Xmx256M -Xms256M&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-3-启动zk" tabindex="-1"><a class="header-anchor" href="#_8-3-3-启动zk" aria-hidden="true">#</a> <strong>8.3.3 启动zk</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 等待2秒钟后请用命令lsof -i:2181查看zk是否成功启动，务必保证zk先OK</span>
<span class="token comment"># /mykafka/kafka3.5.1路径下，启动</span>
zookeeper-server-start.sh <span class="token parameter variable">-daemon</span>  config/zookeeper.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-4-启动kafka" tabindex="-1"><a class="header-anchor" href="#_8-3-4-启动kafka" aria-hidden="true">#</a> <strong>8.3.4 启动Kafka</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 先保证原来单机版的kafka实例关闭，9092端口不被占用</span>

<span class="token comment"># /mykafka/kafka3.5.1路径下，启动Kafka实例1</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server1.properties
<span class="token comment"># /mykafka/kafka3.5.1路径下，启动Kafka实例2</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server2.properties
<span class="token comment"># /mykafka/kafka3.5.1路径下，启动Kafka实例3</span>
kafka-server-start.sh <span class="token parameter variable">-daemon</span> config/server3.properties
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-5-查看启动是否成功" tabindex="-1"><a class="header-anchor" href="#_8-3-5-查看启动是否成功" aria-hidden="true">#</a> <strong>8.3.5 查看启动是否成功</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>jps <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> jps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+jn+`" alt="image-20230817122751774"></p><p><strong>如上图所示，三个Kafka和一个zk实例启动成功。</strong></p><h3 id="_8-3-6-停止kafka和zk" tabindex="-1"><a class="header-anchor" href="#_8-3-6-停止kafka和zk" aria-hidden="true">#</a> <strong>8.3.6 停止Kafka和zk</strong></h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 停止Kafka：</span>
kafka-server-stop.sh
<span class="token comment"># 停止zk</span>
zookeeper-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-5-使用集群" tabindex="-1"><a class="header-anchor" href="#_8-5-使用集群" aria-hidden="true">#</a> <strong>8.5 使用集群</strong></h2><h3 id="_8-5-1-创建集群主题" tabindex="-1"><a class="header-anchor" href="#_8-5-1-创建集群主题" aria-hidden="true">#</a> 8.5.1 创建集群主题</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 建立3个分区并给每个分区建立3个副本</span>
kafka-topics.sh --bootstrap-server 
<span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">3</span> <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+On+`" alt="image-20230817123137094"></p><h3 id="_8-5-2-查看集群主题" tabindex="-1"><a class="header-anchor" href="#_8-5-2-查看集群主题" aria-hidden="true">#</a> 8.5.2 查看集群主题</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+Nn+'" alt="image-20230817123223762"></p><p><img src="'+Ln+`" alt="image-20230816191642209"></p><h3 id="_8-5-3-集群消息发送" tabindex="-1"><a class="header-anchor" href="#_8-5-3-集群消息发送" aria-hidden="true">#</a> 8.5.3 集群消息发送</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-producer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097 <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+Mn+`" alt="image-20230817123413354"></p><h3 id="_8-5-4-集群消息消费" tabindex="-1"><a class="header-anchor" href="#_8-5-4-集群消息消费" aria-hidden="true">#</a> 8.5.4 集群消息消费</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097  --from-beginning <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+Bn+`" alt="image-20230817123457939"></p><h3 id="_8-5-4-集群相关命令" tabindex="-1"><a class="header-anchor" href="#_8-5-4-集群相关命令" aria-hidden="true">#</a> 8.5.4 集群相关命令</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> myclustertopic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>
新建
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097 <span class="token parameter variable">--create</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">3</span> <span class="token parameter variable">--topic</span> myclustertopic

删除
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> myclustertopic

kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> spring_test_topic


查看
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095 <span class="token parameter variable">--describe</span> <span class="token parameter variable">--topic</span> myclustertopic
kafka-topics.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9096 <span class="token parameter variable">--list</span>

发送

kafka-console-producer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097 <span class="token parameter variable">--topic</span> myclustertopic


消费
kafka-console-consumer.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9095,192.168.111.172:9096,192.168.111.172:9097  --from-beginning <span class="token parameter variable">--topic</span> myclustertopic

<span class="token comment"># 将消费者偏移量设置为最初偏移量</span>
kafka-consumer-groups.sh --bootstrap-server <span class="token number">192.168</span>.111.172:9092 <span class="token parameter variable">--group</span> group02 <span class="token parameter variable">--topic</span> kafkav1 --reset-offsets --to-earliest <span class="token parameter variable">--execute</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-5-集群环境消息可靠性解决方案" tabindex="-1"><a class="header-anchor" href="#_8-5-5-集群环境消息可靠性解决方案" aria-hidden="true">#</a> <strong>8.5.5 集群环境消息可靠性解决方案</strong></h3><p><strong>集群环境中一个主题有多个分区，一个分区又有一个leader和多个follower。</strong></p><p><strong>默认情况：生产者发送消息不需要等待应答，数据可靠性差。</strong></p><p><strong>解决：生产者发送的数据，leader接收到后应答。</strong></p><p><strong>情况2：生产者发送消息到分区的leader中，如果leader数据落盘ack应答但是follower还未同步时宕机，数据就丢失了。</strong></p><p><strong>解决：生产者发送的数据，leader和ISR(和leader保持同步的leader和follower集合)中所有的follower都接收/同步到数据后应答。</strong></p><p><strong>情况3：基于情况2的解决方案，如果有一个follower因为故障不能同步leader的数据，迟迟不能应答，问题该如何解决？</strong></p><p><strong>解决：将迟迟不能和leader同步的follower踢出ISR</strong></p><h1 id="_9-springboot整合kafka" tabindex="-1"><a class="header-anchor" href="#_9-springboot整合kafka" aria-hidden="true">#</a> <strong>9. SpringBoot整合Kafka</strong></h1><h2 id="_9-1-介绍" tabindex="-1"><a class="header-anchor" href="#_9-1-介绍" aria-hidden="true">#</a> <strong>9.1 介绍</strong></h2><p><strong>官网：https://spring.io/projects/spring-Kafka</strong></p><p><strong>SpringKafka提供了KafkaTemplate模板类和@KafkaListener注解简化了Kafka的使用</strong></p><p><strong><img src="`+Dn+'" alt="image-20230623211045190"></strong></p><h2 id="_9-2-生产者" tabindex="-1"><a class="header-anchor" href="#_9-2-生产者" aria-hidden="true">#</a> <strong>9.2 生产者</strong></h2><h3 id="_9-2-1-项目搭建" tabindex="-1"><a class="header-anchor" href="#_9-2-1-项目搭建" aria-hidden="true">#</a> <strong>9.2.1 项目搭建</strong></h3><h4 id="_9-2-1-1-创建项目" tabindex="-1"><a class="header-anchor" href="#_9-2-1-1-创建项目" aria-hidden="true">#</a> <strong>9.2.1.1 创建项目</strong></h4><p><strong>创建springboot项目：spring-kafka-producter</strong></p><p><strong><img src="'+Gn+`" alt="image-20230625210331393"></strong></p><h4 id="_9-2-1-2-引入依赖" tabindex="-1"><a class="header-anchor" href="#_9-2-1-2-引入依赖" aria-hidden="true">#</a> <strong>9.2.1.2 引入依赖</strong></h4><p><strong>修改springboot项目版本：3.1.0</strong></p><p><strong>引入spring-web和spring-Kafka依赖</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.atguigu.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka-producter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>spring-kafka-producter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>spring-kafka-producter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--spring-kafka--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--hutool--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.8.19<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-1-3-添加配置" tabindex="-1"><a class="header-anchor" href="#_9-2-1-3-添加配置" aria-hidden="true">#</a> <strong>9.2.1.3 添加配置</strong></h4><p><strong>application.yml配置----v1版</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8110</span>

<span class="token comment"># v1</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.111.172<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># value的序列化器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-2-新建主题" tabindex="-1"><a class="header-anchor" href="#_9-2-2-新建主题" aria-hidden="true">#</a> <strong>9.2.2 新建主题</strong></h3><p><strong>创建配置类：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConfig</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动生产者服务</strong></p><p><img src="`+Fn+'" alt="image-20230910164309000"></p><p><strong>通过Eagle控制台可以查看到主题新建成功：</strong></p><p><strong><img src="'+Un+`" alt="image-20230625213505026"></strong></p><h3 id="_9-2-3-发送消息" tabindex="-1"><a class="header-anchor" href="#_9-2-3-发送消息" aria-hidden="true">#</a> <strong>9.2.3 发送消息</strong></h3><h4 id="_9-2-3-1-发送简单消息" tabindex="-1"><a class="header-anchor" href="#_9-2-3-1-发送简单消息" aria-hidden="true">#</a> <strong>9.2.3.1 发送简单消息</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//参数1：主题名称</span>
    <span class="token comment">//参数2：消息内容</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello,Kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行测试代码，通过Eagle控制台可以查看到消息发送成功：</strong></p><p><strong><img src="`+Vn+`" alt="image-20230625215424568"></strong></p><h4 id="_9-2-3-2-生产者确认" tabindex="-1"><a class="header-anchor" href="#_9-2-3-2-生产者确认" aria-hidden="true">#</a> <strong>9.2.3.2 生产者确认</strong></h4><p><strong>生产者发送消息后接收到Kafka服务端应答acks可以通过回调确认消息是否发送成功</strong></p><p><strong>1、创建生产者监听器</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaSendResultHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerListener</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * Kafka发送成功回调
     * <span class="token keyword">@param</span> <span class="token parameter">producerRecord</span>
     * <span class="token keyword">@param</span> <span class="token parameter">recordMetadata</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;topic：{}，value：{}， 发送成功回调&quot;</span><span class="token punctuation">,</span>topic<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span> producerRecord<span class="token punctuation">,</span> <span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;topic：{}，value：{}， 发送失败，原因：{}&quot;</span><span class="token punctuation">,</span>topic<span class="token punctuation">,</span>value<span class="token punctuation">,</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、发送消息测试</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">class</span> <span class="token class-name">SpringKafkaProducterApplicationTests</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello,Kafka3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//阻塞：避免回调未执行时线程结束</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>成功时，控制台可以看到成功回调输出的日志：</strong></p><p><strong><img src="`+Hn+`" alt="image-20230625221400542"></strong></p><h4 id="_9-2-3-3-发送复杂消息" tabindex="-1"><a class="header-anchor" href="#_9-2-3-3-发送复杂消息" aria-hidden="true">#</a> <strong>9.2.3.3 发送复杂消息</strong></h4><p><strong>1、新建javabean</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、发送对象消息</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">class</span> <span class="token class-name">SpringKafkaProducterApplicationTests</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">//      kafkaTemplate.send(&quot;spring_test_topic&quot;,&quot;hello,Kafka3&quot;);</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token string">&quot;pangju&quot;</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token string">&quot;13512345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//阻塞：避免回调未执行时线程结束</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行报错：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Caused by: java.lang.ClassCastException: class com.atguigu.spring.Kafka.producter.bean.UserDTO cannot be cast to class java.lang.String (com.atguigu.spring.Kafka.producter.bean.UserDTO is in unnamed module of loader &#39;app&#39;; java.lang.String is in module java.base of loader &#39;bootstrap&#39;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>原因：生产者值的序列化器配置的是StringSerializer</strong></p><p><strong>解决：appication.yml中修改生产者序列化器</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8110</span>

<span class="token comment"># v1</span>
<span class="token comment">#spring:</span>
<span class="token comment">#  kafka:</span>
<span class="token comment">#    bootstrap-servers: 192.168.111.172:9095,192.168.111.172:9096,192.168.111.172:9097</span>
<span class="token comment">#    producer: # producer 生产者</span>
<span class="token comment">#      retries: 0 # 重试次数 0表示不重试</span>
<span class="token comment">#      acks: -1 # 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
<span class="token comment">#      batch-size: 16384 # 批次大小 单位byte</span>
<span class="token comment">#      buffer-memory: 33554432 # 生产者缓冲区大小 单位byte</span>
<span class="token comment">#      key-serializer: org.apache.kafka.common.serialization.StringSerializer # key的序列化器</span>
<span class="token comment">#      value-serializer: org.apache.kafka.common.serialization.StringSerializer # value的序列化器</span>
      
<span class="token comment"># v2      </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.111.172<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.springframework.kafka.support.serializer.JsonSerializer <span class="token comment"># 配置json序列化器      </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>再次执行发送对象消息的代码，可以正常发送：</strong></p><p>**<img src="`+Qn+`" alt="image-20230625223106680"></p><h4 id="_9-2-3-4-生产者拦截器" tabindex="-1"><a class="header-anchor" href="#_9-2-3-4-生产者拦截器" aria-hidden="true">#</a> <strong>9.2.3.4 生产者拦截器</strong></h4><p><strong>消息在通过 send() 方法发往 broker 的过程中，有可能依次经过拦截、序列化器和分区器 的一系列作用之后才被真正地发往 broker。</strong></p><p><strong>生产者拦截器既可以用来在消息发送前做一些准备工作，比如按照检查、修改消息内容，也可以用来在发送回调逻辑前做一些定制化的需求，比如统计工作。</strong></p><p><strong>需求：统计消息发送的成功率</strong></p><p><strong>1、创建生产者拦截器</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>interceptors</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">RecordMetadata</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@auther</span> zzyy
 * <span class="token keyword">@create</span> 2023-09-10 17:01
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">ProducerInterceptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> failure <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//消息发送前执行：可以对消息内容进行处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">onSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producerRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;即将发送的消息内容:{}&quot;</span><span class="token punctuation">,</span>producerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处可以修改producerRecord的属性值然后return</span>
        <span class="token keyword">return</span> producerRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Kafka服务端应答后，应答到达生产者确认回调前执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAcknowledgement</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">==</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//成功</span>
            success<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment">//失败</span>
            failure<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//拦截器销毁前执行</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送统计,成功数量：{}，失败数量：{}，成功比例：{}&quot;</span><span class="token punctuation">,</span>
                success<span class="token punctuation">,</span>failure<span class="token punctuation">,</span><span class="token punctuation">(</span>success<span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>success<span class="token operator">+</span>failure<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span><span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、KafkaTemplate配置生产者拦截器</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducerInterceptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">KafkaTemplate</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringKafkaProducterApplication</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">KafkaProducerInterceptor</span> kafkaProducerInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">setProducerInterceptor</span><span class="token punctuation">(</span>kafkaProducerInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----init success over,KafkaTemplate配置生产者拦截器kafkaProducerInterceptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringKafkaProducterApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3、测试代码发送消息</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMsgByProducerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span>i<span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token string">&quot;pangju&quot;</span><span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token string">&quot;13512345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>控制台日志：</strong></p><p><strong><img src="`+Zn+'" alt="image-20230625225817164"></strong></p>',176),As=e('<p><img src="'+Yn+'" alt="image-20230910171101193"></p><h3 id="_9-2-4-生产者事务" tabindex="-1"><a class="header-anchor" href="#_9-2-4-生产者事务" aria-hidden="true">#</a> *<em>9.2.4 生产者事务</em></h3><h4 id="_9-2-4-1-数据传递语义" tabindex="-1"><a class="header-anchor" href="#_9-2-4-1-数据传递语义" aria-hidden="true">#</a> <strong>9.2.4.1 数据传递语义</strong></h4><ul><li><p><strong>At Most Once（默认）：最多一次【允许为0次，数据可能丢失】</strong></p><p><strong>Producer禁止重试</strong></p></li><li><p><strong>At Least Once：至少一次【至少一次，允许多次，数据可能重复】</strong></p><p><strong>Producer开启了重试机制，当发送的消息没有收到Kafka集群成功的应答时会再次发送数据</strong></p></li><li><p><strong>Exactly Once：有且仅有一次【只有一次，精准数据传输】</strong></p><p><strong>Kafka通过幂等性和事务这两个机制保证了精准一次</strong></p></li></ul><p><strong>Kafka 0.11版本以后，引入了幂等性和事务。</strong></p><h4 id="_9-2-4-2-幂等性" tabindex="-1"><a class="header-anchor" href="#_9-2-4-2-幂等性" aria-hidden="true">#</a> <strong>9.2.4.2 幂等性</strong></h4><p><strong>什么是幂等性?</strong></p><p><strong>幂等性就是指Producer不论向Broker发送多少次重复数据，Broker端都只会持久化一条，保证了不重复。</strong></p><p><strong><img src="'+Xn+'" alt="image-20230619204352039"></strong></p><h4 id="_9-2-4-3-springkafka事务" tabindex="-1"><a class="header-anchor" href="#_9-2-4-3-springkafka事务" aria-hidden="true">#</a> <strong>9.2.4.3 springkafka事务</strong></h4><p><strong>幂等性只能保证单次会话内的精准一次性，不能解决跨会话和跨分区的问题。事务保证Kafka在 Exactly Once 语义的基础上，Producer 和 Consumer 可以跨分区会话，要么全部成功，要么全部失败。</strong></p><p><strong>Kafka事务是指一系列的生产者生产消息和消费者提交偏移量的操作在一个事务中，是一个原子操作，同时成功或者失败。</strong></p><p><strong><code>Kafka</code>事务操作有一些要求，首先<code>acks=all</code>，要确保每个节点都能同步消息，同时<code>retries&gt;0</code>，满足这2个条件后，就可以使用<code>Kafka</code>事务。</strong></p><p></p><p><strong>1、事务配置,yml---V3</strong></p><p><strong><img src="'+Wn+`" alt="image-20230626213637222"></strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 重试次数</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span>
      <span class="token comment"># 事务前缀：配置后producer自动开启事务</span>
      <span class="token key atrule">transaction-id-prefix</span><span class="token punctuation">:</span> tx_
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、测试代码</strong></p><p><strong>测试发送两条消息，并在中间制造异常</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//添加事务注解：会自动回滚</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token comment">//        kafkaTemplate.send(&quot;spring_test_topic&quot;,&quot;key&quot;,&quot;trans_data1&quot;);</span>
    <span class="token comment">//        int i = 1/0;</span>
    <span class="token comment">//        kafkaTemplate.send(&quot;spring_test_topic&quot;,&quot;trans_data2&quot;);</span>
    <span class="token comment">//事务多消息发送：和上面效果一致</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">executeInTransaction</span><span class="token punctuation">(</span>operations <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        operations<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;trans_data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
        operations<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;trans_data2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行测试，可以看到生产者监听器的消息发送失败的日志：</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>KafkaSendResultHandler: topic：spring_test_topic，value：trans_data1， 发送失败，原因：Failing batch since transaction was aborted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_9-2-5-生产者数据有序" tabindex="-1"><a class="header-anchor" href="#_9-2-5-生产者数据有序" aria-hidden="true">#</a> <strong>9.2.5 生产者数据有序</strong></h3><p><strong>Kafka 最多只保证单分区内的消息是有序的，所以如果要保证业务全局严格有序，就要设置 Topic 为单分区。但是，某批次的数据发送失败后，进行了重试，也可能出现后边的批次先于它到达的情况。</strong></p><p><strong>如何保证单分区内数据有序or怎么解决乱序？</strong></p><p><strong>解决方案：</strong><strong>通过将指定key的消息发送到同一个分区，可以保证消息的局部有序，因为Kafka可以保证同一个分区的消息是严格有序的，然后设置retries等于0</strong></p><p><strong>1、配置重试次数，将application.yml恢复到V2版本配置</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment"># v2</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.111.172<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">producer</span><span class="token punctuation">:</span> <span class="token comment"># producer 生产者</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 重试次数 0表示不重试</span>
      <span class="token key atrule">acks</span><span class="token punctuation">:</span> <span class="token number">-1</span> <span class="token comment"># 应答级别:多少个分区副本备份完成时向生产者发送ack确认(可选0、1、-1/all)</span>
      <span class="token key atrule">batch-size</span><span class="token punctuation">:</span> <span class="token number">16384</span> <span class="token comment"># 批次大小 单位byte</span>
      <span class="token key atrule">buffer-memory</span><span class="token punctuation">:</span> <span class="token number">33554432</span> <span class="token comment"># 生产者缓冲区大小 单位byte</span>
      <span class="token key atrule">key-serializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringSerializer <span class="token comment"># key的序列化器</span>
      <span class="token key atrule">value-serializer</span><span class="token punctuation">:</span> org.springframework.kafka.support.serializer.JsonSerializer <span class="token comment"># 配置json序列化器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、发送消息时指定key保证发送到同一个分区</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> kafkaTemplate2<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendMsgBysendMsgSamePartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>kafkaTemplate2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ordered_data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>kafkaTemplate2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ordered_data1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRecordMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-3-消费者" tabindex="-1"><a class="header-anchor" href="#_9-3-消费者" aria-hidden="true">#</a> <strong>9.3 消费者</strong></h2><h3 id="_9-3-1-项目搭建" tabindex="-1"><a class="header-anchor" href="#_9-3-1-项目搭建" aria-hidden="true">#</a> <strong>9.3.1 项目搭建</strong></h3><h4 id="_9-3-1-1-创建项目" tabindex="-1"><a class="header-anchor" href="#_9-3-1-1-创建项目" aria-hidden="true">#</a> <strong>9.3.1.1 创建项目</strong></h4><p><strong>创建springboot项目：spring-kafka-consumer</strong></p><p><strong><img src="`+Jn+`" alt="image-20230629203614581"></strong></p><h4 id="_9-3-1-2-引入依赖" tabindex="-1"><a class="header-anchor" href="#_9-3-1-2-引入依赖" aria-hidden="true">#</a> <strong>9.3.1.2 引入依赖</strong></h4><p><strong>修改springboot项目版本：3.1.0</strong></p><p><strong>引入spring-web和spring-Kafka依赖</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-1-3-添加配置-1" tabindex="-1"><a class="header-anchor" href="#_9-2-1-3-添加配置-1" aria-hidden="true">#</a> <strong>9.2.1.3 添加配置</strong></h4><p><strong>application.yml配置</strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8120</span>

<span class="token comment"># v1</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">Kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.111.172<span class="token punctuation">:</span><span class="token number">9095</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9096</span><span class="token punctuation">,</span>192.168.111.172<span class="token punctuation">:</span><span class="token number">9097</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span> <span class="token comment"># consumer消费者配置</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> consumer<span class="token punctuation">-</span>group <span class="token comment"># 默认的消费组ID</span>
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否自动提交offset</span>
      <span class="token key atrule">auto-commit-interval</span><span class="token punctuation">:</span> <span class="token number">120000</span> <span class="token comment"># 自动提交offset时间间隔2分钟。这期间服务异常停止时，再次重启会导致重复消费</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> latest  <span class="token comment"># 指定Offset消费:earliest | latest | none</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-2-简单消费" tabindex="-1"><a class="header-anchor" href="#_9-3-2-简单消费" aria-hidden="true">#</a> <strong>9.3.2 简单消费</strong></h3><h4 id="_9-3-2-1-前面已经有了spring-test-topic主题-直接复用或者命令自己创建一个" tabindex="-1"><a class="header-anchor" href="#_9-3-2-1-前面已经有了spring-test-topic主题-直接复用或者命令自己创建一个" aria-hidden="true">#</a> <strong>9.3.2.1 前面已经有了spring_test_topic主题，直接复用或者命令自己创建一个</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaInitConfig</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestTopic2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+$n+`" alt="image-20230910231610065"></p><h4 id="_9-3-2-2-创建消费者监听器" tabindex="-1"><a class="header-anchor" href="#_9-3-2-2-创建消费者监听器" aria-hidden="true">#</a> <strong>9.3.2.2 创建消费者监听器</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListeners</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 简单消费：
     * topics：消费的主题列表
     *	接收消息的两种方式：
     *	1、记录对象
     *		ConsumerRecord<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>String,</span> <span class="token attr-name">String</span><span class="token punctuation">&gt;</span></span> record
     *  2、通过注解获取
     *		@Payload String data,
     *		@Header(KafkaHeaders.RECEIVED_TOPIC) String topic,
     *		@Header(KafkaHeaders.RECEIVED_PARTITION_ID) int partition,
     *		@Header(KafkaHeaders.RECEIVED_MESSAGE_KEY) String key,
     *		@Header(KafkaHeaders.RECEIVED_TIMESTAMP) long ts
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simpleConsumer</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;进入simpleConsumer方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
                <span class="token string">&quot;分区 = %d, 偏移量 = %d, key = %s, 内容 = %s, 时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动消费者服务</strong></p><h4 id="_9-3-2-3-测试" tabindex="-1"><a class="header-anchor" href="#_9-3-2-3-测试" aria-hidden="true">#</a> <strong>9.3.2.3 测试</strong></h4><p><strong>在生产者服务中执行以下代码发送消息：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//注意：需要注释掉，生产者服务中的事务配置(transaction-id-prefix: tx_)</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendSimpleMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_topic&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;simple_data1_&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 或者直接命令开打，这是在控制台自己用命令干</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token operator">--</span>bootstrap<span class="token operator">-</span>server <span class="token number">192.168</span><span class="token number">.111</span><span class="token number">.172</span><span class="token operator">:</span><span class="token number">9095</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.111</span><span class="token number">.172</span><span class="token operator">:</span><span class="token number">9096</span><span class="token punctuation">,</span><span class="token number">192.168</span><span class="token number">.111</span><span class="token number">.172</span><span class="token operator">:</span><span class="token number">9097</span> <span class="token operator">--</span>topic spring_test_topic
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>消费者控制台：</strong></p><p><strong><img src="`+ns+`" alt="image-20230629211709251"></strong></p><h3 id="_9-3-3-消费指定分区" tabindex="-1"><a class="header-anchor" href="#_9-3-3-消费指定分区" aria-hidden="true">#</a> <strong>9.3.3 消费指定分区</strong></h3><h4 id="_9-3-3-1-消费者服务创建测试主题" tabindex="-1"><a class="header-anchor" href="#_9-3-3-1-消费者服务创建测试主题" aria-hidden="true">#</a> <strong>9.3.3.1 消费者服务创建测试主题</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaInitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestPartitionTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-3-2-消费者代码" tabindex="-1"><a class="header-anchor" href="#_9-3-3-2-消费者代码" aria-hidden="true">#</a> <strong>9.3.3.2 消费者代码</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
    topicPartitions <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@TopicPartition</span><span class="token punctuation">(</span>
            topic <span class="token operator">=</span> <span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">//消费分区2所有的消息</span>
            partitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">//指定消费的分区，并配置消费该分期的起始offset,注意partitions中配置的主题不能重复</span>
            partitionOffsets <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token comment">//分区0 offset从3开始消费</span>
                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                    partition <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                    initialOffset <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
                    relativeToCurrent<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//分区3 offset从0开始消费</span>
                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                    partition <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                    initialOffset <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                    relativeToCurrent<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByPartitionOffsets</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByPartitionOffsets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重启消费者服务</strong></p><h4 id="_9-3-3-3-生产者发送消息" tabindex="-1"><a class="header-anchor" href="#_9-3-3-3-生产者发送消息" aria-hidden="true">#</a> <strong>9.3.3.3 生产者发送消息</strong></h4><p><strong>生产者服务发送消息代码：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendPartitionMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_partition_topic&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;simple_data&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在生产者服务中执行代码发送消息：</strong></p><p><strong>消费者服务控制台：</strong></p><p><strong><img src="`+ss+`" alt="image-20230702170108082"></strong></p><h3 id="_9-3-4-指定起始偏移量消费" tabindex="-1"><a class="header-anchor" href="#_9-3-4-指定起始偏移量消费" aria-hidden="true">#</a> <strong>9.3.4 指定起始偏移量消费</strong></h3><h4 id="_9-3-4-1-消费者服务创建测试主题" tabindex="-1"><a class="header-anchor" href="#_9-3-4-1-消费者服务创建测试主题" aria-hidden="true">#</a> <strong>9.3.4.1 消费者服务创建测试主题</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestOffsetTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_offset_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
        <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
        <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-4-2-消费者代码" tabindex="-1"><a class="header-anchor" href="#_9-3-4-2-消费者代码" aria-hidden="true">#</a> <strong>9.3.4.2 消费者代码</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
    topicPartitions <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@TopicPartition</span><span class="token punctuation">(</span>
            topic <span class="token operator">=</span> <span class="token string">&quot;spring_test_offset_topic&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">//消费分区2所有的消息</span>
            partitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">//指定消费的分区，并配置消费该分期的起始offset,注意partitions中配置的主题不能重复</span>
            partitionOffsets <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token comment">//分区0 offset从3开始消费</span>
                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                    partition <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                    initialOffset <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
                    relativeToCurrent<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//分区3 offset从0开始消费</span>
                <span class="token annotation punctuation">@PartitionOffset</span><span class="token punctuation">(</span>
                    partition <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                    initialOffset <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
                    relativeToCurrent<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByPartitionOffsets</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByPartitionOffsets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重启消费者服务</strong></p><h4 id="_9-3-4-3-生产者发送消息" tabindex="-1"><a class="header-anchor" href="#_9-3-4-3-生产者发送消息" aria-hidden="true">#</a> <strong>9.3.4.3 生产者发送消息</strong></h4><p><strong>生产者服务执行测试代码发送消息</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendOffsetMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_offset_topic&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;offset_data&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>观察消费者控制台</strong></p><h3 id="_9-3-5-手动提交offset" tabindex="-1"><a class="header-anchor" href="#_9-3-5-手动提交offset" aria-hidden="true">#</a> **9.3.5 手动提交offset</h3><p><strong>自动提交offset和手动提交offset区别参考章节7.1.2</strong></p><h4 id="_9-3-5-1-手动提交偏移量配置" tabindex="-1"><a class="header-anchor" href="#_9-3-5-1-手动提交偏移量配置" aria-hidden="true">#</a> <strong>9.3.5.1 手动提交偏移量配置</strong></h4><p><strong>消费者服务 application.ym修改配置</strong></p><p><strong><img src="`+as+`" alt="image-20230702191014703"></strong></p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8120</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">Kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 192.168.1.170<span class="token punctuation">:</span><span class="token number">9091</span><span class="token punctuation">,</span>192.168.1.170<span class="token punctuation">:</span><span class="token number">9092</span><span class="token punctuation">,</span>192.168.1.170<span class="token punctuation">:</span><span class="token number">9093</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span> <span class="token comment"># consumer消费者配置</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> consumer<span class="token punctuation">-</span>group <span class="token comment"># 默认的消费组ID</span>
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否自动提交offset</span>
      <span class="token key atrule">auto-commit-interval</span><span class="token punctuation">:</span> <span class="token number">120000</span> <span class="token comment"># 自动提交offset时间间隔2分钟。这期间服务异常停止时，再次重启会导致重复消费\\</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> latest  <span class="token comment"># 指定Offset消费:earliest | latest | none</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token comment"># 监听器消费消息运行的线程数，一般为 机器数*分区数</span>
      <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token comment"># 自动提交关闭，需要设置手动消息确认</span>
      <span class="token comment"># MANUAL: 调用Acknowledgment.acknowledge()先将offset存放到map本地缓存，在下一次poll之前从缓存拿出来批量提交</span>
      <span class="token comment"># manual_immediate: 调用Acknowledgment.acknowledge()后立即提交</span>
      <span class="token key atrule">ack-mode</span><span class="token punctuation">:</span> manual_immediate
      <span class="token comment"># 消费监听接口监听的主题不存在时，默认会报错，所以设置为false忽略错误</span>
      <span class="token key atrule">missing-topics-fatal</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token comment"># 两次poll之间的最大间隔，默认值为5分钟。如果超过这个间隔会触发reBalance</span>
      <span class="token key atrule">poll-timeout</span><span class="token punctuation">:</span> <span class="token number">600000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-5-2-消费者服务创建测试主题" tabindex="-1"><a class="header-anchor" href="#_9-3-5-2-消费者服务创建测试主题" aria-hidden="true">#</a> <strong>9.3.5.2 消费者服务创建测试主题</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestAckTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
        <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
        <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-5-3-消费者代码" tabindex="-1"><a class="header-anchor" href="#_9-3-5-3-消费者代码" aria-hidden="true">#</a> <strong>9.3.5.3 消费者代码</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
    topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//3个消费者</span>
    concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByAck</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByAck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重启消费者服务</strong></p><h4 id="_9-3-5-4-生产者发送消息" tabindex="-1"><a class="header-anchor" href="#_9-3-5-4-生产者发送消息" aria-hidden="true">#</a> <strong>9.3.5.4 生产者发送消息</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendAckMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;offset_data&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>发送消息测试</strong></p><p><strong>测试结果</strong></p><p><img src="`+ts+`" alt="image-20230819182844092"></p><h3 id="_9-3-6-消费异常处理" tabindex="-1"><a class="header-anchor" href="#_9-3-6-消费异常处理" aria-hidden="true">#</a> <strong>9.3.6 消费异常处理</strong></h3><p>**背景 **</p><p><strong>当消费者对消息消费时，如果发生了异常当然也需要处理一下异常。一般我们在@KafkaListener中， 只是监听topic中的主题并消费，如果再try catch捕获并处理的话，则会显得代码块非常臃肿不利于维护， kafka为我们提供了专门的异常处理器ConsumerAwareListenerErrorHandler，通过它我们可以处理consumer在消费时发生的异常。</strong></p><h4 id="_9-3-6-1-注册异常处理器" tabindex="-1"><a class="header-anchor" href="#_9-3-6-1-注册异常处理器" aria-hidden="true">#</a> <strong>9.3.6.1 注册异常处理器</strong></h4><p>**消费者新建类：**CustomListenerErrorHandler.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>bf<span class="token punctuation">.</span>listeners</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">Consumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>listener<span class="token punctuation">.</span></span><span class="token class-name">ConsumerAwareListenerErrorHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>listener<span class="token punctuation">.</span></span><span class="token class-name">ListenerExecutionFailedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomListenerErrorHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConsumerAwareListenerErrorHandler</span> <span class="token function">listenerErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerAwareListenerErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">,</span> <span class="token class-name">ListenerExecutionFailedException</span> exception<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;--- 消费时发生异常 ---&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-6-2-消费者服务创建测试主题" tabindex="-1"><a class="header-anchor" href="#_9-3-6-2-消费者服务创建测试主题" aria-hidden="true">#</a> <strong>9.3.6.2 消费者服务创建测试主题</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaInitConfig</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestAckTopicWithExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic_withExp&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
                <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
                <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-6-3-消费者使用异常处理器" tabindex="-1"><a class="header-anchor" href="#_9-3-6-3-消费者使用异常处理器" aria-hidden="true">#</a> <strong>9.3.6.3 消费者使用异常处理器</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
            topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_ack_topic_withExp&quot;</span><span class="token punctuation">,</span>
            concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
            errorHandler <span class="token operator">=</span> <span class="token string">&quot;listenerErrorHandler&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByAckWithExp</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;============&gt; consumeByAckWithExp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
                <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//手动ack</span>
        ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-6-4-发送消息测试" tabindex="-1"><a class="header-anchor" href="#_9-3-6-4-发送消息测试" aria-hidden="true">#</a> 9.3.6.4 发送消息测试</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendAckMsgWithExp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_ack_topic_withExp&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;offset_data&quot;</span><span class="token operator">+</span><span class="token string">&quot;_withExp&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+ps+`" alt="image-20230819201901436"></p><h3 id="_9-3-7-消息重试和死信队列" tabindex="-1"><a class="header-anchor" href="#_9-3-7-消息重试和死信队列" aria-hidden="true">#</a> <strong>9.3.7 消息重试和死信队列</strong></h3><p><strong>需求：手动ack时，如果消息消费失败，尝试重试3次，再次失败，将消息发送到死信队列避免消息丢失。</strong></p><p><strong>注意：需要配合之前的手动提交offset才可以，安排家庭作业练，动手</strong></p><h4 id="_9-3-7-1-消费者创建测试主题" tabindex="-1"><a class="header-anchor" href="#_9-3-7-1-消费者创建测试主题" aria-hidden="true">#</a> <strong>9.3.7.1 消费者创建测试主题</strong></h4><p><strong>KafkaInitConfig配置类添加：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">NewTopic</span> <span class="token function">springTestRetryTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">TopicBuilder</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">)</span> <span class="token comment">//主题名称</span>
        <span class="token punctuation">.</span><span class="token function">partitions</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//分区数量</span>
        <span class="token punctuation">.</span><span class="token function">replicas</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//副本数量</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-7-2-消费者代码" tabindex="-1"><a class="header-anchor" href="#_9-3-7-2-消费者代码" aria-hidden="true">#</a> <strong>9.3.7.2 消费者代码</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//attempts:重试的最大次数</span>
<span class="token comment">//autoCreateTopics:指定是否自动创建重试主题和 DLT（死信主题）</span>
<span class="token comment">//backoff: value 重试的时间间隔</span>
<span class="token annotation punctuation">@RetryableTopic</span><span class="token punctuation">(</span>
    attempts <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
    backoff <span class="token operator">=</span><span class="token annotation punctuation">@Backoff</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">2_000L</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    autoCreateTopics <span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
    topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//3个消费者</span>
    concurrency <span class="token operator">=</span> <span class="token string">&quot;3&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByRetry</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByRetry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重启消费者，启动后可以在Eagle中看到自动创建的重试和死信队列：</strong><strong><img src="`+es+`" alt="image-20230702211127738"></strong></p><h4 id="_9-3-7-3-生产者发送消息" tabindex="-1"><a class="header-anchor" href="#_9-3-7-3-生产者发送消息" aria-hidden="true">#</a> <strong>9.3.7.3 生产者发送消息</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">sendRertyMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;spring_test_retry_topic&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;retry_data&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;_&quot;</span><span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行测试，在消费者控制台可以看到以下日志：消息消费重试失败后，最终到达死信队列</strong></p><div class="language-verilog line-numbers-mode" data-ext="verilog"><pre class="language-verilog"><code>consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-07-02T21:00:59.987993&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1688302860999</span>
consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-07-02T21:00:59.987993&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1688302860999</span>
consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-07-02T21:00:59.987993&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1688302860999</span>
consumeByRetry
主题 <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span>分区 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> 偏移量 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">,</span> 内容 <span class="token operator">=</span> <span class="token string">&quot;retry_data1_2023-07-02T21:00:59.987993&quot;</span><span class="token punctuation">,</span>时间戳 <span class="token operator">=</span> <span class="token number">1688302860999</span>
<span class="token number">2023</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">02</span>T21<span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">08.460</span><span class="token operator">+</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span> ERROR <span class="token number">23164</span> <span class="token operator">---</span> <span class="token punctuation">[</span>ntainer#<span class="token number">2</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>C<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> k<span class="token punctuation">.</span>r<span class="token punctuation">.</span>DeadLetterPublishingRecovererFactory <span class="token punctuation">:</span> Record<span class="token punctuation">:</span> topic <span class="token operator">=</span> spring_test_retry_topic<span class="token punctuation">,</span> partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> main topic <span class="token operator">=</span> spring_test_retry_topic threw an error at topic spring_test_retry_topic <span class="token keyword">and</span> won&#39;t be retried<span class="token punctuation">.</span> Sending to DLT <span class="token keyword">with</span> name spring_test_retry_topic<span class="token operator">-</span>dlt<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-7-4-消费者消费死信队列消息" tabindex="-1"><a class="header-anchor" href="#_9-3-7-4-消费者消费死信队列消息" aria-hidden="true">#</a> <strong>9.3.7.4 消费者消费死信队列消息</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//死信队列默认名称在原队列后拼接&#39;-dlt&#39;</span>
<span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>
    topics <span class="token operator">=</span> <span class="token string">&quot;spring_test_retry_topic-dlt&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//1个消费者</span>
    concurrency <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeByDLT</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumeByDLT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;主题 = %s,分区 = %d, 偏移量 = %d, key = %s, 内容 = %s,时间戳 = %d%n&quot;</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//手动ack</span>
    ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,120);function js(Os,Ns){const a=c("font");return i(),l("div",null,[cs,n("ul",null,[n("li",null,[t(a,{color:"red"},{default:p(()=>[s("**Apache Kafka** ：最“正统”的`Kafka`也是开源版，它是后面其他所有发行版的基础")]),_:1}),s("。")]),is,ls]),us,n("table",null,[rs,n("tbody",null,[ks,ds,n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("(工作后用到什么再回来学具体MQ)")]),_:1})])]),ms])])]),vs,n("table",null,[gs,n("tbody",null,[n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("Producer")]),_:1})])]),bs]),n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("Consumer")]),_:1})])]),fs]),n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("Broker")]),_:1})])]),hs]),n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("Topic")]),_:1})])]),ys]),n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("Partition")]),_:1})])]),_s]),ws,qs,Ss,n("tr",null,[n("td",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("ConsumerGroup(CG)")]),_:1})])]),xs]),Ps])]),Cs,n("p",null,[n("strong",null,[s("Kafka 中 Topic 被分成多个 Partition 分区。Topic 是一个"),t(a,{color:"red"},{default:p(()=>[s("逻辑概念")]),_:1}),s("，Partition 是最小的存储单元，掌握着一个 Topic 的部分数据。")])]),Ks,n("p",null,[n("strong",null,[s("Kafka producer默认是"),t(a,{color:"red"},{default:p(()=>[s("异步发送不阻塞")]),_:1}),s("，如果需要使用同步发送，可以在每次发送之后调用get方法，因为producer.send方法返回一个Future类型的结果，Future的get方法会一直阻塞直到该线程的任务得到返回值，也就是broker返回发送成功。")])]),Is,n("p",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("小总结：Kafka为什么要分区，都有哪些分区策略？")]),_:1})])]),Ts,t(a,{color:"red"},{default:p(()=>[s("**生产者offset：**")]),_:1}),Es,zs,t(a,{color:"red"},{default:p(()=>[s("**消费者offset：**")]),_:1}),Rs,n("p",null,[n("strong",null,[t(a,{color:"red"},{default:p(()=>[s("备注：最后关闭自己的微服务，结果才出来表示触发了close()方法")]),_:1})])]),As])}const Ms=o(os,[["render",js],["__file","0、消息队列-Kafka.html.vue"]]);export{Ms as default};
